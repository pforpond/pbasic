<!DOCTYPE html>
<html lang="en-US">

  
<!-- Mirrored from qb64.com/wiki/Resource-Table-extraction.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 07 Nov 2024 13:50:55 GMT -->
<!-- Added by HTTrack --><meta http-equiv="content-type" content="text/html;charset=utf-8" /><!-- /Added by HTTrack -->
<head>
    <meta charset='utf-8'>
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width,maximum-scale=2">
    <link rel="shortcut icon" type="image/x-icon" href="favicon.html">
    <link rel="stylesheet" type="text/css" media="screen" href="../assets/css/style2443.css?v=eb9b8c9cad488bd1304035e1bfc5d2e89b0f78df">

<!-- Begin Jekyll SEO tag v2.8.0 -->
<title>QB64.com | QB64 is a modern extended BASIC programming language that retains QBasic/QuickBASIC 4.5 compatibility and compiles native binaries for Windows, Linux, and macOS.</title>
<meta name="generator" content="Jekyll v3.9.3" />
<meta property="og:title" content="QB64.com" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="QB64 is a modern extended BASIC programming language that retains QBasic/QuickBASIC 4.5 compatibility and compiles native binaries for Windows, Linux, and macOS." />
<meta property="og:description" content="QB64 is a modern extended BASIC programming language that retains QBasic/QuickBASIC 4.5 compatibility and compiles native binaries for Windows, Linux, and macOS." />
<link rel="canonical" href="Resource-Table-extraction-3.html" />
<meta property="og:url" content="Resource-Table-extraction-3.html" />
<meta property="og:site_name" content="QB64.com" />
<meta property="og:type" content="website" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="QB64.com" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"WebPage","description":"QB64 is a modern extended BASIC programming language that retains QBasic/QuickBASIC 4.5 compatibility and compiles native binaries for Windows, Linux, and macOS.","headline":"QB64.com","url":"https://qb64.com/wiki/Resource-Table-extraction.html"}</script>
<!-- End Jekyll SEO tag -->

    <!-- start custom head snippets, customize with your own _includes/head-custom.html file -->

<!-- Setup Google Analytics -->



<!-- You can set your favicon here -->
<!-- link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" -->

<!-- end custom head snippets -->

  </head>

  <body>

    <!-- HEADER -->
    <div id="header_wrap" class="outer">
        <header class="inner">
          
            <!--<a id="forkme_banner" href="https://github.com/DualBrain/QB64">View on GitHub</a>-->
          

          <h1 id="project_title">QB64.com</h1>
          <h2 id="project_tagline">QB64 is a modern extended BASIC programming language that retains QBasic/QuickBASIC 4.5 compatibility and compiles native binaries for Windows, Linux, and macOS.</h2>

          
        </header>
    </div>

    <!-- MAIN CONTENT -->
    <div id="main_content_wrap" class="outer">
      <section id="main_content" class="inner">
        <p>The following information was supplied by Michael Calkins in a memberâ€™s request to find a way to extract icons from EXE files. There is no warranty implied and users should use the information and code at their own risk! We are not responsible for any damages!</p>

<h2 id="coff-specifications">COFF Specifications</h2>

<p>There are 3 layers to the resource tables, Type, Name, and Language, The Microsoft PE and COFF specifications can be found here:</p>

<p><a href="http://msdn.microsoft.com/en-us/windows/hardware/gg463119">http://msdn.microsoft.com/en-us/windows/hardware/gg463119</a></p>

<p><strong>Image Extraction Procedure</strong></p>

<div class="language-vb highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="n">DIM</span> <span class="n">nam</span> <span class="n">AS</span> <span class="n">STRING</span> <span class="o">*</span> <span class="mi">8</span>
<span class="n">DIM</span> <span class="n">fil</span> <span class="n">AS</span> <span class="n">STRING</span>
<span class="n">DIM</span> <span class="n">k</span> <span class="n">AS</span> <span class="n">STRING</span>
<span class="n">DIM</span> <span class="n">dw</span> <span class="n">AS</span> <span class="n">_UNSIGNED</span> <span class="n">LONG</span>
<span class="n">DIM</span> <span class="n">ul</span> <span class="n">AS</span> <span class="n">_UNSIGNED</span> <span class="n">LONG</span>
<span class="n">DIM</span> <span class="n">coff</span> <span class="n">AS</span> <span class="n">_UNSIGNED</span> <span class="n">LONG</span>
<span class="n">DIM</span> <span class="n">SectionTable</span> <span class="n">AS</span> <span class="n">_UNSIGNED</span> <span class="n">LONG</span>
<span class="n">DIM</span> <span class="n">ImageBase</span> <span class="n">AS</span> <span class="n">_UNSIGNED</span> <span class="n">LONG</span>
<span class="n">DIM</span> <span class="n">rsrc</span> <span class="n">AS</span> <span class="n">_UNSIGNED</span> <span class="n">LONG</span>
<span class="n">DIM</span> <span class="n">pe32plus</span> <span class="n">AS</span> <span class="n">LONG</span>
<span class="n">DIM</span> <span class="n">w</span> <span class="n">AS</span> <span class="n">_UNSIGNED</span> <span class="n">INTEGER</span>
<span class="n">DIM</span> <span class="n">SizeOfOptionalHeader</span> <span class="n">AS</span> <span class="n">_UNSIGNED</span> <span class="n">INTEGER</span>
<span class="n">DIM</span> <span class="n">SHARED</span> <span class="n">NumberOfSections</span> <span class="n">AS</span> <span class="n">_UNSIGNED</span> <span class="n">INTEGER</span>
<span class="n">DIM</span> <span class="n">NumberOfRvaAndSizes</span> <span class="n">AS</span> <span class="n">_UNSIGNED</span> <span class="n">LONG</span>

<span class="n">CLS</span>
<span class="n">LINE</span> <span class="n">INPUT</span> <span class="s">"Name of the PE image to open? "</span><span class="err">;</span> <span class="n">fil</span>
<span class="n">IF</span> <span class="n">_FILEEXISTS</span><span class="p">(</span><span class="n">fil</span><span class="p">)</span> <span class="o">=</span> <span class="mi">0</span> <span class="n">THEN</span> <span class="n">PRINT</span> <span class="s">"File not found."</span><span class="p">:</span> <span class="n">END</span>
<span class="n">OPEN</span> <span class="n">fil</span> <span class="n">FOR</span> <span class="n">BINARY</span> <span class="n">ACCESS</span> <span class="n">READ</span> <span class="n">AS</span> <span class="mi">1</span>
<span class="n">GET</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="o">+</span> <span class="mi">0</span><span class="p">,</span> <span class="n">w</span>
<span class="n">IF</span> <span class="n">w</span> <span class="o">&lt;&gt;</span> <span class="o">&amp;</span><span class="n">H5A4D</span> <span class="n">THEN</span> <span class="n">PRINT</span> <span class="s">"No MZ signature."</span><span class="p">:</span> <span class="n">END</span>
<span class="n">GET</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="o">+</span> <span class="o">&amp;</span><span class="n">H3C</span><span class="p">,</span> <span class="n">dw</span>
<span class="n">coff</span> <span class="o">=</span> <span class="n">dw</span> <span class="o">+</span> <span class="mi">4</span>
<span class="n">GET</span> <span class="mi">1</span><span class="p">,</span> <span class="n">dw</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">dw</span>
<span class="n">IF</span> <span class="n">dw</span> <span class="o">&lt;&gt;</span> <span class="o">&amp;</span><span class="n">H4550</span><span class="o">&amp;</span> <span class="n">THEN</span> <span class="n">PRINT</span> <span class="s">"No PE signature."</span><span class="p">:</span> <span class="n">END</span>
<span class="n">GET</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">coff</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="n">NumberOfSections</span>
<span class="n">IF</span> <span class="n">NumberOfSections</span> <span class="o">=</span> <span class="mi">0</span> <span class="n">THEN</span> <span class="n">PRINT</span> <span class="s">"No sections."</span><span class="p">:</span> <span class="n">END</span>
<span class="n">PRINT</span> <span class="s">"NumberOfSections:"</span><span class="err">;</span> <span class="n">NumberOfSections</span>
<span class="n">DIM</span> <span class="n">SHARED</span> <span class="n">secsva</span><span class="p">(</span><span class="mi">0</span> <span class="n">TO</span> <span class="n">NumberOfSections</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="n">AS</span> <span class="n">_UNSIGNED</span> <span class="n">LONG</span>
<span class="n">DIM</span> <span class="n">SHARED</span> <span class="n">secsfp</span><span class="p">(</span><span class="mi">0</span> <span class="n">TO</span> <span class="n">NumberOfSections</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="n">AS</span> <span class="n">_UNSIGNED</span> <span class="n">LONG</span>
<span class="n">GET</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">coff</span> <span class="o">+</span> <span class="mi">16</span><span class="p">,</span> <span class="n">SizeOfOptionalHeader</span>
<span class="n">IF</span> <span class="n">SizeOfOptionalHeader</span> <span class="o">=</span> <span class="mi">0</span> <span class="n">THEN</span> <span class="n">PRINT</span> <span class="s">"No optional header."</span><span class="p">:</span> <span class="n">END</span>
<span class="n">PRINT</span> <span class="s">"SizeOfOptionalHeader:"</span><span class="p">,</span> <span class="n">SPACE</span><span class="err">$</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span><span class="err">;</span> <span class="n">word$</span><span class="p">(</span><span class="n">SizeOfOptionalHeader</span><span class="p">)</span>
<span class="n">GET</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">coff</span> <span class="o">+</span> <span class="mi">20</span><span class="p">,</span> <span class="n">w</span>
<span class="n">SELECT</span> <span class="n">CASE</span> <span class="n">w</span>
 <span class="n">CASE</span> <span class="o">&amp;</span><span class="n">H10B</span><span class="p">:</span> <span class="n">pe32plus</span> <span class="o">=</span> <span class="mi">0</span><span class="p">:</span> <span class="n">PRINT</span> <span class="s">"PE32"</span>
 <span class="n">CASE</span> <span class="o">&amp;</span><span class="n">H20B</span><span class="p">:</span> <span class="n">pe32plus</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span> <span class="n">PRINT</span> <span class="s">"PE32+"</span>
 <span class="n">CASE</span> <span class="n">ELSE</span><span class="p">:</span> <span class="n">PRINT</span> <span class="s">"Unknown Magic."</span><span class="p">:</span> <span class="n">END</span>
<span class="n">END</span> <span class="n">SELECT</span>
<span class="n">GET</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">coff</span> <span class="o">+</span> <span class="mi">20</span> <span class="o">+</span> <span class="mi">28</span> <span class="o">+</span> <span class="p">(</span><span class="o">-</span><span class="mi">4</span> <span class="n">AND</span> <span class="n">pe32plus</span><span class="p">),</span> <span class="n">ImageBase</span>
<span class="n">PRINT</span> <span class="s">"ImageBase:"</span><span class="p">,</span> <span class="s">""</span><span class="p">,</span> <span class="n">dword$</span><span class="p">(</span><span class="n">ImageBase</span><span class="p">)</span>
<span class="n">GET</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">coff</span> <span class="o">+</span> <span class="mi">20</span> <span class="o">+</span> <span class="mi">92</span> <span class="o">+</span> <span class="p">(</span><span class="mi">16</span> <span class="n">AND</span> <span class="n">pe32plus</span><span class="p">),</span> <span class="n">NumberOfRvaAndSizes</span>
<span class="n">IF</span> <span class="n">NumberOfRvaAndSizes</span> <span class="o">&lt;</span> <span class="mi">3</span> <span class="n">THEN</span> <span class="n">PRINT</span> <span class="s">"No resource table."</span><span class="p">:</span> <span class="n">END</span>
<span class="n">PRINT</span> <span class="s">"NumberOfRvaAndSizes:"</span><span class="err">;</span> <span class="n">NumberOfRvaAndSizes</span>
<span class="n">GET</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">coff</span> <span class="o">+</span> <span class="mi">20</span> <span class="o">+</span> <span class="mi">112</span> <span class="o">+</span> <span class="p">(</span><span class="mi">16</span> <span class="n">AND</span> <span class="n">pe32plus</span><span class="p">),</span> <span class="n">rsrc</span>
<span class="n">PRINT</span> <span class="s">"Rva of resource table:"</span><span class="p">,</span> <span class="n">dword$</span><span class="p">(</span><span class="n">rsrc</span><span class="p">)</span>
<span class="n">GET</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">coff</span> <span class="o">+</span> <span class="mi">20</span> <span class="o">+</span> <span class="mi">4</span> <span class="o">+</span> <span class="mi">112</span> <span class="o">+</span> <span class="p">(</span><span class="mi">16</span> <span class="n">AND</span> <span class="n">pe32plus</span><span class="p">),</span> <span class="n">dw</span>
<span class="n">PRINT</span> <span class="s">"Size of resource table:"</span><span class="p">,</span> <span class="n">dword$</span><span class="p">(</span><span class="n">dw</span><span class="p">)</span>
<span class="n">IF</span> <span class="p">(</span><span class="n">rsrc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span> <span class="n">OR</span> <span class="p">(</span><span class="n">dw</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span> <span class="n">THEN</span> <span class="n">PRINT</span> <span class="s">"No resource table."</span><span class="p">:</span> <span class="n">END</span>
<span class="n">SectionTable</span> <span class="o">=</span> <span class="n">coff</span> <span class="o">+</span> <span class="mi">20</span> <span class="o">+</span> <span class="n">SizeOfOptionalHeader</span>
<span class="n">PRINT</span> <span class="s">"section"</span><span class="p">,</span> <span class="s">"va"</span><span class="p">,</span> <span class="s">"file ptr"</span>
<span class="n">FOR</span> <span class="n">w</span> <span class="o">=</span> <span class="mi">0</span> <span class="n">TO</span> <span class="n">NumberOfSections</span> <span class="o">-</span> <span class="mi">1</span>
 <span class="n">GET</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">SectionTable</span> <span class="o">+</span> <span class="p">(</span><span class="mi">40</span> <span class="o">*</span> <span class="n">w</span><span class="p">),</span> <span class="n">nam</span>
 <span class="n">GET</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">SectionTable</span> <span class="o">+</span> <span class="mi">12</span> <span class="o">+</span> <span class="p">(</span><span class="mi">40</span> <span class="o">*</span> <span class="n">w</span><span class="p">),</span> <span class="n">ul</span>
 <span class="n">GET</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">SectionTable</span> <span class="o">+</span> <span class="mi">20</span> <span class="o">+</span> <span class="p">(</span><span class="mi">40</span> <span class="o">*</span> <span class="n">w</span><span class="p">),</span> <span class="n">dw</span>
 <span class="n">PRINT</span> <span class="n">nam</span><span class="p">,</span> <span class="n">dword$</span><span class="p">(</span><span class="n">ul</span><span class="p">),</span> <span class="n">dword$</span><span class="p">(</span><span class="n">dw</span><span class="p">)</span>
 <span class="n">secsva</span><span class="p">(</span><span class="n">w</span><span class="p">)</span> <span class="o">=</span> <span class="n">ul</span>
 <span class="n">secsfp</span><span class="p">(</span><span class="n">w</span><span class="p">)</span> <span class="o">=</span> <span class="n">dw</span>
<span class="n">NEXT</span>
<span class="n">PRINT</span>
<span class="n">PRINT</span> <span class="s">"Proceed? "</span><span class="err">;</span>
<span class="n">DO</span>
 <span class="n">k</span> <span class="o">=</span> <span class="n">LCASE</span><span class="err">$</span><span class="p">(</span><span class="n">INKEY</span><span class="err">$</span><span class="p">)</span>
 <span class="n">IF</span> <span class="n">k</span> <span class="o">=</span> <span class="s">"n"</span> <span class="n">THEN</span> <span class="n">PRINT</span> <span class="n">k</span><span class="p">:</span> <span class="n">END</span>
<span class="n">LOOP</span> <span class="n">UNTIL</span> <span class="n">k</span> <span class="o">=</span> <span class="s">"y"</span>
<span class="n">PRINT</span> <span class="n">k</span>
<span class="n">processtable</span> <span class="n">rva2fp</span><span class="p">(</span><span class="n">rsrc</span><span class="p">),</span> <span class="n">rva2fp</span><span class="p">(</span><span class="n">rsrc</span><span class="p">),</span> <span class="mi">0</span>
<span class="n">SYSTEM</span>

<span class="n">SUB</span> <span class="n">processtable</span> <span class="p">(</span><span class="n">bs</span> <span class="n">AS</span> <span class="n">_UNSIGNED</span> <span class="n">LONG</span><span class="p">,</span> <span class="n">addr</span> <span class="n">AS</span> <span class="n">_UNSIGNED</span> <span class="n">LONG</span><span class="p">,</span> <span class="n">level</span> <span class="n">AS</span> <span class="n">INTEGER</span><span class="p">)</span>
<span class="n">DIM</span> <span class="n">k</span> <span class="n">AS</span> <span class="n">STRING</span>
<span class="n">DIM</span> <span class="n">dw</span> <span class="n">AS</span> <span class="n">_UNSIGNED</span> <span class="n">LONG</span>
<span class="n">DIM</span> <span class="n">numnamest8</span> <span class="n">AS</span> <span class="n">_UNSIGNED</span> <span class="n">LONG</span>
<span class="n">DIM</span> <span class="n">dat</span> <span class="n">AS</span> <span class="n">_UNSIGNED</span> <span class="n">LONG</span>
<span class="n">DIM</span> <span class="n">siz</span> <span class="n">AS</span> <span class="n">_UNSIGNED</span> <span class="n">LONG</span>
<span class="n">DIM</span> <span class="n">so</span> <span class="n">AS</span> <span class="n">LONG</span>
<span class="n">DIM</span> <span class="n">sc</span> <span class="n">AS</span> <span class="n">LONG</span>
<span class="n">DIM</span> <span class="n">numnames</span> <span class="n">AS</span> <span class="n">_UNSIGNED</span> <span class="n">INTEGER</span>
<span class="n">DIM</span> <span class="n">numids</span> <span class="n">AS</span> <span class="n">_UNSIGNED</span> <span class="n">INTEGER</span>
<span class="n">DIM</span> <span class="n">w</span> <span class="n">AS</span> <span class="n">_UNSIGNED</span> <span class="n">INTEGER</span>
<span class="n">DIM</span> <span class="n">ln</span> <span class="n">AS</span> <span class="n">_UNSIGNED</span> <span class="n">INTEGER</span>
<span class="n">DIM</span> <span class="n">x</span> <span class="n">AS</span> <span class="n">_UNSIGNED</span> <span class="n">INTEGER</span>
<span class="n">DIM</span> <span class="n">y</span> <span class="n">AS</span> <span class="n">_UNSIGNED</span> <span class="n">INTEGER</span>
<span class="n">DIM</span> <span class="n">b</span> <span class="n">AS</span> <span class="n">_UNSIGNED</span> <span class="n">_BYTE</span>

<span class="n">GET</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">addr</span> <span class="o">+</span> <span class="mi">12</span><span class="p">,</span> <span class="n">numnames</span>
<span class="n">GET</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">addr</span> <span class="o">+</span> <span class="mi">14</span><span class="p">,</span> <span class="n">numids</span>
<span class="n">DIM</span> <span class="n">nams</span><span class="p">(</span><span class="mi">0</span> <span class="n">TO</span> <span class="n">numnames</span> <span class="o">+</span> <span class="p">(</span><span class="n">numnames</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">))</span> <span class="n">AS</span> <span class="n">STRING</span>
<span class="n">DIM</span> <span class="n">namsrva</span><span class="p">(</span><span class="mi">0</span> <span class="n">TO</span> <span class="n">numnames</span> <span class="o">+</span> <span class="p">(</span><span class="n">numnames</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">))</span> <span class="n">AS</span> <span class="n">_UNSIGNED</span> <span class="n">LONG</span>
<span class="n">DIM</span> <span class="n">ids</span><span class="p">(</span><span class="mi">0</span> <span class="n">TO</span> <span class="n">numids</span> <span class="o">+</span> <span class="p">(</span><span class="n">numids</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">))</span> <span class="n">AS</span> <span class="n">_UNSIGNED</span> <span class="n">LONG</span>
<span class="n">DIM</span> <span class="n">idsrva</span><span class="p">(</span><span class="mi">0</span> <span class="n">TO</span> <span class="n">numids</span> <span class="o">+</span> <span class="p">(</span><span class="n">numids</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">))</span> <span class="n">AS</span> <span class="n">_UNSIGNED</span> <span class="n">LONG</span>

<span class="c1">'get named entries</span>
<span class="n">FOR</span> <span class="n">x</span> <span class="o">=</span> <span class="mi">0</span> <span class="n">TO</span> <span class="n">numnames</span> <span class="o">-</span> <span class="mi">1</span>
 <span class="n">GET</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">addr</span> <span class="o">+</span> <span class="mi">16</span> <span class="o">+</span> <span class="p">(</span><span class="n">x</span> <span class="o">*</span> <span class="mi">8</span><span class="p">),</span> <span class="n">dw</span>
 <span class="n">dw</span> <span class="o">=</span> <span class="n">rva2fp</span><span class="p">(</span><span class="n">dw</span><span class="p">)</span>
 <span class="n">GET</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">dw</span><span class="p">,</span> <span class="n">ln</span>
 <span class="n">FOR</span> <span class="n">y</span> <span class="o">=</span> <span class="mi">0</span> <span class="n">TO</span> <span class="n">ln</span> <span class="o">-</span> <span class="mi">1</span>
  <span class="n">GET</span> <span class="mi">1</span><span class="p">,</span> <span class="p">,</span> <span class="n">w</span>
  <span class="n">SELECT</span> <span class="n">CASE</span> <span class="n">w</span>
   <span class="n">CASE</span> <span class="o">&amp;</span><span class="n">H20</span> <span class="n">TO</span> <span class="o">&amp;</span><span class="n">H7E</span><span class="p">:</span> <span class="n">nams</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">=</span> <span class="n">nams</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">+</span> <span class="n">CHR</span><span class="err">$</span><span class="p">(</span><span class="n">w</span><span class="p">)</span>
   <span class="n">CASE</span> <span class="n">ELSE</span><span class="p">:</span> <span class="n">nams</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">=</span> <span class="n">nams</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">+</span> <span class="n">CHR</span><span class="err">$</span><span class="p">(</span><span class="o">&amp;</span><span class="n">H1A</span><span class="p">)</span>
  <span class="n">END</span> <span class="n">SELECT</span>
  <span class="n">IF</span> <span class="n">y</span> <span class="o">=</span> <span class="mi">68</span> <span class="n">THEN</span> <span class="n">EXIT</span> <span class="n">FOR</span>
 <span class="n">NEXT</span>
 <span class="n">GET</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">addr</span> <span class="o">+</span> <span class="mi">16</span> <span class="o">+</span> <span class="mi">4</span> <span class="o">+</span> <span class="p">(</span><span class="n">x</span> <span class="o">*</span> <span class="mi">8</span><span class="p">),</span> <span class="n">namsrva</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="n">NEXT</span>

<span class="c1">'get numbered entries:</span>
<span class="n">numnamest8</span> <span class="o">=</span> <span class="n">numnames</span> <span class="o">*</span> <span class="mi">8</span>
<span class="n">FOR</span> <span class="n">x</span> <span class="o">=</span> <span class="mi">0</span> <span class="n">TO</span> <span class="n">numids</span> <span class="o">-</span> <span class="mi">1</span>
 <span class="n">GET</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">addr</span> <span class="o">+</span> <span class="mi">16</span> <span class="o">+</span> <span class="n">numnamest8</span> <span class="o">+</span> <span class="p">(</span><span class="n">x</span> <span class="o">*</span> <span class="mi">8</span><span class="p">),</span> <span class="n">ids</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
 <span class="n">GET</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">addr</span> <span class="o">+</span> <span class="mi">16</span> <span class="o">+</span> <span class="mi">4</span> <span class="o">+</span> <span class="n">numnamest8</span> <span class="o">+</span> <span class="p">(</span><span class="n">x</span> <span class="o">*</span> <span class="mi">8</span><span class="p">),</span> <span class="n">idsrva</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="n">NEXT</span>

<span class="c1">'display:</span>
<span class="n">VIEW</span> <span class="n">PRINT</span>
<span class="n">DO</span>
 <span class="n">CLS</span> <span class="mi">0</span> <span class="c1">'qb64 bug? not locating to 1,1?</span>
 <span class="n">LOCATE</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span>
 <span class="n">SELECT</span> <span class="n">CASE</span> <span class="n">level</span>
  <span class="n">CASE</span> <span class="mi">0</span><span class="p">:</span> <span class="n">PRINT</span> <span class="s">"1st level - Type"</span><span class="err">;</span>
  <span class="n">CASE</span> <span class="mi">1</span><span class="p">:</span> <span class="n">PRINT</span> <span class="s">"2nd level - Name"</span><span class="err">;</span>
  <span class="n">CASE</span> <span class="mi">2</span><span class="p">:</span> <span class="n">PRINT</span> <span class="s">"3rd level - Language"</span><span class="err">;</span>
  <span class="n">CASE</span> <span class="n">ELSE</span><span class="p">:</span> <span class="n">PRINT</span> <span class="n">LTRIM</span><span class="err">$</span><span class="p">(</span><span class="n">STR</span><span class="err">$</span><span class="p">(</span><span class="n">level</span><span class="p">))</span> <span class="o">+</span> <span class="s">"th level"</span><span class="err">;</span>
 <span class="n">END</span> <span class="n">SELECT</span>
 <span class="n">PRINT</span> <span class="s">""</span><span class="p">,</span> <span class="s">"file ptr: "</span><span class="err">;</span> <span class="n">dword$</span><span class="p">(</span><span class="n">addr</span><span class="p">)</span><span class="err">;</span> <span class="s">". Press 'D' to dump."</span>
 <span class="n">PRINT</span> <span class="n">numnames</span><span class="err">;</span> <span class="s">"names in this level, in this branch."</span>
 <span class="n">PRINT</span> <span class="n">numids</span><span class="err">;</span> <span class="s">"IDs in this level, in this branch."</span>
 <span class="n">IF</span> <span class="p">(</span><span class="n">numnames</span> <span class="n">OR</span> <span class="n">numids</span><span class="p">)</span> <span class="o">=</span> <span class="mi">0</span> <span class="n">THEN</span>
  <span class="n">IF</span> <span class="n">level</span> <span class="n">THEN</span>
   <span class="n">PRINT</span> <span class="s">"Press any key to go up one level."</span>
   <span class="n">SLEEP</span><span class="p">:</span> <span class="n">DO</span><span class="p">:</span> <span class="n">LOOP</span> <span class="n">WHILE</span> <span class="n">LEN</span><span class="p">(</span><span class="n">INKEY</span><span class="err">$</span><span class="p">)</span>
   <span class="n">EXIT</span> <span class="n">SUB</span>
  <span class="n">ELSE</span>
   <span class="n">END</span>
  <span class="n">END</span> <span class="n">IF</span>
 <span class="n">END</span> <span class="n">IF</span>
 <span class="n">PRINT</span> <span class="s">"names are unicode. For simplicity, non ASCII chars will be shown as "</span> <span class="o">+</span> <span class="n">CHR</span><span class="err">$</span><span class="p">(</span><span class="o">&amp;</span><span class="n">H1A</span><span class="p">)</span> <span class="o">+</span> <span class="s">"."</span>
 <span class="n">IF</span> <span class="n">level</span> <span class="n">THEN</span>
  <span class="n">PRINT</span> <span class="s">"BKSP or ESC to go up one level."</span>
 <span class="n">ELSE</span>
  <span class="n">PRINT</span> <span class="s">"BKSP or ESC to exit."</span>
 <span class="n">END</span> <span class="n">IF</span>
 <span class="n">PRINT</span> <span class="s">"UP, DOWN, PGUP, PGDN, HOME, END to navigate list."</span>
 <span class="n">PRINT</span> <span class="s">"ENTER to select."</span>
 <span class="n">PRINT</span> <span class="n">STRING</span><span class="err">$</span><span class="p">(</span><span class="mi">80</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">HC4</span><span class="p">)</span><span class="err">;</span>
 <span class="n">LOCATE</span> <span class="mi">22</span><span class="p">,</span> <span class="mi">1</span>
 <span class="n">PRINT</span> <span class="n">STRING</span><span class="err">$</span><span class="p">(</span><span class="mi">80</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">HC4</span><span class="p">)</span><span class="err">;</span>
 <span class="n">sc</span> <span class="o">=</span> <span class="mi">0</span>
 <span class="n">so</span> <span class="o">=</span> <span class="mi">0</span>
 <span class="n">DO</span>
  <span class="n">COLOR</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">0</span>
  <span class="n">LOCATE</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span> <span class="n">PRINT</span> <span class="n">dword$</span><span class="p">(</span><span class="n">sc</span><span class="p">)</span>
  <span class="n">FOR</span> <span class="n">x</span> <span class="o">=</span> <span class="mi">0</span> <span class="n">TO</span> <span class="mi">11</span>
   <span class="n">LOCATE</span> <span class="mi">10</span> <span class="o">+</span> <span class="n">x</span><span class="p">,</span> <span class="mi">1</span>
   <span class="n">IF</span> <span class="n">x</span> <span class="o">+</span> <span class="n">so</span> <span class="o">=</span> <span class="n">sc</span> <span class="n">THEN</span> <span class="n">COLOR</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">1</span> <span class="n">ELSE</span> <span class="n">COLOR</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">0</span>
   <span class="n">IF</span> <span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="n">so</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">numnames</span> <span class="n">THEN</span>
    <span class="n">PRINT</span> <span class="n">nams</span><span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="n">so</span><span class="p">)</span><span class="err">;</span> <span class="n">SPACE</span><span class="err">$</span><span class="p">(</span><span class="mi">70</span> <span class="o">-</span> <span class="n">LEN</span><span class="p">(</span><span class="n">nams</span><span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="n">so</span><span class="p">)))</span><span class="err">;</span>
    <span class="n">PRINT</span> <span class="n">dword$</span><span class="p">(</span><span class="n">bs</span> <span class="o">+</span> <span class="p">(</span><span class="n">namsrva</span><span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="n">so</span><span class="p">)</span> <span class="n">AND</span> <span class="o">&amp;</span><span class="n">H7FFFFFFF</span><span class="o">&amp;</span><span class="p">))</span><span class="err">;</span>
    <span class="n">COLOR</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">0</span>
    <span class="n">LOCATE</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">18</span>
    <span class="n">IF</span> <span class="n">namsrva</span><span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="n">so</span><span class="p">)</span> <span class="n">AND</span> <span class="o">&amp;</span><span class="n">H80000000</span><span class="err">~</span><span class="o">&amp;</span> <span class="n">THEN</span>
     <span class="n">PRINT</span> <span class="s">"(descend)"</span><span class="err">;</span>
    <span class="n">ELSE</span>
     <span class="n">PRINT</span> <span class="s">"(extract)"</span><span class="err">;</span>
    <span class="n">END</span> <span class="n">IF</span>
   <span class="n">ELSEIF</span> <span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="n">so</span><span class="p">)</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">numnames</span> <span class="o">+</span> <span class="n">numids</span><span class="p">)</span> <span class="n">THEN</span>
    <span class="n">PRINT</span> <span class="s">"ID: "</span> <span class="o">+</span> <span class="n">dword$</span><span class="p">(</span><span class="n">ids</span><span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="n">so</span> <span class="o">-</span> <span class="n">numnames</span><span class="p">))</span><span class="err">;</span> <span class="n">SPACE</span><span class="err">$</span><span class="p">(</span><span class="mi">56</span><span class="p">)</span><span class="err">;</span>
    <span class="n">PRINT</span> <span class="n">dword$</span><span class="p">(</span><span class="n">bs</span> <span class="o">+</span> <span class="p">(</span><span class="n">idsrva</span><span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="n">so</span> <span class="o">-</span> <span class="n">numnames</span><span class="p">)))</span><span class="err">;</span>
    <span class="n">COLOR</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">0</span>
    <span class="n">LOCATE</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">18</span>
    <span class="n">IF</span> <span class="n">idsrva</span><span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="p">(</span><span class="n">so</span> <span class="o">-</span> <span class="n">numnames</span><span class="p">))</span> <span class="n">AND</span> <span class="o">&amp;</span><span class="n">H80000000</span><span class="err">~</span><span class="o">&amp;</span> <span class="n">THEN</span>
     <span class="n">PRINT</span> <span class="s">"(descend)"</span><span class="err">;</span>
    <span class="n">ELSE</span>
     <span class="n">PRINT</span> <span class="s">"(extract)"</span><span class="err">;</span>
    <span class="n">END</span> <span class="n">IF</span>
   <span class="n">ELSE</span>
    <span class="n">PRINT</span> <span class="n">SPACE</span><span class="err">$</span><span class="p">(</span><span class="mi">80</span><span class="p">)</span><span class="err">;</span>
   <span class="n">END</span> <span class="n">IF</span>
  <span class="n">NEXT</span>
  <span class="n">DO</span>
   <span class="n">k</span> <span class="o">=</span> <span class="n">INKEY</span><span class="err">$</span>
  <span class="n">LOOP</span> <span class="n">UNTIL</span> <span class="n">LEN</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
  <span class="n">SELECT</span> <span class="n">CASE</span> <span class="n">k</span>
   <span class="n">CASE</span> <span class="s">"d"</span><span class="p">,</span> <span class="s">"D"</span>
    <span class="n">dump</span> <span class="n">addr</span>
    <span class="n">EXIT</span> <span class="n">DO</span>
   <span class="n">CASE</span> <span class="n">MKI</span><span class="err">$</span><span class="p">(</span><span class="o">&amp;</span><span class="n">H4800</span><span class="p">)</span> <span class="c1">'up</span>
    <span class="n">IF</span> <span class="n">sc</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="n">THEN</span>
     <span class="n">sc</span> <span class="o">=</span> <span class="n">sc</span> <span class="o">-</span> <span class="mi">1</span>
     <span class="n">IF</span> <span class="n">sc</span> <span class="o">&lt;</span> <span class="n">so</span> <span class="n">THEN</span> <span class="n">so</span> <span class="o">=</span> <span class="n">sc</span>
    <span class="n">END</span> <span class="n">IF</span>
   <span class="n">CASE</span> <span class="n">MKI</span><span class="err">$</span><span class="p">(</span><span class="o">&amp;</span><span class="n">H5000</span><span class="p">)</span> <span class="c1">'down</span>
    <span class="n">IF</span> <span class="n">sc</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">numnames</span> <span class="o">+</span> <span class="n">numids</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="n">THEN</span>
     <span class="n">sc</span> <span class="o">=</span> <span class="n">sc</span> <span class="o">+</span> <span class="mi">1</span>
     <span class="n">IF</span> <span class="n">sc</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">so</span> <span class="o">+</span> <span class="mi">11</span><span class="p">)</span> <span class="n">THEN</span>
      <span class="n">so</span> <span class="o">=</span> <span class="n">sc</span> <span class="o">-</span> <span class="mi">11</span>
      <span class="n">IF</span> <span class="n">so</span> <span class="o">&gt;</span> <span class="n">sc</span> <span class="n">THEN</span> <span class="n">so</span> <span class="o">=</span> <span class="mi">0</span> <span class="c1">'unsigned</span>
     <span class="n">END</span> <span class="n">IF</span>
    <span class="n">END</span> <span class="n">IF</span>
   <span class="n">CASE</span> <span class="n">MKI</span><span class="err">$</span><span class="p">(</span><span class="o">&amp;</span><span class="n">H4700</span><span class="p">)</span> <span class="c1">'home</span>
    <span class="n">sc</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">so</span> <span class="o">=</span> <span class="mi">0</span>
   <span class="n">CASE</span> <span class="n">MKI</span><span class="err">$</span><span class="p">(</span><span class="o">&amp;</span><span class="n">H4F00</span><span class="p">)</span> <span class="c1">'end</span>
    <span class="n">sc</span> <span class="o">=</span> <span class="n">numnames</span> <span class="o">+</span> <span class="n">numids</span> <span class="o">-</span> <span class="mi">1</span>
    <span class="n">so</span> <span class="o">=</span> <span class="n">sc</span> <span class="o">-</span> <span class="mi">11</span>
    <span class="n">IF</span> <span class="n">so</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="n">THEN</span> <span class="n">so</span> <span class="o">=</span> <span class="mi">0</span>
   <span class="n">CASE</span> <span class="n">MKI</span><span class="err">$</span><span class="p">(</span><span class="o">&amp;</span><span class="n">H4900</span><span class="p">)</span> <span class="c1">'pgup</span>
    <span class="n">sc</span> <span class="o">=</span> <span class="n">sc</span> <span class="o">-</span> <span class="mi">12</span>
    <span class="n">so</span> <span class="o">=</span> <span class="n">so</span> <span class="o">-</span> <span class="mi">12</span>
    <span class="n">IF</span> <span class="n">sc</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="n">THEN</span> <span class="n">sc</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">IF</span> <span class="n">so</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="n">THEN</span> <span class="n">so</span> <span class="o">=</span> <span class="mi">0</span>
   <span class="n">CASE</span> <span class="n">MKI</span><span class="err">$</span><span class="p">(</span><span class="o">&amp;</span><span class="n">H5100</span><span class="p">)</span> <span class="c1">'pgdn</span>
    <span class="n">sc</span> <span class="o">=</span> <span class="n">sc</span> <span class="o">+</span> <span class="mi">12</span>
    <span class="n">IF</span> <span class="n">sc</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">numnames</span> <span class="o">+</span> <span class="n">numids</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="n">THEN</span> <span class="n">sc</span> <span class="o">=</span> <span class="n">numnames</span> <span class="o">+</span> <span class="n">numids</span> <span class="o">-</span> <span class="mi">1</span>
    <span class="n">so</span> <span class="o">=</span> <span class="n">sc</span> <span class="o">-</span> <span class="mi">11</span>
    <span class="n">IF</span> <span class="n">so</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="n">THEN</span> <span class="n">so</span> <span class="o">=</span> <span class="mi">0</span>
   <span class="n">CASE</span> <span class="n">CHR</span><span class="err">$</span><span class="p">(</span><span class="o">&amp;</span><span class="n">H8</span><span class="p">),</span> <span class="n">CHR</span><span class="err">$</span><span class="p">(</span><span class="o">&amp;</span><span class="n">H1B</span><span class="p">)</span> <span class="c1">'bksp, esc</span>
    <span class="n">EXIT</span> <span class="n">SUB</span>
   <span class="n">CASE</span> <span class="n">CHR</span><span class="err">$</span><span class="p">(</span><span class="o">&amp;</span><span class="n">HD</span><span class="p">)</span> <span class="c1">'enter</span>
    <span class="n">IF</span> <span class="n">sc</span> <span class="o">&lt;</span> <span class="n">numnames</span> <span class="n">THEN</span>
     <span class="n">dw</span> <span class="o">=</span> <span class="n">namsrva</span><span class="p">(</span><span class="n">sc</span><span class="p">)</span>
    <span class="n">ELSE</span>
     <span class="n">dw</span> <span class="o">=</span> <span class="n">idsrva</span><span class="p">(</span><span class="n">sc</span> <span class="o">-</span> <span class="n">numnames</span><span class="p">)</span>
    <span class="n">END</span> <span class="n">IF</span>
    <span class="n">IF</span> <span class="n">dw</span> <span class="n">AND</span> <span class="o">&amp;</span><span class="n">H80000000</span><span class="err">~</span><span class="o">&amp;</span> <span class="n">THEN</span>
     <span class="c1">'the spec says its an rfa, but it seems to be an offset in the section/table</span>
     <span class="n">processtable</span> <span class="n">bs</span><span class="p">,</span> <span class="n">bs</span> <span class="o">+</span> <span class="p">(</span><span class="n">dw</span> <span class="n">AND</span> <span class="o">&amp;</span><span class="n">H7FFFFFFF</span><span class="o">&amp;</span><span class="p">),</span> <span class="n">level</span> <span class="o">+</span> <span class="mi">1</span>
     <span class="n">EXIT</span> <span class="n">DO</span>
    <span class="n">ELSE</span>
     <span class="c1">'the spec says its an rfa, but it seems to be an offset in the section/table</span>
     <span class="n">dw</span> <span class="o">=</span> <span class="n">bs</span> <span class="o">+</span> <span class="n">dw</span>
     <span class="n">GET</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">dw</span><span class="p">,</span> <span class="n">dat</span>
     <span class="n">GET</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="o">+</span> <span class="mi">4</span> <span class="o">+</span> <span class="n">dw</span><span class="p">,</span> <span class="n">siz</span>
     <span class="n">LOCATE</span> <span class="mi">24</span><span class="p">,</span> <span class="mi">1</span>
     <span class="n">PRINT</span> <span class="n">dword$</span><span class="p">(</span><span class="n">siz</span><span class="p">)</span> <span class="o">+</span> <span class="s">" bytes."</span><span class="err">;</span>
     <span class="n">LOCATE</span> <span class="mi">23</span><span class="p">,</span> <span class="mi">1</span>
     <span class="n">LINE</span> <span class="n">INPUT</span> <span class="s">"(leave blank to cancel) Output file? "</span><span class="err">;</span> <span class="n">k</span>
     <span class="n">IF</span> <span class="n">LEN</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="n">THEN</span>
      <span class="n">IF</span> <span class="n">_FILEEXISTS</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="n">THEN</span>
       <span class="n">PRINT</span>
       <span class="n">PRINT</span> <span class="s">"File already exists."</span><span class="err">;</span>
      <span class="n">ELSE</span>
       <span class="n">OPEN</span> <span class="n">k</span> <span class="n">FOR</span> <span class="n">BINARY</span> <span class="n">AS</span> <span class="mi">2</span>
       <span class="n">SEEK</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">rva2fp</span><span class="p">(</span><span class="n">dat</span><span class="p">)</span>
       <span class="n">FOR</span> <span class="n">dw</span> <span class="o">=</span> <span class="mi">1</span> <span class="n">TO</span> <span class="n">siz</span>
        <span class="n">GET</span> <span class="mi">1</span><span class="p">,</span> <span class="p">,</span> <span class="n">b</span>
        <span class="n">PUT</span> <span class="mi">2</span><span class="p">,</span> <span class="p">,</span> <span class="n">b</span>
       <span class="n">NEXT</span>
       <span class="n">CLOSE</span> <span class="mi">2</span>
       <span class="n">PRINT</span>
       <span class="n">PRINT</span> <span class="s">"Done."</span><span class="err">;</span>
      <span class="n">END</span> <span class="n">IF</span>
      <span class="n">SLEEP</span><span class="p">:</span> <span class="n">DO</span><span class="p">:</span> <span class="n">LOOP</span> <span class="n">WHILE</span> <span class="n">LEN</span><span class="p">(</span><span class="n">INKEY</span><span class="err">$</span><span class="p">)</span>
     <span class="n">END</span> <span class="n">IF</span>
     <span class="n">EXIT</span> <span class="n">DO</span>
    <span class="n">END</span> <span class="n">IF</span>
  <span class="n">END</span> <span class="n">SELECT</span>
 <span class="n">LOOP</span>
<span class="n">LOOP</span>
<span class="n">END</span> <span class="n">SUB</span>

<span class="n">FUNCTION</span> <span class="n">word$</span> <span class="p">(</span><span class="n">w</span> <span class="n">AS</span> <span class="n">_UNSIGNED</span> <span class="n">INTEGER</span><span class="p">)</span>
<span class="n">DIM</span> <span class="n">t</span> <span class="n">AS</span> <span class="n">STRING</span>
<span class="n">t</span> <span class="o">=</span> <span class="n">LCASE</span><span class="err">$</span><span class="p">(</span><span class="n">HEX</span><span class="err">$</span><span class="p">(</span><span class="n">w</span><span class="p">))</span>
<span class="n">word</span> <span class="o">=</span> <span class="s">"0x"</span> <span class="o">+</span> <span class="n">STRING</span><span class="err">$</span><span class="p">(</span><span class="mi">4</span> <span class="o">-</span> <span class="n">LEN</span><span class="p">(</span><span class="n">t</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">H30</span><span class="p">)</span> <span class="o">+</span> <span class="n">t</span>
<span class="n">END</span> <span class="n">FUNCTION</span>

<span class="n">FUNCTION</span> <span class="n">dword$</span> <span class="p">(</span><span class="n">dw</span> <span class="n">AS</span> <span class="n">_UNSIGNED</span> <span class="n">LONG</span><span class="p">)</span>
<span class="n">DIM</span> <span class="n">t</span> <span class="n">AS</span> <span class="n">STRING</span>
<span class="n">t</span> <span class="o">=</span> <span class="n">LCASE</span><span class="err">$</span><span class="p">(</span><span class="n">HEX</span><span class="err">$</span><span class="p">(</span><span class="n">dw</span><span class="p">))</span>
<span class="n">dword</span> <span class="o">=</span> <span class="s">"0x"</span> <span class="o">+</span> <span class="n">STRING</span><span class="err">$</span><span class="p">(</span><span class="mi">8</span> <span class="o">-</span> <span class="n">LEN</span><span class="p">(</span><span class="n">t</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">H30</span><span class="p">)</span> <span class="o">+</span> <span class="n">t</span>
<span class="n">END</span> <span class="n">FUNCTION</span>

<span class="n">FUNCTION</span> <span class="n">rva2fp</span><span class="err">~</span><span class="o">&amp;</span> <span class="p">(</span><span class="n">rva</span> <span class="n">AS</span> <span class="n">_UNSIGNED</span> <span class="n">LONG</span><span class="p">)</span>
<span class="n">DIM</span> <span class="n">w</span> <span class="n">AS</span> <span class="n">_UNSIGNED</span> <span class="n">INTEGER</span>
<span class="n">FOR</span> <span class="n">w</span> <span class="o">=</span> <span class="mi">0</span> <span class="n">TO</span> <span class="n">NumberOfSections</span> <span class="o">-</span> <span class="mi">1</span>
 <span class="n">IF</span> <span class="n">rva</span> <span class="o">&lt;</span> <span class="n">secsva</span><span class="p">(</span><span class="n">w</span><span class="p">)</span> <span class="n">THEN</span> <span class="n">EXIT</span> <span class="n">FOR</span>
<span class="n">NEXT</span>
<span class="n">w</span> <span class="o">=</span> <span class="n">w</span> <span class="o">-</span> <span class="mi">1</span>
<span class="n">IF</span> <span class="n">w</span> <span class="o">&gt;</span> <span class="n">NumberOfSections</span> <span class="o">-</span> <span class="mi">1</span> <span class="n">THEN</span> <span class="n">PRINT</span> <span class="n">dword$</span><span class="p">(</span><span class="n">rva</span><span class="p">),</span> <span class="n">w</span><span class="p">:</span> <span class="n">SLEEP</span>
<span class="n">rva2fp</span> <span class="o">=</span> <span class="n">rva</span> <span class="o">+</span> <span class="p">(</span><span class="n">secsfp</span><span class="p">(</span><span class="n">w</span><span class="p">)</span> <span class="o">-</span> <span class="n">secsva</span><span class="p">(</span><span class="n">w</span><span class="p">))</span>
<span class="n">END</span> <span class="n">FUNCTION</span>

<span class="n">SUB</span> <span class="n">dump</span> <span class="p">(</span><span class="n">addr</span> <span class="n">AS</span> <span class="n">_UNSIGNED</span> <span class="n">LONG</span><span class="p">)</span>
<span class="n">DIM</span> <span class="n">t</span> <span class="n">AS</span> <span class="n">STRING</span>
<span class="n">DIM</span> <span class="n">dw</span> <span class="n">AS</span> <span class="n">_UNSIGNED</span> <span class="n">LONG</span>
<span class="n">DIM</span> <span class="n">ul</span> <span class="n">AS</span> <span class="n">_UNSIGNED</span> <span class="n">LONG</span>
<span class="n">DIM</span> <span class="n">b</span> <span class="n">AS</span> <span class="n">_UNSIGNED</span> <span class="n">_BYTE</span>

<span class="n">VIEW</span> <span class="n">PRINT</span>
<span class="n">ul</span> <span class="o">=</span> <span class="n">addr</span>
<span class="n">DO</span>
 <span class="n">COLOR</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">0</span>
 <span class="n">CLS</span> <span class="mi">0</span>
 <span class="n">SEEK</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">ul</span>
 <span class="n">FOR</span> <span class="n">dw</span> <span class="o">=</span> <span class="n">ul</span> <span class="n">TO</span> <span class="p">(</span><span class="n">ul</span> <span class="n">AND</span> <span class="o">&amp;</span><span class="n">HFFFFFFF0</span><span class="p">)</span> <span class="o">+</span> <span class="o">&amp;</span><span class="n">H15F</span>
  <span class="n">IF</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">ul</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">LOF</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="n">THEN</span> <span class="n">EXIT</span> <span class="n">FOR</span>
  <span class="n">GET</span> <span class="mi">1</span><span class="p">,</span> <span class="p">,</span> <span class="n">b</span>
  <span class="n">IF</span> <span class="p">(</span><span class="n">dw</span> <span class="n">AND</span> <span class="o">&amp;</span><span class="n">HF</span><span class="p">)</span> <span class="o">=</span> <span class="mi">0</span> <span class="n">THEN</span>
   <span class="n">t</span> <span class="o">=</span> <span class="n">LCASE</span><span class="err">$</span><span class="p">(</span><span class="n">HEX</span><span class="err">$</span><span class="p">(</span><span class="n">dw</span><span class="p">))</span>
   <span class="n">COLOR</span> <span class="mi">7</span>
   <span class="n">PRINT</span> <span class="n">STRING</span><span class="err">$</span><span class="p">(</span><span class="mi">8</span> <span class="o">-</span> <span class="n">LEN</span><span class="p">(</span><span class="n">t</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">H30</span><span class="p">)</span> <span class="o">+</span> <span class="n">t</span><span class="err">;</span> <span class="n">SPACE</span><span class="err">$</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="err">;</span>
  <span class="n">END</span> <span class="n">IF</span>
  <span class="n">IF</span> <span class="p">(</span><span class="n">dw</span> <span class="n">AND</span> <span class="o">&amp;</span><span class="n">H4</span><span class="p">)</span> <span class="n">THEN</span> <span class="n">COLOR</span> <span class="mi">3</span> <span class="n">ELSE</span> <span class="n">COLOR</span> <span class="mi">2</span>
  <span class="n">LOCATE</span> <span class="p">,</span> <span class="mi">14</span> <span class="o">+</span> <span class="p">((</span><span class="n">dw</span> <span class="n">AND</span> <span class="o">&amp;</span><span class="n">HF</span><span class="p">)</span> <span class="o">*</span> <span class="mi">3</span><span class="p">)</span>
  <span class="n">t</span> <span class="o">=</span> <span class="n">LCASE</span><span class="err">$</span><span class="p">(</span><span class="n">HEX</span><span class="err">$</span><span class="p">(</span><span class="n">b</span><span class="p">))</span>
  <span class="n">IF</span> <span class="n">b</span> <span class="o">&lt;</span> <span class="o">&amp;</span><span class="n">H10</span> <span class="n">THEN</span> <span class="n">PRINT</span> <span class="s">"0"</span> <span class="o">+</span> <span class="n">t</span><span class="err">;</span> <span class="n">ELSE</span> <span class="n">PRINT</span> <span class="n">t</span><span class="err">;</span>
  <span class="n">LOCATE</span> <span class="p">,</span> <span class="mi">65</span> <span class="o">+</span> <span class="p">(</span><span class="n">dw</span> <span class="n">AND</span> <span class="o">&amp;</span><span class="n">HF</span><span class="p">)</span>
  <span class="n">SELECT</span> <span class="n">CASE</span> <span class="n">b</span>
   <span class="n">CASE</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">9</span> <span class="n">TO</span> <span class="o">&amp;</span><span class="n">HD</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">H1F</span><span class="p">:</span> <span class="n">PRINT</span> <span class="s">"."</span><span class="err">;</span>
   <span class="n">CASE</span> <span class="n">ELSE</span><span class="p">:</span> <span class="n">PRINT</span> <span class="n">CHR</span><span class="err">$</span><span class="p">(</span><span class="n">b</span><span class="p">)</span><span class="err">;</span>
  <span class="n">END</span> <span class="n">SELECT</span>
 <span class="n">NEXT</span>
 <span class="n">PRINT</span>
 <span class="n">COLOR</span> <span class="mi">7</span>
 <span class="n">LINE</span> <span class="n">INPUT</span> <span class="s">"(leave blank to cancel) Address: 0x"</span><span class="err">;</span> <span class="n">t</span>
 <span class="n">IF</span> <span class="n">LTRIM</span><span class="err">$</span><span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="o">=</span> <span class="s">""</span> <span class="n">THEN</span> <span class="n">EXIT</span> <span class="n">DO</span>
 <span class="n">ul</span> <span class="o">=</span> <span class="n">VAL</span><span class="p">(</span><span class="s">"&amp;h"</span> <span class="o">+</span> <span class="n">t</span> <span class="o">+</span> <span class="s">"&amp;"</span><span class="p">)</span> <span class="n">AND</span> <span class="o">&amp;</span><span class="n">H7FFFFFFF</span>
<span class="n">LOOP</span>
<span class="n">END</span> <span class="n">SUB</span> 

</code></pre></div></div>
<p><sub>Public domain October 2011 by Michael Calkins based on the Microsoft PE and COFF spec, Revision 8.2 - September 21, 2010</sub></p>

<blockquote>
  <p>If you open <em>c:\windows\system32\shell32.dll</em>, and save the first item (descend the first entry, then the first entry of the next level, etc), itâ€™s an .AVI file of a flashlight searching a folder. If you go down the first entry of the first level, but the last entry of the second level, itâ€™s an .AVI of a globe throwing a page at a folder. Save both files as AVI to view the video.</p>
</blockquote>

<blockquote>
  <p>I wouldnâ€™t consider the program finished. Thereâ€™s some double checking, tweaking, and optimizing that could be done. For example, the dump sub could probably use an extra variable, and could probably use some increased functionality. I wrote it to help me debug the part that reads the resource tables. As I say in the comments, the part that gives the address of either the â€œleafâ€ or the next table lower seems to be relative to the start of the main table or section, not an actual RVA.</p>
</blockquote>

<blockquote>
  <p>With things like:</p>
</blockquote>

<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
                GET 1, 1 + coff + 20 + 28 + (-4 AND pe32plus), ImageBase 

</code></pre></div></div>

<blockquote>
  <p>That could obviously be optimized by combining the 1 + 20 + 28. By leaving it uncombined, though, it documents itself better in terms of helping the human reader match it up with the specification. 1 because QBASICâ€™s GET/PUT/SEEK idiotically starts at 1 instead of 0. Coff because we want an offset from the start of the coff header, 20 to skip the 20 byte coff main header, 28 because thatâ€™s the offset of ImageBase in the optional header, and (-4 AND pe32plus) because the offset is 24 if the Magic is PE32+. Either QB64 or GCC will probably optimize it anyway, I would think.</p>
</blockquote>

<blockquote>
  <p>In the Section table, the name of the field is VirtualAddress, but the description seems to say that it is an RVA. My program assumes that it is an RVA. The rva2fp function finds which section a given RVA is in, and then uses the difference between the RVA and the file pointer for that section to turn the given RVA into a file pointer.</p>
</blockquote>

<blockquote>
  <p>Regards, Michael Calkins</p>
</blockquote>

<h2 id="revision-2">Revision 2</h2>

<blockquote>
  <p>Iâ€™ve made a few minor changes to the program. It will show you the first 400 bytes when you choose to export the data. Also, by moving the initialization of sc and so outside the loop, you will now come back to the correct entry upon ascending a level. I experimented with code to PSET the data, but it is commented out.</p>
</blockquote>

<div class="language-vb highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="c1">'october 2011, michael calkins</span>
<span class="c1">'my code is public domain, but it's based on Microsoft's spec, so I'm not sure</span>
<span class="c1">'what kind of patents or copyrights apply.</span>
<span class="c1">'based on the Microsoft PE and COFF spec, Revision 8.2 - September 21, 2010</span>
<span class="c1">'http://msdn.microsoft.com/en-us/windows/hardware/gg463119.aspx</span>

<span class="n">DIM</span> <span class="n">nam</span> <span class="n">AS</span> <span class="n">STRING</span> <span class="o">*</span> <span class="mi">8</span>
<span class="n">DIM</span> <span class="n">fil</span> <span class="n">AS</span> <span class="n">STRING</span>
<span class="n">DIM</span> <span class="n">k</span> <span class="n">AS</span> <span class="n">STRING</span>
<span class="n">DIM</span> <span class="n">dw</span> <span class="n">AS</span> <span class="n">_UNSIGNED</span> <span class="n">LONG</span>
<span class="n">DIM</span> <span class="n">ul</span> <span class="n">AS</span> <span class="n">_UNSIGNED</span> <span class="n">LONG</span>
<span class="n">DIM</span> <span class="n">coff</span> <span class="n">AS</span> <span class="n">_UNSIGNED</span> <span class="n">LONG</span>
<span class="n">DIM</span> <span class="n">SectionTable</span> <span class="n">AS</span> <span class="n">_UNSIGNED</span> <span class="n">LONG</span>
<span class="n">DIM</span> <span class="n">ImageBase</span> <span class="n">AS</span> <span class="n">_UNSIGNED</span> <span class="n">LONG</span>
<span class="n">DIM</span> <span class="n">rsrc</span> <span class="n">AS</span> <span class="n">_UNSIGNED</span> <span class="n">LONG</span>
<span class="n">DIM</span> <span class="n">pe32plus</span> <span class="n">AS</span> <span class="n">LONG</span>
<span class="n">DIM</span> <span class="n">w</span> <span class="n">AS</span> <span class="n">_UNSIGNED</span> <span class="n">INTEGER</span>
<span class="n">DIM</span> <span class="n">SizeOfOptionalHeader</span> <span class="n">AS</span> <span class="n">_UNSIGNED</span> <span class="n">INTEGER</span>
<span class="n">DIM</span> <span class="n">SHARED</span> <span class="n">NumberOfSections</span> <span class="n">AS</span> <span class="n">_UNSIGNED</span> <span class="n">INTEGER</span>
<span class="n">DIM</span> <span class="n">NumberOfRvaAndSizes</span> <span class="n">AS</span> <span class="n">_UNSIGNED</span> <span class="n">LONG</span>

<span class="n">CLS</span>
<span class="n">LINE</span> <span class="n">INPUT</span> <span class="s">"Name of the PE image to open? "</span><span class="err">;</span> <span class="n">fil</span>
<span class="n">IF</span> <span class="n">_FILEEXISTS</span><span class="p">(</span><span class="n">fil</span><span class="p">)</span> <span class="o">=</span> <span class="mi">0</span> <span class="n">THEN</span> <span class="n">PRINT</span> <span class="s">"File not found."</span><span class="p">:</span> <span class="n">END</span>
<span class="n">OPEN</span> <span class="n">fil</span> <span class="n">FOR</span> <span class="n">BINARY</span> <span class="n">ACCESS</span> <span class="n">READ</span> <span class="n">AS</span> <span class="mi">1</span>
<span class="n">GET</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="o">+</span> <span class="mi">0</span><span class="p">,</span> <span class="n">w</span>
<span class="n">IF</span> <span class="n">w</span> <span class="o">&lt;&gt;</span> <span class="o">&amp;</span><span class="n">H5A4D</span> <span class="n">THEN</span> <span class="n">PRINT</span> <span class="s">"No MZ signature."</span><span class="p">:</span> <span class="n">END</span>
<span class="n">GET</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="o">+</span> <span class="o">&amp;</span><span class="n">H3C</span><span class="p">,</span> <span class="n">dw</span>
<span class="n">coff</span> <span class="o">=</span> <span class="n">dw</span> <span class="o">+</span> <span class="mi">4</span>
<span class="n">GET</span> <span class="mi">1</span><span class="p">,</span> <span class="n">dw</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">dw</span>
<span class="n">IF</span> <span class="n">dw</span> <span class="o">&lt;&gt;</span> <span class="o">&amp;</span><span class="n">H4550</span><span class="o">&amp;</span> <span class="n">THEN</span> <span class="n">PRINT</span> <span class="s">"No PE signature."</span><span class="p">:</span> <span class="n">END</span>
<span class="n">GET</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">coff</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="n">NumberOfSections</span>
<span class="n">IF</span> <span class="n">NumberOfSections</span> <span class="o">=</span> <span class="mi">0</span> <span class="n">THEN</span> <span class="n">PRINT</span> <span class="s">"No sections."</span><span class="p">:</span> <span class="n">END</span>
<span class="n">PRINT</span> <span class="s">"NumberOfSections:"</span><span class="err">;</span> <span class="n">NumberOfSections</span>
<span class="n">DIM</span> <span class="n">SHARED</span> <span class="n">secsva</span><span class="p">(</span><span class="mi">0</span> <span class="n">TO</span> <span class="n">NumberOfSections</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="n">AS</span> <span class="n">_UNSIGNED</span> <span class="n">LONG</span>
<span class="n">DIM</span> <span class="n">SHARED</span> <span class="n">secsfp</span><span class="p">(</span><span class="mi">0</span> <span class="n">TO</span> <span class="n">NumberOfSections</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="n">AS</span> <span class="n">_UNSIGNED</span> <span class="n">LONG</span>
<span class="n">GET</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">coff</span> <span class="o">+</span> <span class="mi">16</span><span class="p">,</span> <span class="n">SizeOfOptionalHeader</span>
<span class="n">IF</span> <span class="n">SizeOfOptionalHeader</span> <span class="o">=</span> <span class="mi">0</span> <span class="n">THEN</span> <span class="n">PRINT</span> <span class="s">"No optional header."</span><span class="p">:</span> <span class="n">END</span>
<span class="n">PRINT</span> <span class="s">"SizeOfOptionalHeader:"</span><span class="p">,</span> <span class="n">SPACE</span><span class="err">$</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span><span class="err">;</span> <span class="n">word$</span><span class="p">(</span><span class="n">SizeOfOptionalHeader</span><span class="p">)</span>
<span class="n">GET</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">coff</span> <span class="o">+</span> <span class="mi">20</span><span class="p">,</span> <span class="n">w</span>
<span class="n">SELECT</span> <span class="n">CASE</span> <span class="n">w</span>
 <span class="n">CASE</span> <span class="o">&amp;</span><span class="n">H10B</span><span class="p">:</span> <span class="n">pe32plus</span> <span class="o">=</span> <span class="mi">0</span><span class="p">:</span> <span class="n">PRINT</span> <span class="s">"PE32"</span>
 <span class="n">CASE</span> <span class="o">&amp;</span><span class="n">H20B</span><span class="p">:</span> <span class="n">pe32plus</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span> <span class="n">PRINT</span> <span class="s">"PE32+"</span>
 <span class="n">CASE</span> <span class="n">ELSE</span><span class="p">:</span> <span class="n">PRINT</span> <span class="s">"Unknown Magic."</span><span class="p">:</span> <span class="n">END</span>
<span class="n">END</span> <span class="n">SELECT</span>
<span class="n">GET</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">coff</span> <span class="o">+</span> <span class="mi">20</span> <span class="o">+</span> <span class="mi">28</span> <span class="o">+</span> <span class="p">(</span><span class="o">-</span><span class="mi">4</span> <span class="n">AND</span> <span class="n">pe32plus</span><span class="p">),</span> <span class="n">ImageBase</span>
<span class="n">PRINT</span> <span class="s">"ImageBase:"</span><span class="p">,</span> <span class="s">""</span><span class="p">,</span> <span class="n">dword$</span><span class="p">(</span><span class="n">ImageBase</span><span class="p">)</span>
<span class="n">GET</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">coff</span> <span class="o">+</span> <span class="mi">20</span> <span class="o">+</span> <span class="mi">92</span> <span class="o">+</span> <span class="p">(</span><span class="mi">16</span> <span class="n">AND</span> <span class="n">pe32plus</span><span class="p">),</span> <span class="n">NumberOfRvaAndSizes</span>
<span class="n">IF</span> <span class="n">NumberOfRvaAndSizes</span> <span class="o">&lt;</span> <span class="mi">3</span> <span class="n">THEN</span> <span class="n">PRINT</span> <span class="s">"No resource table."</span><span class="p">:</span> <span class="n">END</span>
<span class="n">PRINT</span> <span class="s">"NumberOfRvaAndSizes:"</span><span class="err">;</span> <span class="n">NumberOfRvaAndSizes</span>
<span class="n">GET</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">coff</span> <span class="o">+</span> <span class="mi">20</span> <span class="o">+</span> <span class="mi">112</span> <span class="o">+</span> <span class="p">(</span><span class="mi">16</span> <span class="n">AND</span> <span class="n">pe32plus</span><span class="p">),</span> <span class="n">rsrc</span>
<span class="n">PRINT</span> <span class="s">"Rva of resource table:"</span><span class="p">,</span> <span class="n">dword$</span><span class="p">(</span><span class="n">rsrc</span><span class="p">)</span>
<span class="n">GET</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">coff</span> <span class="o">+</span> <span class="mi">20</span> <span class="o">+</span> <span class="mi">4</span> <span class="o">+</span> <span class="mi">112</span> <span class="o">+</span> <span class="p">(</span><span class="mi">16</span> <span class="n">AND</span> <span class="n">pe32plus</span><span class="p">),</span> <span class="n">dw</span>
<span class="n">PRINT</span> <span class="s">"Size of resource table:"</span><span class="p">,</span> <span class="n">dword$</span><span class="p">(</span><span class="n">dw</span><span class="p">)</span>
<span class="n">IF</span> <span class="p">(</span><span class="n">rsrc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span> <span class="n">OR</span> <span class="p">(</span><span class="n">dw</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span> <span class="n">THEN</span> <span class="n">PRINT</span> <span class="s">"No resource table."</span><span class="p">:</span> <span class="n">END</span>
<span class="n">SectionTable</span> <span class="o">=</span> <span class="n">coff</span> <span class="o">+</span> <span class="mi">20</span> <span class="o">+</span> <span class="n">SizeOfOptionalHeader</span>
<span class="n">PRINT</span> <span class="s">"section"</span><span class="p">,</span> <span class="s">"va"</span><span class="p">,</span> <span class="s">"file ptr"</span>
<span class="n">FOR</span> <span class="n">w</span> <span class="o">=</span> <span class="mi">0</span> <span class="n">TO</span> <span class="n">NumberOfSections</span> <span class="o">-</span> <span class="mi">1</span>
 <span class="n">GET</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">SectionTable</span> <span class="o">+</span> <span class="p">(</span><span class="mi">40</span> <span class="o">*</span> <span class="n">w</span><span class="p">),</span> <span class="n">nam</span>
 <span class="n">GET</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">SectionTable</span> <span class="o">+</span> <span class="mi">12</span> <span class="o">+</span> <span class="p">(</span><span class="mi">40</span> <span class="o">*</span> <span class="n">w</span><span class="p">),</span> <span class="n">ul</span>
 <span class="n">GET</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">SectionTable</span> <span class="o">+</span> <span class="mi">20</span> <span class="o">+</span> <span class="p">(</span><span class="mi">40</span> <span class="o">*</span> <span class="n">w</span><span class="p">),</span> <span class="n">dw</span>
 <span class="n">PRINT</span> <span class="n">nam</span><span class="p">,</span> <span class="n">dword$</span><span class="p">(</span><span class="n">ul</span><span class="p">),</span> <span class="n">dword$</span><span class="p">(</span><span class="n">dw</span><span class="p">)</span>
 <span class="n">secsva</span><span class="p">(</span><span class="n">w</span><span class="p">)</span> <span class="o">=</span> <span class="n">ul</span>
 <span class="n">secsfp</span><span class="p">(</span><span class="n">w</span><span class="p">)</span> <span class="o">=</span> <span class="n">dw</span>
<span class="n">NEXT</span>
<span class="n">PRINT</span>
<span class="n">PRINT</span> <span class="s">"Proceed? "</span><span class="err">;</span>
<span class="n">DO</span>
 <span class="n">k</span> <span class="o">=</span> <span class="n">LCASE</span><span class="err">$</span><span class="p">(</span><span class="n">INKEY</span><span class="err">$</span><span class="p">)</span>
 <span class="n">IF</span> <span class="n">k</span> <span class="o">=</span> <span class="s">"n"</span> <span class="n">THEN</span> <span class="n">PRINT</span> <span class="n">k</span><span class="p">:</span> <span class="n">END</span>
<span class="n">LOOP</span> <span class="n">UNTIL</span> <span class="n">k</span> <span class="o">=</span> <span class="s">"y"</span>
<span class="n">PRINT</span> <span class="n">k</span>
<span class="n">processtable</span> <span class="n">rva2fp</span><span class="p">(</span><span class="n">rsrc</span><span class="p">),</span> <span class="n">rva2fp</span><span class="p">(</span><span class="n">rsrc</span><span class="p">),</span> <span class="mi">0</span>
<span class="n">SYSTEM</span>

<span class="n">SUB</span> <span class="n">processtable</span> <span class="p">(</span><span class="n">bs</span> <span class="n">AS</span> <span class="n">_UNSIGNED</span> <span class="n">LONG</span><span class="p">,</span> <span class="n">addr</span> <span class="n">AS</span> <span class="n">_UNSIGNED</span> <span class="n">LONG</span><span class="p">,</span> <span class="n">level</span> <span class="n">AS</span> <span class="n">INTEGER</span><span class="p">)</span>
<span class="n">DIM</span> <span class="n">k</span> <span class="n">AS</span> <span class="n">STRING</span>
<span class="n">DIM</span> <span class="n">dw</span> <span class="n">AS</span> <span class="n">_UNSIGNED</span> <span class="n">LONG</span>
<span class="n">DIM</span> <span class="n">numnamest8</span> <span class="n">AS</span> <span class="n">_UNSIGNED</span> <span class="n">LONG</span>
<span class="n">DIM</span> <span class="n">dat</span> <span class="n">AS</span> <span class="n">_UNSIGNED</span> <span class="n">LONG</span>
<span class="n">DIM</span> <span class="n">siz</span> <span class="n">AS</span> <span class="n">_UNSIGNED</span> <span class="n">LONG</span>
<span class="n">DIM</span> <span class="n">so</span> <span class="n">AS</span> <span class="n">LONG</span>
<span class="n">DIM</span> <span class="n">sc</span> <span class="n">AS</span> <span class="n">LONG</span>
<span class="n">DIM</span> <span class="n">numnames</span> <span class="n">AS</span> <span class="n">_UNSIGNED</span> <span class="n">INTEGER</span>
<span class="n">DIM</span> <span class="n">numids</span> <span class="n">AS</span> <span class="n">_UNSIGNED</span> <span class="n">INTEGER</span>
<span class="n">DIM</span> <span class="n">w</span> <span class="n">AS</span> <span class="n">_UNSIGNED</span> <span class="n">INTEGER</span>
<span class="n">DIM</span> <span class="n">ln</span> <span class="n">AS</span> <span class="n">_UNSIGNED</span> <span class="n">INTEGER</span>
<span class="n">DIM</span> <span class="n">x</span> <span class="n">AS</span> <span class="n">_UNSIGNED</span> <span class="n">INTEGER</span>
<span class="n">DIM</span> <span class="n">y</span> <span class="n">AS</span> <span class="n">_UNSIGNED</span> <span class="n">INTEGER</span>
<span class="n">DIM</span> <span class="n">b</span> <span class="n">AS</span> <span class="n">_UNSIGNED</span> <span class="n">_BYTE</span>

<span class="n">GET</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">addr</span> <span class="o">+</span> <span class="mi">12</span><span class="p">,</span> <span class="n">numnames</span>
<span class="n">GET</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">addr</span> <span class="o">+</span> <span class="mi">14</span><span class="p">,</span> <span class="n">numids</span>
<span class="n">DIM</span> <span class="n">nams</span><span class="p">(</span><span class="mi">0</span> <span class="n">TO</span> <span class="n">numnames</span> <span class="o">+</span> <span class="p">(</span><span class="n">numnames</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">))</span> <span class="n">AS</span> <span class="n">STRING</span>
<span class="n">DIM</span> <span class="n">namsrva</span><span class="p">(</span><span class="mi">0</span> <span class="n">TO</span> <span class="n">numnames</span> <span class="o">+</span> <span class="p">(</span><span class="n">numnames</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">))</span> <span class="n">AS</span> <span class="n">_UNSIGNED</span> <span class="n">LONG</span>
<span class="n">DIM</span> <span class="n">ids</span><span class="p">(</span><span class="mi">0</span> <span class="n">TO</span> <span class="n">numids</span> <span class="o">+</span> <span class="p">(</span><span class="n">numids</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">))</span> <span class="n">AS</span> <span class="n">_UNSIGNED</span> <span class="n">LONG</span>
<span class="n">DIM</span> <span class="n">idsrva</span><span class="p">(</span><span class="mi">0</span> <span class="n">TO</span> <span class="n">numids</span> <span class="o">+</span> <span class="p">(</span><span class="n">numids</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">))</span> <span class="n">AS</span> <span class="n">_UNSIGNED</span> <span class="n">LONG</span>

<span class="c1">'get named entries</span>
<span class="n">FOR</span> <span class="n">x</span> <span class="o">=</span> <span class="mi">0</span> <span class="n">TO</span> <span class="n">numnames</span> <span class="o">-</span> <span class="mi">1</span>
 <span class="n">GET</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">addr</span> <span class="o">+</span> <span class="mi">16</span> <span class="o">+</span> <span class="p">(</span><span class="n">x</span> <span class="o">*</span> <span class="mi">8</span><span class="p">),</span> <span class="n">dw</span>
 <span class="n">dw</span> <span class="o">=</span> <span class="n">rva2fp</span><span class="p">(</span><span class="n">dw</span><span class="p">)</span>
 <span class="n">GET</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">dw</span><span class="p">,</span> <span class="n">ln</span>
 <span class="n">FOR</span> <span class="n">y</span> <span class="o">=</span> <span class="mi">0</span> <span class="n">TO</span> <span class="n">ln</span> <span class="o">-</span> <span class="mi">1</span>
  <span class="n">GET</span> <span class="mi">1</span><span class="p">,</span> <span class="p">,</span> <span class="n">w</span>
  <span class="n">SELECT</span> <span class="n">CASE</span> <span class="n">w</span>
   <span class="n">CASE</span> <span class="o">&amp;</span><span class="n">H20</span> <span class="n">TO</span> <span class="o">&amp;</span><span class="n">H7E</span><span class="p">:</span> <span class="n">nams</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">=</span> <span class="n">nams</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">+</span> <span class="n">CHR</span><span class="err">$</span><span class="p">(</span><span class="n">w</span><span class="p">)</span>
   <span class="n">CASE</span> <span class="n">ELSE</span><span class="p">:</span> <span class="n">nams</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">=</span> <span class="n">nams</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">+</span> <span class="n">CHR</span><span class="err">$</span><span class="p">(</span><span class="o">&amp;</span><span class="n">H1A</span><span class="p">)</span>
  <span class="n">END</span> <span class="n">SELECT</span>
  <span class="n">IF</span> <span class="n">y</span> <span class="o">=</span> <span class="mi">68</span> <span class="n">THEN</span> <span class="n">EXIT</span> <span class="n">FOR</span>
 <span class="n">NEXT</span>
 <span class="n">GET</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">addr</span> <span class="o">+</span> <span class="mi">16</span> <span class="o">+</span> <span class="mi">4</span> <span class="o">+</span> <span class="p">(</span><span class="n">x</span> <span class="o">*</span> <span class="mi">8</span><span class="p">),</span> <span class="n">namsrva</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="n">NEXT</span>

<span class="c1">'get numbered entries:</span>
<span class="n">numnamest8</span> <span class="o">=</span> <span class="n">numnames</span> <span class="o">*</span> <span class="mi">8</span>
<span class="n">FOR</span> <span class="n">x</span> <span class="o">=</span> <span class="mi">0</span> <span class="n">TO</span> <span class="n">numids</span> <span class="o">-</span> <span class="mi">1</span>
 <span class="n">GET</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">addr</span> <span class="o">+</span> <span class="mi">16</span> <span class="o">+</span> <span class="n">numnamest8</span> <span class="o">+</span> <span class="p">(</span><span class="n">x</span> <span class="o">*</span> <span class="mi">8</span><span class="p">),</span> <span class="n">ids</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
 <span class="n">GET</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">addr</span> <span class="o">+</span> <span class="mi">16</span> <span class="o">+</span> <span class="mi">4</span> <span class="o">+</span> <span class="n">numnamest8</span> <span class="o">+</span> <span class="p">(</span><span class="n">x</span> <span class="o">*</span> <span class="mi">8</span><span class="p">),</span> <span class="n">idsrva</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="n">NEXT</span>

<span class="c1">'display:</span>
<span class="n">VIEW</span> <span class="n">PRINT</span>
<span class="n">sc</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">so</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">DO</span>
 <span class="n">CLS</span> <span class="mi">0</span> <span class="c1">'qb64 bug? not locating to 1,1?</span>
 <span class="n">LOCATE</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span>
 <span class="n">SELECT</span> <span class="n">CASE</span> <span class="n">level</span>
  <span class="n">CASE</span> <span class="mi">0</span><span class="p">:</span> <span class="n">PRINT</span> <span class="s">"1st level - Type"</span><span class="err">;</span>
  <span class="n">CASE</span> <span class="mi">1</span><span class="p">:</span> <span class="n">PRINT</span> <span class="s">"2nd level - Name"</span><span class="err">;</span>
  <span class="n">CASE</span> <span class="mi">2</span><span class="p">:</span> <span class="n">PRINT</span> <span class="s">"3rd level - Language"</span><span class="err">;</span>
  <span class="n">CASE</span> <span class="n">ELSE</span><span class="p">:</span> <span class="n">PRINT</span> <span class="n">LTRIM</span><span class="err">$</span><span class="p">(</span><span class="n">STR</span><span class="err">$</span><span class="p">(</span><span class="n">level</span><span class="p">))</span> <span class="o">+</span> <span class="s">"th level"</span><span class="err">;</span>
 <span class="n">END</span> <span class="n">SELECT</span>
 <span class="n">PRINT</span> <span class="s">""</span><span class="p">,</span> <span class="s">"file ptr: "</span><span class="err">;</span> <span class="n">dword$</span><span class="p">(</span><span class="n">addr</span><span class="p">)</span><span class="err">;</span> <span class="s">". Press 'D' to dump."</span>
 <span class="n">PRINT</span> <span class="n">numnames</span><span class="err">;</span> <span class="s">"names in this level, in this branch."</span>
 <span class="n">PRINT</span> <span class="n">numids</span><span class="err">;</span> <span class="s">"IDs in this level, in this branch."</span>
 <span class="n">IF</span> <span class="p">(</span><span class="n">numnames</span> <span class="n">OR</span> <span class="n">numids</span><span class="p">)</span> <span class="o">=</span> <span class="mi">0</span> <span class="n">THEN</span>
  <span class="n">IF</span> <span class="n">level</span> <span class="n">THEN</span>
   <span class="n">PRINT</span> <span class="s">"Press any key to go up one level."</span>
   <span class="n">SLEEP</span><span class="p">:</span> <span class="n">DO</span><span class="p">:</span> <span class="n">LOOP</span> <span class="n">WHILE</span> <span class="n">LEN</span><span class="p">(</span><span class="n">INKEY</span><span class="err">$</span><span class="p">)</span>
   <span class="n">EXIT</span> <span class="n">SUB</span>
  <span class="n">ELSE</span>
   <span class="n">END</span>
  <span class="n">END</span> <span class="n">IF</span>
 <span class="n">END</span> <span class="n">IF</span>
 <span class="n">PRINT</span> <span class="s">"names are unicode. For simplicity, non ASCII chars will be shown as "</span> <span class="o">+</span> <span class="n">CHR</span><span class="err">$</span><span class="p">(</span><span class="o">&amp;</span><span class="n">H1A</span><span class="p">)</span> <span class="o">+</span> <span class="s">"."</span>
 <span class="n">IF</span> <span class="n">level</span> <span class="n">THEN</span>
  <span class="n">PRINT</span> <span class="s">"BKSP or ESC to go up one level."</span>
 <span class="n">ELSE</span>
  <span class="n">PRINT</span> <span class="s">"BKSP or ESC to exit."</span>
 <span class="n">END</span> <span class="n">IF</span>
 <span class="n">PRINT</span> <span class="s">"UP, DOWN, PGUP, PGDN, HOME, END to navigate list."</span>
 <span class="n">PRINT</span> <span class="s">"ENTER to select."</span>
 <span class="n">PRINT</span> <span class="n">STRING</span><span class="err">$</span><span class="p">(</span><span class="mi">80</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">HC4</span><span class="p">)</span><span class="err">;</span>
 <span class="n">LOCATE</span> <span class="mi">22</span><span class="p">,</span> <span class="mi">1</span>
 <span class="n">PRINT</span> <span class="n">STRING</span><span class="err">$</span><span class="p">(</span><span class="mi">80</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">HC4</span><span class="p">)</span><span class="err">;</span>
 <span class="n">DO</span>
  <span class="n">COLOR</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">0</span>
  <span class="n">LOCATE</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span> <span class="n">PRINT</span> <span class="n">dword$</span><span class="p">(</span><span class="n">sc</span><span class="p">)</span>
  <span class="n">FOR</span> <span class="n">x</span> <span class="o">=</span> <span class="mi">0</span> <span class="n">TO</span> <span class="mi">11</span>
   <span class="n">LOCATE</span> <span class="mi">10</span> <span class="o">+</span> <span class="n">x</span><span class="p">,</span> <span class="mi">1</span>
   <span class="n">IF</span> <span class="n">x</span> <span class="o">+</span> <span class="n">so</span> <span class="o">=</span> <span class="n">sc</span> <span class="n">THEN</span> <span class="n">COLOR</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">1</span> <span class="n">ELSE</span> <span class="n">COLOR</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">0</span>
   <span class="n">IF</span> <span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="n">so</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">numnames</span> <span class="n">THEN</span>
    <span class="n">PRINT</span> <span class="n">nams</span><span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="n">so</span><span class="p">)</span><span class="err">;</span> <span class="n">SPACE</span><span class="err">$</span><span class="p">(</span><span class="mi">70</span> <span class="o">-</span> <span class="n">LEN</span><span class="p">(</span><span class="n">nams</span><span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="n">so</span><span class="p">)))</span><span class="err">;</span>
    <span class="n">PRINT</span> <span class="n">dword$</span><span class="p">(</span><span class="n">bs</span> <span class="o">+</span> <span class="p">(</span><span class="n">namsrva</span><span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="n">so</span><span class="p">)</span> <span class="n">AND</span> <span class="o">&amp;</span><span class="n">H7FFFFFFF</span><span class="o">&amp;</span><span class="p">))</span><span class="err">;</span>
    <span class="n">COLOR</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">0</span>
    <span class="n">LOCATE</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">18</span>
    <span class="n">IF</span> <span class="n">namsrva</span><span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="n">so</span><span class="p">)</span> <span class="n">AND</span> <span class="o">&amp;</span><span class="n">H80000000</span><span class="err">~</span><span class="o">&amp;</span> <span class="n">THEN</span>
     <span class="n">PRINT</span> <span class="s">"(descend)"</span><span class="err">;</span>
    <span class="n">ELSE</span>
     <span class="n">PRINT</span> <span class="s">"(extract)"</span><span class="err">;</span>
    <span class="n">END</span> <span class="n">IF</span>
   <span class="n">ELSEIF</span> <span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="n">so</span><span class="p">)</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">numnames</span> <span class="o">+</span> <span class="n">numids</span><span class="p">)</span> <span class="n">THEN</span>
    <span class="n">PRINT</span> <span class="s">"ID: "</span> <span class="o">+</span> <span class="n">dword$</span><span class="p">(</span><span class="n">ids</span><span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="n">so</span> <span class="o">-</span> <span class="n">numnames</span><span class="p">))</span><span class="err">;</span> <span class="n">SPACE</span><span class="err">$</span><span class="p">(</span><span class="mi">56</span><span class="p">)</span><span class="err">;</span>
    <span class="n">PRINT</span> <span class="n">dword$</span><span class="p">(</span><span class="n">bs</span> <span class="o">+</span> <span class="p">(</span><span class="n">idsrva</span><span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="n">so</span> <span class="o">-</span> <span class="n">numnames</span><span class="p">)))</span><span class="err">;</span>
    <span class="n">COLOR</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">0</span>
    <span class="n">LOCATE</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">18</span>
    <span class="n">IF</span> <span class="n">idsrva</span><span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="p">(</span><span class="n">so</span> <span class="o">-</span> <span class="n">numnames</span><span class="p">))</span> <span class="n">AND</span> <span class="o">&amp;</span><span class="n">H80000000</span><span class="err">~</span><span class="o">&amp;</span> <span class="n">THEN</span>
     <span class="n">PRINT</span> <span class="s">"(descend)"</span><span class="err">;</span>
    <span class="n">ELSE</span>
     <span class="n">PRINT</span> <span class="s">"(extract)"</span><span class="err">;</span>
    <span class="n">END</span> <span class="n">IF</span>
   <span class="n">ELSE</span>
    <span class="n">PRINT</span> <span class="n">SPACE</span><span class="err">$</span><span class="p">(</span><span class="mi">80</span><span class="p">)</span><span class="err">;</span>
   <span class="n">END</span> <span class="n">IF</span>
  <span class="n">NEXT</span>
  <span class="n">DO</span>
   <span class="n">k</span> <span class="o">=</span> <span class="n">INKEY</span><span class="err">$</span>
  <span class="n">LOOP</span> <span class="n">UNTIL</span> <span class="n">LEN</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
  <span class="n">SELECT</span> <span class="n">CASE</span> <span class="n">k</span>
   <span class="n">CASE</span> <span class="s">"d"</span><span class="p">,</span> <span class="s">"D"</span>
    <span class="n">dump</span> <span class="n">addr</span>
    <span class="n">EXIT</span> <span class="n">DO</span>
   <span class="n">CASE</span> <span class="n">MKI</span><span class="err">$</span><span class="p">(</span><span class="o">&amp;</span><span class="n">H4800</span><span class="p">)</span> <span class="c1">'up</span>
    <span class="n">IF</span> <span class="n">sc</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="n">THEN</span>
     <span class="n">sc</span> <span class="o">=</span> <span class="n">sc</span> <span class="o">-</span> <span class="mi">1</span>
     <span class="n">IF</span> <span class="n">sc</span> <span class="o">&lt;</span> <span class="n">so</span> <span class="n">THEN</span> <span class="n">so</span> <span class="o">=</span> <span class="n">sc</span>
    <span class="n">END</span> <span class="n">IF</span>
   <span class="n">CASE</span> <span class="n">MKI</span><span class="err">$</span><span class="p">(</span><span class="o">&amp;</span><span class="n">H5000</span><span class="p">)</span> <span class="c1">'down</span>
    <span class="n">IF</span> <span class="n">sc</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">numnames</span> <span class="o">+</span> <span class="n">numids</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="n">THEN</span>
     <span class="n">sc</span> <span class="o">=</span> <span class="n">sc</span> <span class="o">+</span> <span class="mi">1</span>
     <span class="n">IF</span> <span class="n">sc</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">so</span> <span class="o">+</span> <span class="mi">11</span><span class="p">)</span> <span class="n">THEN</span>
      <span class="n">so</span> <span class="o">=</span> <span class="n">sc</span> <span class="o">-</span> <span class="mi">11</span>
      <span class="n">IF</span> <span class="n">so</span> <span class="o">&gt;</span> <span class="n">sc</span> <span class="n">THEN</span> <span class="n">so</span> <span class="o">=</span> <span class="mi">0</span> <span class="c1">'unsigned</span>
     <span class="n">END</span> <span class="n">IF</span>
    <span class="n">END</span> <span class="n">IF</span>
   <span class="n">CASE</span> <span class="n">MKI</span><span class="err">$</span><span class="p">(</span><span class="o">&amp;</span><span class="n">H4700</span><span class="p">)</span> <span class="c1">'home</span>
    <span class="n">sc</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">so</span> <span class="o">=</span> <span class="mi">0</span>
   <span class="n">CASE</span> <span class="n">MKI</span><span class="err">$</span><span class="p">(</span><span class="o">&amp;</span><span class="n">H4F00</span><span class="p">)</span> <span class="c1">'end</span>
    <span class="n">sc</span> <span class="o">=</span> <span class="n">numnames</span> <span class="o">+</span> <span class="n">numids</span> <span class="o">-</span> <span class="mi">1</span>
    <span class="n">so</span> <span class="o">=</span> <span class="n">sc</span> <span class="o">-</span> <span class="mi">11</span>
    <span class="n">IF</span> <span class="n">so</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="n">THEN</span> <span class="n">so</span> <span class="o">=</span> <span class="mi">0</span>
   <span class="n">CASE</span> <span class="n">MKI</span><span class="err">$</span><span class="p">(</span><span class="o">&amp;</span><span class="n">H4900</span><span class="p">)</span> <span class="c1">'pgup</span>
    <span class="n">sc</span> <span class="o">=</span> <span class="n">sc</span> <span class="o">-</span> <span class="mi">12</span>
    <span class="n">so</span> <span class="o">=</span> <span class="n">so</span> <span class="o">-</span> <span class="mi">12</span>
    <span class="n">IF</span> <span class="n">sc</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="n">THEN</span> <span class="n">sc</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">IF</span> <span class="n">so</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="n">THEN</span> <span class="n">so</span> <span class="o">=</span> <span class="mi">0</span>
   <span class="n">CASE</span> <span class="n">MKI</span><span class="err">$</span><span class="p">(</span><span class="o">&amp;</span><span class="n">H5100</span><span class="p">)</span> <span class="c1">'pgdn</span>
    <span class="n">sc</span> <span class="o">=</span> <span class="n">sc</span> <span class="o">+</span> <span class="mi">12</span>
    <span class="n">IF</span> <span class="n">sc</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">numnames</span> <span class="o">+</span> <span class="n">numids</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="n">THEN</span> <span class="n">sc</span> <span class="o">=</span> <span class="n">numnames</span> <span class="o">+</span> <span class="n">numids</span> <span class="o">-</span> <span class="mi">1</span>
    <span class="n">so</span> <span class="o">=</span> <span class="n">sc</span> <span class="o">-</span> <span class="mi">11</span>
    <span class="n">IF</span> <span class="n">so</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="n">THEN</span> <span class="n">so</span> <span class="o">=</span> <span class="mi">0</span>
   <span class="n">CASE</span> <span class="n">CHR</span><span class="err">$</span><span class="p">(</span><span class="o">&amp;</span><span class="n">H8</span><span class="p">),</span> <span class="n">CHR</span><span class="err">$</span><span class="p">(</span><span class="o">&amp;</span><span class="n">H1B</span><span class="p">)</span> <span class="c1">'bksp, esc</span>
    <span class="n">EXIT</span> <span class="n">SUB</span>
   <span class="n">CASE</span> <span class="n">CHR</span><span class="err">$</span><span class="p">(</span><span class="o">&amp;</span><span class="n">HD</span><span class="p">)</span> <span class="c1">'enter</span>
    <span class="n">IF</span> <span class="n">sc</span> <span class="o">&lt;</span> <span class="n">numnames</span> <span class="n">THEN</span>
     <span class="n">dw</span> <span class="o">=</span> <span class="n">namsrva</span><span class="p">(</span><span class="n">sc</span><span class="p">)</span>
    <span class="n">ELSE</span>
     <span class="n">dw</span> <span class="o">=</span> <span class="n">idsrva</span><span class="p">(</span><span class="n">sc</span> <span class="o">-</span> <span class="n">numnames</span><span class="p">)</span>
    <span class="n">END</span> <span class="n">IF</span>
    <span class="n">IF</span> <span class="n">dw</span> <span class="n">AND</span> <span class="o">&amp;</span><span class="n">H80000000</span><span class="err">~</span><span class="o">&amp;</span> <span class="n">THEN</span>
     <span class="c1">'the spec says its an rva, but it seems to be an offset in the section/table</span>
     <span class="n">processtable</span> <span class="n">bs</span><span class="p">,</span> <span class="n">bs</span> <span class="o">+</span> <span class="p">(</span><span class="n">dw</span> <span class="n">AND</span> <span class="o">&amp;</span><span class="n">H7FFFFFFF</span><span class="o">&amp;</span><span class="p">),</span> <span class="n">level</span> <span class="o">+</span> <span class="mi">1</span>
     <span class="n">EXIT</span> <span class="n">DO</span>
    <span class="n">ELSE</span>
     <span class="c1">'the spec says its an rva, but it seems to be an offset in the section/table</span>
     <span class="n">dw</span> <span class="o">=</span> <span class="n">bs</span> <span class="o">+</span> <span class="n">dw</span>
     <span class="n">GET</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">dw</span><span class="p">,</span> <span class="n">dat</span>
     <span class="n">GET</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="o">+</span> <span class="mi">4</span> <span class="o">+</span> <span class="n">dw</span><span class="p">,</span> <span class="n">siz</span>
     <span class="n">CLS</span>
     <span class="n">LOCATE</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="c1">'qb64 seems to default to line 2</span>
     <span class="n">SEEK</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">rva2fp</span><span class="p">(</span><span class="n">dat</span><span class="p">)</span>
     <span class="n">FOR</span> <span class="n">dw</span> <span class="o">=</span> <span class="mi">1</span> <span class="n">TO</span> <span class="n">siz</span>
      <span class="n">IF</span> <span class="n">dw</span> <span class="o">&gt;</span> <span class="mi">400</span> <span class="n">THEN</span> <span class="n">EXIT</span> <span class="n">FOR</span>
      <span class="n">GET</span> <span class="mi">1</span><span class="p">,</span> <span class="p">,</span> <span class="n">b</span>
      <span class="n">SELECT</span> <span class="n">CASE</span> <span class="n">b</span>
       <span class="n">CASE</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">9</span> <span class="n">TO</span> <span class="o">&amp;</span><span class="n">HD</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">H1F</span><span class="p">:</span> <span class="n">PRINT</span> <span class="s">"."</span><span class="err">;</span>
       <span class="n">CASE</span> <span class="n">ELSE</span><span class="p">:</span> <span class="n">PRINT</span> <span class="n">CHR</span><span class="err">$</span><span class="p">(</span><span class="n">b</span><span class="p">)</span><span class="err">;</span>
      <span class="n">END</span> <span class="n">SELECT</span>
     <span class="n">NEXT</span>
     <span class="n">LOCATE</span> <span class="mi">24</span><span class="p">,</span> <span class="mi">1</span>
     <span class="n">PRINT</span> <span class="n">dword$</span><span class="p">(</span><span class="n">siz</span><span class="p">)</span> <span class="o">+</span> <span class="s">" bytes."</span><span class="err">;</span>
     <span class="n">LOCATE</span> <span class="mi">23</span><span class="p">,</span> <span class="mi">1</span>
     <span class="n">LINE</span> <span class="n">INPUT</span> <span class="s">"(leave blank to cancel) Output file? "</span><span class="err">;</span> <span class="n">k</span>

     <span class="c1">'     IF k = "v" THEN</span>
     <span class="c1">'      INPUT "width in pixels"; w</span>
     <span class="c1">'      SCREEN 13</span>
     <span class="c1">'      SEEK 1, 1 + rva2fp(dat)</span>
     <span class="c1">'      FOR dw = 1 TO siz</span>
     <span class="c1">'       IF dw \ w &gt;= 200 THEN EXIT FOR</span>
     <span class="c1">'       GET 1, , b</span>
     <span class="c1">'      PSET (dw MOD w, dw \ w), b</span>
     <span class="c1">'      NEXT</span>
     <span class="c1">'      SLEEP: DO: LOOP WHILE LEN(INKEY$)</span>
     <span class="c1">'      SCREEN 0</span>
     <span class="c1">'      WIDTH 80, 25</span>
     <span class="c1">'      VIEW PRINT</span>
     <span class="c1">'      CLS</span>
     <span class="c1">'     END IF</span>

     <span class="n">IF</span> <span class="n">LEN</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="n">THEN</span>
      <span class="n">IF</span> <span class="n">_FILEEXISTS</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="n">THEN</span>
       <span class="n">PRINT</span>
       <span class="n">PRINT</span> <span class="s">"File already exists."</span><span class="err">;</span>
      <span class="n">ELSE</span>
       <span class="n">OPEN</span> <span class="n">k</span> <span class="n">FOR</span> <span class="n">BINARY</span> <span class="n">AS</span> <span class="mi">2</span>
       <span class="n">SEEK</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">rva2fp</span><span class="p">(</span><span class="n">dat</span><span class="p">)</span>
       <span class="n">FOR</span> <span class="n">dw</span> <span class="o">=</span> <span class="mi">1</span> <span class="n">TO</span> <span class="n">siz</span>
        <span class="n">GET</span> <span class="mi">1</span><span class="p">,</span> <span class="p">,</span> <span class="n">b</span>
        <span class="n">PUT</span> <span class="mi">2</span><span class="p">,</span> <span class="p">,</span> <span class="n">b</span>
       <span class="n">NEXT</span>
       <span class="n">CLOSE</span> <span class="mi">2</span>
       <span class="n">PRINT</span>
       <span class="n">PRINT</span> <span class="s">"Done."</span><span class="err">;</span>
      <span class="n">END</span> <span class="n">IF</span>
      <span class="n">SLEEP</span><span class="p">:</span> <span class="n">DO</span><span class="p">:</span> <span class="n">LOOP</span> <span class="n">WHILE</span> <span class="n">LEN</span><span class="p">(</span><span class="n">INKEY</span><span class="err">$</span><span class="p">)</span>
     <span class="n">END</span> <span class="n">IF</span>
     <span class="n">EXIT</span> <span class="n">DO</span>
    <span class="n">END</span> <span class="n">IF</span>
  <span class="n">END</span> <span class="n">SELECT</span>
 <span class="n">LOOP</span>
<span class="n">LOOP</span>
<span class="n">END</span> <span class="n">SUB</span>

<span class="n">FUNCTION</span> <span class="n">word$</span> <span class="p">(</span><span class="n">w</span> <span class="n">AS</span> <span class="n">_UNSIGNED</span> <span class="n">INTEGER</span><span class="p">)</span>
<span class="n">DIM</span> <span class="n">t</span> <span class="n">AS</span> <span class="n">STRING</span>
<span class="n">t</span> <span class="o">=</span> <span class="n">LCASE</span><span class="err">$</span><span class="p">(</span><span class="n">HEX</span><span class="err">$</span><span class="p">(</span><span class="n">w</span><span class="p">))</span>
<span class="n">word</span> <span class="o">=</span> <span class="s">"0x"</span> <span class="o">+</span> <span class="n">STRING</span><span class="err">$</span><span class="p">(</span><span class="mi">4</span> <span class="o">-</span> <span class="n">LEN</span><span class="p">(</span><span class="n">t</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">H30</span><span class="p">)</span> <span class="o">+</span> <span class="n">t</span>
<span class="n">END</span> <span class="n">FUNCTION</span>

<span class="n">FUNCTION</span> <span class="n">dword$</span> <span class="p">(</span><span class="n">dw</span> <span class="n">AS</span> <span class="n">_UNSIGNED</span> <span class="n">LONG</span><span class="p">)</span>
<span class="n">DIM</span> <span class="n">t</span> <span class="n">AS</span> <span class="n">STRING</span>
<span class="n">t</span> <span class="o">=</span> <span class="n">LCASE</span><span class="err">$</span><span class="p">(</span><span class="n">HEX</span><span class="err">$</span><span class="p">(</span><span class="n">dw</span><span class="p">))</span>
<span class="n">dword</span> <span class="o">=</span> <span class="s">"0x"</span> <span class="o">+</span> <span class="n">STRING</span><span class="err">$</span><span class="p">(</span><span class="mi">8</span> <span class="o">-</span> <span class="n">LEN</span><span class="p">(</span><span class="n">t</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">H30</span><span class="p">)</span> <span class="o">+</span> <span class="n">t</span>
<span class="n">END</span> <span class="n">FUNCTION</span>

<span class="n">FUNCTION</span> <span class="n">rva2fp</span><span class="err">~</span><span class="o">&amp;</span> <span class="p">(</span><span class="n">rva</span> <span class="n">AS</span> <span class="n">_UNSIGNED</span> <span class="n">LONG</span><span class="p">)</span>
<span class="n">DIM</span> <span class="n">w</span> <span class="n">AS</span> <span class="n">_UNSIGNED</span> <span class="n">INTEGER</span>
<span class="n">FOR</span> <span class="n">w</span> <span class="o">=</span> <span class="mi">0</span> <span class="n">TO</span> <span class="n">NumberOfSections</span> <span class="o">-</span> <span class="mi">1</span>
 <span class="n">IF</span> <span class="n">rva</span> <span class="o">&lt;</span> <span class="n">secsva</span><span class="p">(</span><span class="n">w</span><span class="p">)</span> <span class="n">THEN</span> <span class="n">EXIT</span> <span class="n">FOR</span>
<span class="n">NEXT</span>
<span class="n">w</span> <span class="o">=</span> <span class="n">w</span> <span class="o">-</span> <span class="mi">1</span>
<span class="n">IF</span> <span class="n">w</span> <span class="o">&gt;</span> <span class="n">NumberOfSections</span> <span class="o">-</span> <span class="mi">1</span> <span class="n">THEN</span> <span class="n">PRINT</span> <span class="n">dword$</span><span class="p">(</span><span class="n">rva</span><span class="p">),</span> <span class="n">w</span><span class="p">:</span> <span class="n">SLEEP</span>
<span class="n">rva2fp</span> <span class="o">=</span> <span class="n">rva</span> <span class="o">+</span> <span class="p">(</span><span class="n">secsfp</span><span class="p">(</span><span class="n">w</span><span class="p">)</span> <span class="o">-</span> <span class="n">secsva</span><span class="p">(</span><span class="n">w</span><span class="p">))</span>
<span class="n">END</span> <span class="n">FUNCTION</span>

<span class="n">SUB</span> <span class="n">dump</span> <span class="p">(</span><span class="n">addr</span> <span class="n">AS</span> <span class="n">_UNSIGNED</span> <span class="n">LONG</span><span class="p">)</span>
<span class="n">DIM</span> <span class="n">t</span> <span class="n">AS</span> <span class="n">STRING</span>
<span class="n">DIM</span> <span class="n">dw</span> <span class="n">AS</span> <span class="n">_UNSIGNED</span> <span class="n">LONG</span>
<span class="n">DIM</span> <span class="n">ul</span> <span class="n">AS</span> <span class="n">_UNSIGNED</span> <span class="n">LONG</span>
<span class="n">DIM</span> <span class="n">b</span> <span class="n">AS</span> <span class="n">_UNSIGNED</span> <span class="n">_BYTE</span>

<span class="n">VIEW</span> <span class="n">PRINT</span>
<span class="n">ul</span> <span class="o">=</span> <span class="n">addr</span>
<span class="n">DO</span>
 <span class="n">COLOR</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">0</span>
 <span class="n">CLS</span> <span class="mi">0</span>
 <span class="n">SEEK</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">ul</span>
 <span class="n">FOR</span> <span class="n">dw</span> <span class="o">=</span> <span class="n">ul</span> <span class="n">TO</span> <span class="p">(</span><span class="n">ul</span> <span class="n">AND</span> <span class="o">&amp;</span><span class="n">HFFFFFFF0</span><span class="p">)</span> <span class="o">+</span> <span class="o">&amp;</span><span class="n">H15F</span>
  <span class="n">IF</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">ul</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">LOF</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="n">THEN</span> <span class="n">EXIT</span> <span class="n">FOR</span>
  <span class="n">GET</span> <span class="mi">1</span><span class="p">,</span> <span class="p">,</span> <span class="n">b</span>
  <span class="n">IF</span> <span class="p">(</span><span class="n">dw</span> <span class="n">AND</span> <span class="o">&amp;</span><span class="n">HF</span><span class="p">)</span> <span class="o">=</span> <span class="mi">0</span> <span class="n">THEN</span>
   <span class="n">t</span> <span class="o">=</span> <span class="n">LCASE</span><span class="err">$</span><span class="p">(</span><span class="n">HEX</span><span class="err">$</span><span class="p">(</span><span class="n">dw</span><span class="p">))</span>
   <span class="n">COLOR</span> <span class="mi">7</span>
   <span class="n">PRINT</span> <span class="n">STRING</span><span class="err">$</span><span class="p">(</span><span class="mi">8</span> <span class="o">-</span> <span class="n">LEN</span><span class="p">(</span><span class="n">t</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">H30</span><span class="p">)</span> <span class="o">+</span> <span class="n">t</span><span class="err">;</span> <span class="n">SPACE</span><span class="err">$</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="err">;</span>
  <span class="n">END</span> <span class="n">IF</span>
  <span class="n">IF</span> <span class="p">(</span><span class="n">dw</span> <span class="n">AND</span> <span class="o">&amp;</span><span class="n">H4</span><span class="p">)</span> <span class="n">THEN</span> <span class="n">COLOR</span> <span class="mi">3</span> <span class="n">ELSE</span> <span class="n">COLOR</span> <span class="mi">2</span>
  <span class="n">LOCATE</span> <span class="p">,</span> <span class="mi">14</span> <span class="o">+</span> <span class="p">((</span><span class="n">dw</span> <span class="n">AND</span> <span class="o">&amp;</span><span class="n">HF</span><span class="p">)</span> <span class="o">*</span> <span class="mi">3</span><span class="p">)</span>
  <span class="n">t</span> <span class="o">=</span> <span class="n">LCASE</span><span class="err">$</span><span class="p">(</span><span class="n">HEX</span><span class="err">$</span><span class="p">(</span><span class="n">b</span><span class="p">))</span>
  <span class="n">IF</span> <span class="n">b</span> <span class="o">&lt;</span> <span class="o">&amp;</span><span class="n">H10</span> <span class="n">THEN</span> <span class="n">PRINT</span> <span class="s">"0"</span> <span class="o">+</span> <span class="n">t</span><span class="err">;</span> <span class="n">ELSE</span> <span class="n">PRINT</span> <span class="n">t</span><span class="err">;</span>
  <span class="n">LOCATE</span> <span class="p">,</span> <span class="mi">65</span> <span class="o">+</span> <span class="p">(</span><span class="n">dw</span> <span class="n">AND</span> <span class="o">&amp;</span><span class="n">HF</span><span class="p">)</span>
  <span class="n">SELECT</span> <span class="n">CASE</span> <span class="n">b</span>
   <span class="n">CASE</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">9</span> <span class="n">TO</span> <span class="o">&amp;</span><span class="n">HD</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">H1F</span><span class="p">:</span> <span class="n">PRINT</span> <span class="s">"."</span><span class="err">;</span>
   <span class="n">CASE</span> <span class="n">ELSE</span><span class="p">:</span> <span class="n">PRINT</span> <span class="n">CHR</span><span class="err">$</span><span class="p">(</span><span class="n">b</span><span class="p">)</span><span class="err">;</span>
  <span class="n">END</span> <span class="n">SELECT</span>
 <span class="n">NEXT</span>
 <span class="n">PRINT</span>
 <span class="n">COLOR</span> <span class="mi">7</span>
 <span class="n">LINE</span> <span class="n">INPUT</span> <span class="s">"(leave blank to cancel) Address: 0x"</span><span class="err">;</span> <span class="n">t</span>
 <span class="n">IF</span> <span class="n">LTRIM</span><span class="err">$</span><span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="o">=</span> <span class="s">""</span> <span class="n">THEN</span> <span class="n">EXIT</span> <span class="n">DO</span>
 <span class="n">ul</span> <span class="o">=</span> <span class="n">VAL</span><span class="p">(</span><span class="s">"&amp;h"</span> <span class="o">+</span> <span class="n">t</span> <span class="o">+</span> <span class="s">"&amp;"</span><span class="p">)</span> <span class="n">AND</span> <span class="o">&amp;</span><span class="n">H7FFFFFFF</span>
<span class="n">LOOP</span>
<span class="n">END</span> <span class="n">SUB</span>

</code></pre></div></div>

<blockquote>
  <p>The .ICO format:</p>
</blockquote>

<ul>
  <li><a href="http://en.wikipedia.org/wiki/ICO_(file_format)">http://en.wikipedia.org/wiki/ICO_(file_format)</a></li>
  <li><a href="http://www.iconolog.org/info/icoFormat.html">http://www.iconolog.org/info/icoFormat.html</a></li>
  <li><a href="http://en.wikipedia.org/wiki/BMP_file_format">http://en.wikipedia.org/wiki/BMP_file_format</a></li>
</ul>

<blockquote>
  <p>Note that the BMP file header is excluded, but the DIB information header is included. My observations from using Resource Hacker on <em>c:\windows\notepad.exe</em>:</p>
</blockquote>

<blockquote>
  <p>Iâ€™ve downloaded Resource Hacker. Note that if you export the first icon of \windows\notepad.exe as a binary file, it is identical to the file exported from my program (verifiable with fc /b). However, if you export it as an icon file, Resource Hacker adds 22 bytes to the beginning of it, a 6 byte ICONDIR structure, and a 16 byte ICONDIRENTRY structure. Resource Hacker is getting this information from the Icon Group resource.</p>
</blockquote>

<blockquote>
  <p>If you export the Icon Group resource as a binary file, you will see that it starts with an ICONDIR structure specifying 9 images. It is followed by an array of 9 structures, 14 bytes each. The first 12 bytes are the same as an ICONDIRENTRY structure. (with a 2x Height difference). The last element, which would be a dword offset in a ICONDIRENTRY structure is instead a word index identifying the particular icon.</p>
</blockquote>

<blockquote>
  <p>You can see what I mean: Use Resource Hacker to export the Icon Group as a binary file, named rhig.bin:</p>
</blockquote>

<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
                          edit /78 rhig.bin 

</code></pre></div></div>

<blockquote>
  <p>Delete the first 6 bytes, and save it as rhigmod.bin.</p>
</blockquote>

<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
                          edit /14 rhigmod.bin 

</code></pre></div></div>

<blockquote>
  <p>and you can clearly see the array.</p>
</blockquote>

<blockquote>
  <p>Note that, according to:</p>
</blockquote>

<p><a href="http://www.iconolog.org/info/icoFormat.html">http://www.iconolog.org/info/icoFormat.html</a></p>

<blockquote>
  <p>There is supposed to be a 2x Height difference between the ICONDIRENTRY structure in the icon file, and the DIB header within the icon file, with the DIB header having 2x the Height. However, when Resource Hacker exported the Icon file, it put 2x the Height in the ICONDIRENTRY structure also, doubling it from the Icon Group data. Icons seem to be Type ID 0x3, and Icon Groups seem to be Type ID 0xe. This seems consistent with:</p>
</blockquote>

<p><a href="http://msdn.microsoft.com/en-us/library/ms648009(v=VS.85).aspx">http://msdn.microsoft.com/en-us/library/ms648009(v=VS.85).aspx</a></p>

<blockquote>
  <p>Iâ€™ll probably write some code in the next day or two to automate the process of extracting icons from a PE. My observations would need to be double checked before being relied upon. (as always)</p>
</blockquote>

<blockquote>
  <p>Regards, Michael Calkins</p>
</blockquote>

<h2 id="revision-3">Revision 3</h2>

<blockquote>
  <p>The addresses of the strings were also offsets from the start of the main table. So now, it should correctly display the names of named entries. It now displays the names of known Type IDs. It can now accept the PE file name as a command line parameter, so that you can press up, enter, from the cmd prompt to restart it without having to type the name again.</p>
</blockquote>

<blockquote>
  <p>Iâ€™ve moved the first horizontal line down 1 line. There is a minor optimization in that there is one less call to rva2fp.</p>
</blockquote>

<div class="language-vb highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="c1">'revision 20120316, michael calkins</span>
<span class="c1">'october 2011, michael calkins</span>
<span class="c1">'my code is public domain, but it's based on Microsoft's spec, so I'm not sure</span>
<span class="c1">'what kind of patents or copyrights apply.</span>
<span class="c1">'based on the Microsoft PE and COFF spec, Revision 8.2 - September 21, 2010</span>
<span class="c1">'http://msdn.microsoft.com/en-us/windows/hardware/gg463119.aspx</span>

<span class="c1">'bug fixes on 2012 03 16:</span>
<span class="c1">' changed NumberOfRvaAndSizes to an _unsigned long</span>
<span class="c1">' added _CONTROLCHR OFF to the dump sub, and replaced the select case</span>

<span class="n">DIM</span> <span class="n">nam</span> <span class="n">AS</span> <span class="n">STRING</span> <span class="o">*</span> <span class="mi">8</span>
<span class="n">DIM</span> <span class="n">fil</span> <span class="n">AS</span> <span class="n">STRING</span>
<span class="n">DIM</span> <span class="n">k</span> <span class="n">AS</span> <span class="n">STRING</span>
<span class="n">DIM</span> <span class="n">dw</span> <span class="n">AS</span> <span class="n">_UNSIGNED</span> <span class="n">LONG</span>
<span class="n">DIM</span> <span class="n">ul</span> <span class="n">AS</span> <span class="n">_UNSIGNED</span> <span class="n">LONG</span>
<span class="n">DIM</span> <span class="n">coff</span> <span class="n">AS</span> <span class="n">_UNSIGNED</span> <span class="n">LONG</span>
<span class="n">DIM</span> <span class="n">SectionTable</span> <span class="n">AS</span> <span class="n">_UNSIGNED</span> <span class="n">LONG</span>
<span class="n">DIM</span> <span class="n">ImageBase</span> <span class="n">AS</span> <span class="n">_UNSIGNED</span> <span class="n">LONG</span>
<span class="n">DIM</span> <span class="n">rsrc</span> <span class="n">AS</span> <span class="n">_UNSIGNED</span> <span class="n">LONG</span>
<span class="n">DIM</span> <span class="n">pe32plus</span> <span class="n">AS</span> <span class="n">LONG</span>
<span class="n">DIM</span> <span class="n">w</span> <span class="n">AS</span> <span class="n">_UNSIGNED</span> <span class="n">INTEGER</span>
<span class="n">DIM</span> <span class="n">SizeOfOptionalHeader</span> <span class="n">AS</span> <span class="n">_UNSIGNED</span> <span class="n">INTEGER</span>
<span class="n">DIM</span> <span class="n">SHARED</span> <span class="n">NumberOfSections</span> <span class="n">AS</span> <span class="n">_UNSIGNED</span> <span class="n">INTEGER</span>
<span class="n">DIM</span> <span class="n">NumberOfRvaAndSizes</span> <span class="n">AS</span> <span class="n">_UNSIGNED</span> <span class="n">LONG</span>

<span class="n">CLS</span>
<span class="n">fil</span> <span class="o">=</span> <span class="n">COMMAND</span><span class="err">$</span>
<span class="n">IF</span> <span class="n">LEN</span><span class="p">(</span><span class="n">fil</span><span class="p">)</span> <span class="o">=</span> <span class="mi">0</span> <span class="n">THEN</span> <span class="n">LINE</span> <span class="n">INPUT</span> <span class="s">"Name of the PE image to open? "</span><span class="err">;</span> <span class="n">fil</span>
<span class="n">IF</span> <span class="n">_FILEEXISTS</span><span class="p">(</span><span class="n">fil</span><span class="p">)</span> <span class="o">=</span> <span class="mi">0</span> <span class="n">THEN</span> <span class="n">PRINT</span> <span class="s">"File not found."</span><span class="p">:</span> <span class="n">END</span>
<span class="n">OPEN</span> <span class="n">fil</span> <span class="n">FOR</span> <span class="n">BINARY</span> <span class="n">ACCESS</span> <span class="n">READ</span> <span class="n">AS</span> <span class="mi">1</span>
<span class="n">GET</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="o">+</span> <span class="mi">0</span><span class="p">,</span> <span class="n">w</span>
<span class="n">IF</span> <span class="n">w</span> <span class="o">&lt;&gt;</span> <span class="o">&amp;</span><span class="n">H5A4D</span> <span class="n">THEN</span> <span class="n">PRINT</span> <span class="s">"No MZ signature."</span><span class="p">:</span> <span class="n">END</span>
<span class="n">GET</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="o">+</span> <span class="o">&amp;</span><span class="n">H3C</span><span class="p">,</span> <span class="n">dw</span>
<span class="n">coff</span> <span class="o">=</span> <span class="n">dw</span> <span class="o">+</span> <span class="mi">4</span>
<span class="n">GET</span> <span class="mi">1</span><span class="p">,</span> <span class="n">dw</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">dw</span>
<span class="n">IF</span> <span class="n">dw</span> <span class="o">&lt;&gt;</span> <span class="o">&amp;</span><span class="n">H4550</span><span class="o">&amp;</span> <span class="n">THEN</span> <span class="n">PRINT</span> <span class="s">"No PE signature."</span><span class="p">:</span> <span class="n">END</span>
<span class="n">GET</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">coff</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="n">NumberOfSections</span>
<span class="n">IF</span> <span class="n">NumberOfSections</span> <span class="o">=</span> <span class="mi">0</span> <span class="n">THEN</span> <span class="n">PRINT</span> <span class="s">"No sections."</span><span class="p">:</span> <span class="n">END</span>
<span class="n">PRINT</span> <span class="s">"NumberOfSections:"</span><span class="err">;</span> <span class="n">NumberOfSections</span>
<span class="n">DIM</span> <span class="n">SHARED</span> <span class="n">secsva</span><span class="p">(</span><span class="mi">0</span> <span class="n">TO</span> <span class="n">NumberOfSections</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="n">AS</span> <span class="n">_UNSIGNED</span> <span class="n">LONG</span>
<span class="n">DIM</span> <span class="n">SHARED</span> <span class="n">secsfp</span><span class="p">(</span><span class="mi">0</span> <span class="n">TO</span> <span class="n">NumberOfSections</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="n">AS</span> <span class="n">_UNSIGNED</span> <span class="n">LONG</span>
<span class="n">GET</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">coff</span> <span class="o">+</span> <span class="mi">16</span><span class="p">,</span> <span class="n">SizeOfOptionalHeader</span>
<span class="n">IF</span> <span class="n">SizeOfOptionalHeader</span> <span class="o">=</span> <span class="mi">0</span> <span class="n">THEN</span> <span class="n">PRINT</span> <span class="s">"No optional header."</span><span class="p">:</span> <span class="n">END</span>
<span class="n">PRINT</span> <span class="s">"SizeOfOptionalHeader:"</span><span class="p">,</span> <span class="n">SPACE</span><span class="err">$</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span><span class="err">;</span> <span class="n">word$</span><span class="p">(</span><span class="n">SizeOfOptionalHeader</span><span class="p">)</span>
<span class="n">GET</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">coff</span> <span class="o">+</span> <span class="mi">20</span><span class="p">,</span> <span class="n">w</span>
<span class="n">SELECT</span> <span class="n">CASE</span> <span class="n">w</span>
 <span class="n">CASE</span> <span class="o">&amp;</span><span class="n">H10B</span><span class="p">:</span> <span class="n">pe32plus</span> <span class="o">=</span> <span class="mi">0</span><span class="p">:</span> <span class="n">PRINT</span> <span class="s">"PE32"</span>
 <span class="n">CASE</span> <span class="o">&amp;</span><span class="n">H20B</span><span class="p">:</span> <span class="n">pe32plus</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span> <span class="n">PRINT</span> <span class="s">"PE32+"</span>
 <span class="n">CASE</span> <span class="n">ELSE</span><span class="p">:</span> <span class="n">PRINT</span> <span class="s">"Unknown Magic."</span><span class="p">:</span> <span class="n">END</span>
<span class="n">END</span> <span class="n">SELECT</span>
<span class="n">GET</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">coff</span> <span class="o">+</span> <span class="mi">20</span> <span class="o">+</span> <span class="mi">28</span> <span class="o">+</span> <span class="p">(</span><span class="o">-</span><span class="mi">4</span> <span class="n">AND</span> <span class="n">pe32plus</span><span class="p">),</span> <span class="n">ImageBase</span>
<span class="n">PRINT</span> <span class="s">"ImageBase:"</span><span class="p">,</span> <span class="s">""</span><span class="p">,</span> <span class="n">dword$</span><span class="p">(</span><span class="n">ImageBase</span><span class="p">)</span>
<span class="n">GET</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">coff</span> <span class="o">+</span> <span class="mi">20</span> <span class="o">+</span> <span class="mi">92</span> <span class="o">+</span> <span class="p">(</span><span class="mi">16</span> <span class="n">AND</span> <span class="n">pe32plus</span><span class="p">),</span> <span class="n">NumberOfRvaAndSizes</span>
<span class="n">IF</span> <span class="n">NumberOfRvaAndSizes</span> <span class="o">&lt;</span> <span class="mi">3</span> <span class="n">THEN</span> <span class="n">PRINT</span> <span class="s">"No resource table."</span><span class="p">:</span> <span class="n">END</span>
<span class="n">PRINT</span> <span class="s">"NumberOfRvaAndSizes:"</span><span class="err">;</span> <span class="n">NumberOfRvaAndSizes</span>
<span class="n">GET</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">coff</span> <span class="o">+</span> <span class="mi">20</span> <span class="o">+</span> <span class="mi">112</span> <span class="o">+</span> <span class="p">(</span><span class="mi">16</span> <span class="n">AND</span> <span class="n">pe32plus</span><span class="p">),</span> <span class="n">rsrc</span>
<span class="n">PRINT</span> <span class="s">"Rva of resource table:"</span><span class="p">,</span> <span class="n">dword$</span><span class="p">(</span><span class="n">rsrc</span><span class="p">)</span>
<span class="n">GET</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">coff</span> <span class="o">+</span> <span class="mi">20</span> <span class="o">+</span> <span class="mi">4</span> <span class="o">+</span> <span class="mi">112</span> <span class="o">+</span> <span class="p">(</span><span class="mi">16</span> <span class="n">AND</span> <span class="n">pe32plus</span><span class="p">),</span> <span class="n">dw</span>
<span class="n">PRINT</span> <span class="s">"Size of resource table:"</span><span class="p">,</span> <span class="n">dword$</span><span class="p">(</span><span class="n">dw</span><span class="p">)</span>
<span class="n">IF</span> <span class="p">(</span><span class="n">rsrc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span> <span class="n">OR</span> <span class="p">(</span><span class="n">dw</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span> <span class="n">THEN</span> <span class="n">PRINT</span> <span class="s">"No resource table."</span><span class="p">:</span> <span class="n">END</span>
<span class="n">SectionTable</span> <span class="o">=</span> <span class="n">coff</span> <span class="o">+</span> <span class="mi">20</span> <span class="o">+</span> <span class="n">SizeOfOptionalHeader</span>
<span class="n">PRINT</span> <span class="s">"section"</span><span class="p">,</span> <span class="s">"va"</span><span class="p">,</span> <span class="s">"file ptr"</span>
<span class="n">FOR</span> <span class="n">w</span> <span class="o">=</span> <span class="mi">0</span> <span class="n">TO</span> <span class="n">NumberOfSections</span> <span class="o">-</span> <span class="mi">1</span>
 <span class="n">GET</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">SectionTable</span> <span class="o">+</span> <span class="p">(</span><span class="mi">40</span> <span class="o">*</span> <span class="n">w</span><span class="p">),</span> <span class="n">nam</span>
 <span class="n">GET</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">SectionTable</span> <span class="o">+</span> <span class="mi">12</span> <span class="o">+</span> <span class="p">(</span><span class="mi">40</span> <span class="o">*</span> <span class="n">w</span><span class="p">),</span> <span class="n">ul</span>
 <span class="n">GET</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">SectionTable</span> <span class="o">+</span> <span class="mi">20</span> <span class="o">+</span> <span class="p">(</span><span class="mi">40</span> <span class="o">*</span> <span class="n">w</span><span class="p">),</span> <span class="n">dw</span>
 <span class="n">PRINT</span> <span class="n">nam</span><span class="p">,</span> <span class="n">dword$</span><span class="p">(</span><span class="n">ul</span><span class="p">),</span> <span class="n">dword$</span><span class="p">(</span><span class="n">dw</span><span class="p">)</span>
 <span class="n">secsva</span><span class="p">(</span><span class="n">w</span><span class="p">)</span> <span class="o">=</span> <span class="n">ul</span>
 <span class="n">secsfp</span><span class="p">(</span><span class="n">w</span><span class="p">)</span> <span class="o">=</span> <span class="n">dw</span>
<span class="n">NEXT</span>
<span class="n">PRINT</span>
<span class="n">PRINT</span> <span class="s">"Proceed? "</span><span class="err">;</span>
<span class="n">DO</span>
 <span class="n">k</span> <span class="o">=</span> <span class="n">LCASE</span><span class="err">$</span><span class="p">(</span><span class="n">INKEY</span><span class="err">$</span><span class="p">)</span>
 <span class="n">IF</span> <span class="n">k</span> <span class="o">=</span> <span class="s">"n"</span> <span class="n">THEN</span> <span class="n">PRINT</span> <span class="n">k</span><span class="p">:</span> <span class="n">END</span>
<span class="n">LOOP</span> <span class="n">UNTIL</span> <span class="n">k</span> <span class="o">=</span> <span class="s">"y"</span>
<span class="n">PRINT</span> <span class="n">k</span>
<span class="n">dw</span> <span class="o">=</span> <span class="n">rva2fp</span><span class="p">(</span><span class="n">rsrc</span><span class="p">)</span>
<span class="n">processtable</span> <span class="n">dw</span><span class="p">,</span> <span class="n">dw</span><span class="p">,</span> <span class="mi">0</span>
<span class="n">SYSTEM</span>

<span class="n">SUB</span> <span class="n">processtable</span> <span class="p">(</span><span class="n">bs</span> <span class="n">AS</span> <span class="n">_UNSIGNED</span> <span class="n">LONG</span><span class="p">,</span> <span class="n">addr</span> <span class="n">AS</span> <span class="n">_UNSIGNED</span> <span class="n">LONG</span><span class="p">,</span> <span class="n">level</span> <span class="n">AS</span> <span class="n">INTEGER</span><span class="p">)</span>
<span class="n">DIM</span> <span class="n">k</span> <span class="n">AS</span> <span class="n">STRING</span>
<span class="n">DIM</span> <span class="n">dw</span> <span class="n">AS</span> <span class="n">_UNSIGNED</span> <span class="n">LONG</span>
<span class="n">DIM</span> <span class="n">numnamest8</span> <span class="n">AS</span> <span class="n">_UNSIGNED</span> <span class="n">LONG</span>
<span class="n">DIM</span> <span class="n">dat</span> <span class="n">AS</span> <span class="n">_UNSIGNED</span> <span class="n">LONG</span>
<span class="n">DIM</span> <span class="n">siz</span> <span class="n">AS</span> <span class="n">_UNSIGNED</span> <span class="n">LONG</span>
<span class="n">DIM</span> <span class="n">so</span> <span class="n">AS</span> <span class="n">LONG</span>
<span class="n">DIM</span> <span class="n">sc</span> <span class="n">AS</span> <span class="n">LONG</span>
<span class="n">DIM</span> <span class="n">numnames</span> <span class="n">AS</span> <span class="n">_UNSIGNED</span> <span class="n">INTEGER</span>
<span class="n">DIM</span> <span class="n">numids</span> <span class="n">AS</span> <span class="n">_UNSIGNED</span> <span class="n">INTEGER</span>
<span class="n">DIM</span> <span class="n">w</span> <span class="n">AS</span> <span class="n">_UNSIGNED</span> <span class="n">INTEGER</span>
<span class="n">DIM</span> <span class="n">ln</span> <span class="n">AS</span> <span class="n">_UNSIGNED</span> <span class="n">INTEGER</span>
<span class="n">DIM</span> <span class="n">x</span> <span class="n">AS</span> <span class="n">_UNSIGNED</span> <span class="n">INTEGER</span>
<span class="n">DIM</span> <span class="n">y</span> <span class="n">AS</span> <span class="n">_UNSIGNED</span> <span class="n">INTEGER</span>
<span class="n">DIM</span> <span class="n">b</span> <span class="n">AS</span> <span class="n">_UNSIGNED</span> <span class="n">_BYTE</span>

<span class="n">GET</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">addr</span> <span class="o">+</span> <span class="mi">12</span><span class="p">,</span> <span class="n">numnames</span>
<span class="n">GET</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">addr</span> <span class="o">+</span> <span class="mi">14</span><span class="p">,</span> <span class="n">numids</span>
<span class="n">DIM</span> <span class="n">nams</span><span class="p">(</span><span class="mi">0</span> <span class="n">TO</span> <span class="n">numnames</span> <span class="o">+</span> <span class="p">(</span><span class="n">numnames</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">))</span> <span class="n">AS</span> <span class="n">STRING</span>
<span class="n">DIM</span> <span class="n">namsrva</span><span class="p">(</span><span class="mi">0</span> <span class="n">TO</span> <span class="n">numnames</span> <span class="o">+</span> <span class="p">(</span><span class="n">numnames</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">))</span> <span class="n">AS</span> <span class="n">_UNSIGNED</span> <span class="n">LONG</span>
<span class="n">DIM</span> <span class="n">ids</span><span class="p">(</span><span class="mi">0</span> <span class="n">TO</span> <span class="n">numids</span> <span class="o">+</span> <span class="p">(</span><span class="n">numids</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">))</span> <span class="n">AS</span> <span class="n">_UNSIGNED</span> <span class="n">LONG</span>
<span class="n">DIM</span> <span class="n">idsrva</span><span class="p">(</span><span class="mi">0</span> <span class="n">TO</span> <span class="n">numids</span> <span class="o">+</span> <span class="p">(</span><span class="n">numids</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">))</span> <span class="n">AS</span> <span class="n">_UNSIGNED</span> <span class="n">LONG</span>

<span class="c1">'get named entries</span>
<span class="n">FOR</span> <span class="n">x</span> <span class="o">=</span> <span class="mi">0</span> <span class="n">TO</span> <span class="n">numnames</span> <span class="o">-</span> <span class="mi">1</span>
 <span class="n">GET</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">addr</span> <span class="o">+</span> <span class="mi">16</span> <span class="o">+</span> <span class="p">(</span><span class="n">x</span> <span class="o">*</span> <span class="mi">8</span><span class="p">),</span> <span class="n">dw</span>
 <span class="c1">'the spec says its an rva, but it seems to be an offset in the section/table</span>
 <span class="c1">'low 31 bits are an offset from bs</span>
 <span class="n">GET</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">bs</span> <span class="o">+</span> <span class="p">(</span><span class="n">dw</span> <span class="n">AND</span> <span class="o">&amp;</span><span class="n">H7FFFFFFF</span><span class="p">),</span> <span class="n">ln</span>
 <span class="n">FOR</span> <span class="n">y</span> <span class="o">=</span> <span class="mi">0</span> <span class="n">TO</span> <span class="n">ln</span> <span class="o">-</span> <span class="mi">1</span>
  <span class="n">GET</span> <span class="mi">1</span><span class="p">,</span> <span class="p">,</span> <span class="n">w</span>
  <span class="n">SELECT</span> <span class="n">CASE</span> <span class="n">w</span>
   <span class="n">CASE</span> <span class="o">&amp;</span><span class="n">H20</span> <span class="n">TO</span> <span class="o">&amp;</span><span class="n">H7E</span><span class="p">:</span> <span class="n">nams</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">=</span> <span class="n">nams</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">+</span> <span class="n">CHR</span><span class="err">$</span><span class="p">(</span><span class="n">w</span><span class="p">)</span>
   <span class="n">CASE</span> <span class="n">ELSE</span><span class="p">:</span> <span class="n">nams</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">=</span> <span class="n">nams</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">+</span> <span class="n">CHR</span><span class="err">$</span><span class="p">(</span><span class="o">&amp;</span><span class="n">H1A</span><span class="p">)</span>
  <span class="n">END</span> <span class="n">SELECT</span>
  <span class="n">IF</span> <span class="n">y</span> <span class="o">=</span> <span class="mi">68</span> <span class="n">THEN</span> <span class="n">EXIT</span> <span class="n">FOR</span>
 <span class="n">NEXT</span>
 <span class="n">GET</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">addr</span> <span class="o">+</span> <span class="mi">16</span> <span class="o">+</span> <span class="mi">4</span> <span class="o">+</span> <span class="p">(</span><span class="n">x</span> <span class="o">*</span> <span class="mi">8</span><span class="p">),</span> <span class="n">namsrva</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="n">NEXT</span>

<span class="c1">'get numbered entries:</span>
<span class="n">numnamest8</span> <span class="o">=</span> <span class="n">numnames</span> <span class="o">*</span> <span class="mi">8</span>
<span class="n">FOR</span> <span class="n">x</span> <span class="o">=</span> <span class="mi">0</span> <span class="n">TO</span> <span class="n">numids</span> <span class="o">-</span> <span class="mi">1</span>
 <span class="n">GET</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">addr</span> <span class="o">+</span> <span class="mi">16</span> <span class="o">+</span> <span class="n">numnamest8</span> <span class="o">+</span> <span class="p">(</span><span class="n">x</span> <span class="o">*</span> <span class="mi">8</span><span class="p">),</span> <span class="n">ids</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
 <span class="n">GET</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">addr</span> <span class="o">+</span> <span class="mi">16</span> <span class="o">+</span> <span class="mi">4</span> <span class="o">+</span> <span class="n">numnamest8</span> <span class="o">+</span> <span class="p">(</span><span class="n">x</span> <span class="o">*</span> <span class="mi">8</span><span class="p">),</span> <span class="n">idsrva</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="n">NEXT</span>

<span class="c1">'display:</span>
<span class="n">VIEW</span> <span class="n">PRINT</span>
<span class="n">sc</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">so</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">DO</span>
 <span class="n">CLS</span> <span class="mi">0</span> <span class="c1">'qb64 bug? not locating to 1,1?</span>
 <span class="n">LOCATE</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span>
 <span class="n">SELECT</span> <span class="n">CASE</span> <span class="n">level</span>
  <span class="n">CASE</span> <span class="mi">0</span><span class="p">:</span> <span class="n">PRINT</span> <span class="s">"1st level - Type"</span><span class="err">;</span>
  <span class="n">CASE</span> <span class="mi">1</span><span class="p">:</span> <span class="n">PRINT</span> <span class="s">"2nd level - Name"</span><span class="err">;</span>
  <span class="n">CASE</span> <span class="mi">2</span><span class="p">:</span> <span class="n">PRINT</span> <span class="s">"3rd level - Language"</span><span class="err">;</span>
  <span class="n">CASE</span> <span class="n">ELSE</span><span class="p">:</span> <span class="n">PRINT</span> <span class="n">LTRIM</span><span class="err">$</span><span class="p">(</span><span class="n">STR</span><span class="err">$</span><span class="p">(</span><span class="n">level</span><span class="p">))</span> <span class="o">+</span> <span class="s">"th level"</span><span class="err">;</span>
 <span class="n">END</span> <span class="n">SELECT</span>
 <span class="n">PRINT</span> <span class="s">""</span><span class="p">,</span> <span class="s">"file ptr: "</span><span class="err">;</span> <span class="n">dword$</span><span class="p">(</span><span class="n">addr</span><span class="p">)</span><span class="err">;</span> <span class="s">". Press 'D' to dump."</span>
 <span class="n">PRINT</span> <span class="n">numnames</span><span class="err">;</span> <span class="s">"names in this level, in this branch."</span>
 <span class="n">PRINT</span> <span class="n">numids</span><span class="err">;</span> <span class="s">"IDs in this level, in this branch."</span>
 <span class="n">IF</span> <span class="p">(</span><span class="n">numnames</span> <span class="n">OR</span> <span class="n">numids</span><span class="p">)</span> <span class="o">=</span> <span class="mi">0</span> <span class="n">THEN</span>
  <span class="n">IF</span> <span class="n">level</span> <span class="n">THEN</span>
   <span class="n">PRINT</span> <span class="s">"Press any key to go up one level."</span>
   <span class="n">SLEEP</span><span class="p">:</span> <span class="n">DO</span><span class="p">:</span> <span class="n">LOOP</span> <span class="n">WHILE</span> <span class="n">LEN</span><span class="p">(</span><span class="n">INKEY</span><span class="err">$</span><span class="p">)</span>
   <span class="n">EXIT</span> <span class="n">SUB</span>
  <span class="n">ELSE</span>
   <span class="n">END</span>
  <span class="n">END</span> <span class="n">IF</span>
 <span class="n">END</span> <span class="n">IF</span>
 <span class="n">PRINT</span> <span class="s">"names are unicode. For simplicity, non ASCII chars will be shown as "</span> <span class="o">+</span> <span class="n">CHR</span><span class="err">$</span><span class="p">(</span><span class="o">&amp;</span><span class="n">H1A</span><span class="p">)</span> <span class="o">+</span> <span class="s">"."</span>
 <span class="n">IF</span> <span class="n">level</span> <span class="n">THEN</span>
  <span class="n">PRINT</span> <span class="s">"BKSP or ESC to go up one level."</span>
 <span class="n">ELSE</span>
  <span class="n">PRINT</span> <span class="s">"BKSP or ESC to exit."</span>
 <span class="n">END</span> <span class="n">IF</span>
 <span class="n">PRINT</span> <span class="s">"UP, DOWN, PGUP, PGDN, HOME, END to navigate list."</span>
 <span class="n">PRINT</span> <span class="s">"ENTER to select."</span>
 <span class="n">LOCATE</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">1</span>
 <span class="n">PRINT</span> <span class="n">STRING</span><span class="err">$</span><span class="p">(</span><span class="mi">80</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">HC4</span><span class="p">)</span><span class="err">;</span>
 <span class="n">LOCATE</span> <span class="mi">22</span><span class="p">,</span> <span class="mi">1</span>
 <span class="n">PRINT</span> <span class="n">STRING</span><span class="err">$</span><span class="p">(</span><span class="mi">80</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">HC4</span><span class="p">)</span><span class="err">;</span>
 <span class="n">DO</span>
  <span class="n">COLOR</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">0</span>
  <span class="n">LOCATE</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span> <span class="n">PRINT</span> <span class="n">dword$</span><span class="p">(</span><span class="n">sc</span><span class="p">)</span>
  <span class="n">FOR</span> <span class="n">x</span> <span class="o">=</span> <span class="mi">0</span> <span class="n">TO</span> <span class="mi">11</span>
   <span class="n">LOCATE</span> <span class="mi">10</span> <span class="o">+</span> <span class="n">x</span><span class="p">,</span> <span class="mi">1</span>
   <span class="n">IF</span> <span class="n">x</span> <span class="o">+</span> <span class="n">so</span> <span class="o">=</span> <span class="n">sc</span> <span class="n">THEN</span> <span class="n">COLOR</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">1</span> <span class="n">ELSE</span> <span class="n">COLOR</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">0</span>
   <span class="n">IF</span> <span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="n">so</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">numnames</span> <span class="n">THEN</span>
    <span class="n">PRINT</span> <span class="n">nams</span><span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="n">so</span><span class="p">)</span><span class="err">;</span> <span class="n">SPACE</span><span class="err">$</span><span class="p">(</span><span class="mi">70</span> <span class="o">-</span> <span class="n">LEN</span><span class="p">(</span><span class="n">nams</span><span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="n">so</span><span class="p">)))</span><span class="err">;</span>
    <span class="n">PRINT</span> <span class="n">dword$</span><span class="p">(</span><span class="n">bs</span> <span class="o">+</span> <span class="p">(</span><span class="n">namsrva</span><span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="n">so</span><span class="p">)</span> <span class="n">AND</span> <span class="o">&amp;</span><span class="n">H7FFFFFFF</span><span class="o">&amp;</span><span class="p">))</span><span class="err">;</span>
    <span class="n">COLOR</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">0</span>
    <span class="n">LOCATE</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">18</span>
    <span class="n">IF</span> <span class="n">namsrva</span><span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="n">so</span><span class="p">)</span> <span class="n">AND</span> <span class="o">&amp;</span><span class="n">H80000000</span><span class="err">~</span><span class="o">&amp;</span> <span class="n">THEN</span>
     <span class="n">PRINT</span> <span class="s">"(descend)"</span><span class="err">;</span>
    <span class="n">ELSE</span>
     <span class="n">PRINT</span> <span class="s">"(extract)"</span><span class="err">;</span>
    <span class="n">END</span> <span class="n">IF</span>
   <span class="n">ELSEIF</span> <span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="n">so</span><span class="p">)</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">numnames</span> <span class="o">+</span> <span class="n">numids</span><span class="p">)</span> <span class="n">THEN</span>
    <span class="n">PRINT</span> <span class="s">"ID: "</span> <span class="o">+</span> <span class="n">dword$</span><span class="p">(</span><span class="n">ids</span><span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="n">so</span> <span class="o">-</span> <span class="n">numnames</span><span class="p">))</span><span class="err">;</span>
    <span class="n">IF</span> <span class="n">level</span> <span class="o">=</span> <span class="mi">0</span> <span class="n">THEN</span>
     <span class="n">PRINT</span> <span class="s">" (RT_"</span><span class="err">;</span>
     <span class="c1">'derived from:</span>
     <span class="c1">' http://msdn.microsoft.com/en-us/library/ms648009(v=VS.85).aspx</span>
     <span class="n">SELECT</span> <span class="n">CASE</span> <span class="n">ids</span><span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="n">so</span> <span class="o">-</span> <span class="n">numnames</span><span class="p">)</span>
      <span class="n">CASE</span> <span class="mi">9</span><span class="p">:</span> <span class="n">PRINT</span> <span class="s">"ACCELERATOR"</span><span class="err">;</span>
      <span class="n">CASE</span> <span class="mi">21</span><span class="p">:</span> <span class="n">PRINT</span> <span class="s">"ANICURSOR"</span><span class="err">;</span>
      <span class="n">CASE</span> <span class="mi">22</span><span class="p">:</span> <span class="n">PRINT</span> <span class="s">"ANIICON"</span><span class="err">;</span>
      <span class="n">CASE</span> <span class="mi">2</span><span class="p">:</span> <span class="n">PRINT</span> <span class="s">"BITMAP"</span><span class="err">;</span>
      <span class="n">CASE</span> <span class="mi">1</span><span class="p">:</span> <span class="n">PRINT</span> <span class="s">"CURSOR"</span><span class="err">;</span>
      <span class="n">CASE</span> <span class="mi">5</span><span class="p">:</span> <span class="n">PRINT</span> <span class="s">"DIALOG"</span><span class="err">;</span>
      <span class="n">CASE</span> <span class="mi">17</span><span class="p">:</span> <span class="n">PRINT</span> <span class="s">"DLGINCLUDE"</span><span class="err">;</span>
      <span class="n">CASE</span> <span class="mi">8</span><span class="p">:</span> <span class="n">PRINT</span> <span class="s">"FONT"</span><span class="err">;</span>
      <span class="n">CASE</span> <span class="mi">7</span><span class="p">:</span> <span class="n">PRINT</span> <span class="s">"FONTDIR"</span><span class="err">;</span>
      <span class="n">CASE</span> <span class="mi">12</span><span class="p">:</span> <span class="n">PRINT</span> <span class="s">"GROUP_CURSOR"</span><span class="err">;</span>
      <span class="n">CASE</span> <span class="mi">14</span><span class="p">:</span> <span class="n">PRINT</span> <span class="s">"GROUP_ICON"</span><span class="err">;</span>
      <span class="n">CASE</span> <span class="mi">23</span><span class="p">:</span> <span class="n">PRINT</span> <span class="s">"HTML"</span><span class="err">;</span>
      <span class="n">CASE</span> <span class="mi">3</span><span class="p">:</span> <span class="n">PRINT</span> <span class="s">"ICON"</span><span class="err">;</span>
      <span class="n">CASE</span> <span class="mi">24</span><span class="p">:</span> <span class="n">PRINT</span> <span class="s">"MANIFEST"</span><span class="err">;</span>
      <span class="n">CASE</span> <span class="mi">4</span><span class="p">:</span> <span class="n">PRINT</span> <span class="s">"MENU"</span><span class="err">;</span>
      <span class="n">CASE</span> <span class="mi">11</span><span class="p">:</span> <span class="n">PRINT</span> <span class="s">"MESSAGETABLE"</span><span class="err">;</span>
      <span class="n">CASE</span> <span class="mi">19</span><span class="p">:</span> <span class="n">PRINT</span> <span class="s">"PLUGPLAY"</span><span class="err">;</span>
      <span class="n">CASE</span> <span class="mi">10</span><span class="p">:</span> <span class="n">PRINT</span> <span class="s">"RCDATA"</span><span class="err">;</span>
      <span class="n">CASE</span> <span class="mi">6</span><span class="p">:</span> <span class="n">PRINT</span> <span class="s">"STRING"</span><span class="err">;</span>
      <span class="n">CASE</span> <span class="mi">16</span><span class="p">:</span> <span class="n">PRINT</span> <span class="s">"VERSION"</span><span class="err">;</span>
      <span class="n">CASE</span> <span class="mi">20</span><span class="p">:</span> <span class="n">PRINT</span> <span class="s">"VXD"</span><span class="err">;</span>
     <span class="n">END</span> <span class="n">SELECT</span>
     <span class="n">PRINT</span> <span class="s">")"</span><span class="err">;</span>
    <span class="n">END</span> <span class="n">IF</span>
    <span class="n">PRINT</span> <span class="n">SPACE</span><span class="err">$</span><span class="p">(</span><span class="mi">71</span> <span class="o">-</span> <span class="n">POS</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span><span class="err">;</span>
    <span class="n">PRINT</span> <span class="n">dword$</span><span class="p">(</span><span class="n">bs</span> <span class="o">+</span> <span class="p">(</span><span class="n">idsrva</span><span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="n">so</span> <span class="o">-</span> <span class="n">numnames</span><span class="p">)))</span><span class="err">;</span>
    <span class="n">COLOR</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">0</span>
    <span class="n">LOCATE</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">18</span>
    <span class="n">IF</span> <span class="n">idsrva</span><span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="p">(</span><span class="n">so</span> <span class="o">-</span> <span class="n">numnames</span><span class="p">))</span> <span class="n">AND</span> <span class="o">&amp;</span><span class="n">H80000000</span><span class="err">~</span><span class="o">&amp;</span> <span class="n">THEN</span>
     <span class="n">PRINT</span> <span class="s">"(descend)"</span><span class="err">;</span>
    <span class="n">ELSE</span>
     <span class="n">PRINT</span> <span class="s">"(extract)"</span><span class="err">;</span>
    <span class="n">END</span> <span class="n">IF</span>
   <span class="n">ELSE</span>
    <span class="n">PRINT</span> <span class="n">SPACE</span><span class="err">$</span><span class="p">(</span><span class="mi">80</span><span class="p">)</span><span class="err">;</span>
   <span class="n">END</span> <span class="n">IF</span>
  <span class="n">NEXT</span>
  <span class="n">DO</span>
   <span class="n">k</span> <span class="o">=</span> <span class="n">INKEY</span><span class="err">$</span>
  <span class="n">LOOP</span> <span class="n">UNTIL</span> <span class="n">LEN</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
  <span class="n">SELECT</span> <span class="n">CASE</span> <span class="n">k</span>
   <span class="n">CASE</span> <span class="s">"d"</span><span class="p">,</span> <span class="s">"D"</span>
    <span class="n">dump</span> <span class="n">addr</span>
    <span class="n">EXIT</span> <span class="n">DO</span>
   <span class="n">CASE</span> <span class="n">MKI</span><span class="err">$</span><span class="p">(</span><span class="o">&amp;</span><span class="n">H4800</span><span class="p">)</span> <span class="c1">'up</span>
    <span class="n">IF</span> <span class="n">sc</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="n">THEN</span>
     <span class="n">sc</span> <span class="o">=</span> <span class="n">sc</span> <span class="o">-</span> <span class="mi">1</span>
     <span class="n">IF</span> <span class="n">sc</span> <span class="o">&lt;</span> <span class="n">so</span> <span class="n">THEN</span> <span class="n">so</span> <span class="o">=</span> <span class="n">sc</span>
    <span class="n">END</span> <span class="n">IF</span>
   <span class="n">CASE</span> <span class="n">MKI</span><span class="err">$</span><span class="p">(</span><span class="o">&amp;</span><span class="n">H5000</span><span class="p">)</span> <span class="c1">'down</span>
    <span class="n">IF</span> <span class="n">sc</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">numnames</span> <span class="o">+</span> <span class="n">numids</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="n">THEN</span>
     <span class="n">sc</span> <span class="o">=</span> <span class="n">sc</span> <span class="o">+</span> <span class="mi">1</span>
     <span class="n">IF</span> <span class="n">sc</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">so</span> <span class="o">+</span> <span class="mi">11</span><span class="p">)</span> <span class="n">THEN</span>
      <span class="n">so</span> <span class="o">=</span> <span class="n">sc</span> <span class="o">-</span> <span class="mi">11</span>
      <span class="n">IF</span> <span class="n">so</span> <span class="o">&gt;</span> <span class="n">sc</span> <span class="n">THEN</span> <span class="n">so</span> <span class="o">=</span> <span class="mi">0</span> <span class="c1">'unsigned</span>
     <span class="n">END</span> <span class="n">IF</span>
    <span class="n">END</span> <span class="n">IF</span>
   <span class="n">CASE</span> <span class="n">MKI</span><span class="err">$</span><span class="p">(</span><span class="o">&amp;</span><span class="n">H4700</span><span class="p">)</span> <span class="c1">'home</span>
    <span class="n">sc</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">so</span> <span class="o">=</span> <span class="mi">0</span>
   <span class="n">CASE</span> <span class="n">MKI</span><span class="err">$</span><span class="p">(</span><span class="o">&amp;</span><span class="n">H4F00</span><span class="p">)</span> <span class="c1">'end</span>
    <span class="n">sc</span> <span class="o">=</span> <span class="n">numnames</span> <span class="o">+</span> <span class="n">numids</span> <span class="o">-</span> <span class="mi">1</span>
    <span class="n">so</span> <span class="o">=</span> <span class="n">sc</span> <span class="o">-</span> <span class="mi">11</span>
    <span class="n">IF</span> <span class="n">so</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="n">THEN</span> <span class="n">so</span> <span class="o">=</span> <span class="mi">0</span>
   <span class="n">CASE</span> <span class="n">MKI</span><span class="err">$</span><span class="p">(</span><span class="o">&amp;</span><span class="n">H4900</span><span class="p">)</span> <span class="c1">'pgup</span>
    <span class="n">sc</span> <span class="o">=</span> <span class="n">sc</span> <span class="o">-</span> <span class="mi">12</span>
    <span class="n">so</span> <span class="o">=</span> <span class="n">so</span> <span class="o">-</span> <span class="mi">12</span>
    <span class="n">IF</span> <span class="n">sc</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="n">THEN</span> <span class="n">sc</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">IF</span> <span class="n">so</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="n">THEN</span> <span class="n">so</span> <span class="o">=</span> <span class="mi">0</span>
   <span class="n">CASE</span> <span class="n">MKI</span><span class="err">$</span><span class="p">(</span><span class="o">&amp;</span><span class="n">H5100</span><span class="p">)</span> <span class="c1">'pgdn</span>
    <span class="n">sc</span> <span class="o">=</span> <span class="n">sc</span> <span class="o">+</span> <span class="mi">12</span>
    <span class="n">IF</span> <span class="n">sc</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">numnames</span> <span class="o">+</span> <span class="n">numids</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="n">THEN</span> <span class="n">sc</span> <span class="o">=</span> <span class="n">numnames</span> <span class="o">+</span> <span class="n">numids</span> <span class="o">-</span> <span class="mi">1</span>
    <span class="n">so</span> <span class="o">=</span> <span class="n">sc</span> <span class="o">-</span> <span class="mi">11</span>
    <span class="n">IF</span> <span class="n">so</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="n">THEN</span> <span class="n">so</span> <span class="o">=</span> <span class="mi">0</span>
   <span class="n">CASE</span> <span class="n">CHR</span><span class="err">$</span><span class="p">(</span><span class="o">&amp;</span><span class="n">H8</span><span class="p">),</span> <span class="n">CHR</span><span class="err">$</span><span class="p">(</span><span class="o">&amp;</span><span class="n">H1B</span><span class="p">)</span> <span class="c1">'bksp, esc</span>
    <span class="n">EXIT</span> <span class="n">SUB</span>
   <span class="n">CASE</span> <span class="n">CHR</span><span class="err">$</span><span class="p">(</span><span class="o">&amp;</span><span class="n">HD</span><span class="p">)</span> <span class="c1">'enter</span>
    <span class="n">IF</span> <span class="n">sc</span> <span class="o">&lt;</span> <span class="n">numnames</span> <span class="n">THEN</span>
     <span class="n">dw</span> <span class="o">=</span> <span class="n">namsrva</span><span class="p">(</span><span class="n">sc</span><span class="p">)</span>
    <span class="n">ELSE</span>
     <span class="n">dw</span> <span class="o">=</span> <span class="n">idsrva</span><span class="p">(</span><span class="n">sc</span> <span class="o">-</span> <span class="n">numnames</span><span class="p">)</span>
    <span class="n">END</span> <span class="n">IF</span>
    <span class="n">IF</span> <span class="n">dw</span> <span class="n">AND</span> <span class="o">&amp;</span><span class="n">H80000000</span><span class="err">~</span><span class="o">&amp;</span> <span class="n">THEN</span>
     <span class="c1">'the spec says its an rva, but it seems to be an offset in the section/table</span>
     <span class="n">processtable</span> <span class="n">bs</span><span class="p">,</span> <span class="n">bs</span> <span class="o">+</span> <span class="p">(</span><span class="n">dw</span> <span class="n">AND</span> <span class="o">&amp;</span><span class="n">H7FFFFFFF</span><span class="o">&amp;</span><span class="p">),</span> <span class="n">level</span> <span class="o">+</span> <span class="mi">1</span>
     <span class="n">EXIT</span> <span class="n">DO</span>
    <span class="n">ELSE</span>
     <span class="c1">'the spec says its an rva, but it seems to be an offset in the section/table</span>
     <span class="n">dw</span> <span class="o">=</span> <span class="n">bs</span> <span class="o">+</span> <span class="n">dw</span>
     <span class="n">GET</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">dw</span><span class="p">,</span> <span class="n">dat</span>
     <span class="n">GET</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="o">+</span> <span class="mi">4</span> <span class="o">+</span> <span class="n">dw</span><span class="p">,</span> <span class="n">siz</span>
     <span class="n">CLS</span>
     <span class="n">LOCATE</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="c1">'qb64 seems to default to line 2</span>
     <span class="n">SEEK</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">rva2fp</span><span class="p">(</span><span class="n">dat</span><span class="p">)</span>
     <span class="n">FOR</span> <span class="n">dw</span> <span class="o">=</span> <span class="mi">1</span> <span class="n">TO</span> <span class="n">siz</span>
      <span class="n">IF</span> <span class="n">dw</span> <span class="o">&gt;</span> <span class="mi">400</span> <span class="n">THEN</span> <span class="n">EXIT</span> <span class="n">FOR</span>
      <span class="n">GET</span> <span class="mi">1</span><span class="p">,</span> <span class="p">,</span> <span class="n">b</span>
      <span class="n">SELECT</span> <span class="n">CASE</span> <span class="n">b</span>
       <span class="n">CASE</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">9</span> <span class="n">TO</span> <span class="o">&amp;</span><span class="n">HD</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">H1F</span><span class="p">:</span> <span class="n">PRINT</span> <span class="s">"."</span><span class="err">;</span>
       <span class="n">CASE</span> <span class="n">ELSE</span><span class="p">:</span> <span class="n">PRINT</span> <span class="n">CHR</span><span class="err">$</span><span class="p">(</span><span class="n">b</span><span class="p">)</span><span class="err">;</span>
      <span class="n">END</span> <span class="n">SELECT</span>
     <span class="n">NEXT</span>
     <span class="n">LOCATE</span> <span class="mi">24</span><span class="p">,</span> <span class="mi">1</span>
     <span class="n">PRINT</span> <span class="n">dword$</span><span class="p">(</span><span class="n">siz</span><span class="p">)</span> <span class="o">+</span> <span class="s">" bytes."</span><span class="err">;</span>
     <span class="n">LOCATE</span> <span class="mi">23</span><span class="p">,</span> <span class="mi">1</span>
     <span class="n">LINE</span> <span class="n">INPUT</span> <span class="s">"(leave blank to cancel) Output file? "</span><span class="err">;</span> <span class="n">k</span>
     <span class="n">IF</span> <span class="n">LEN</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="n">THEN</span>
      <span class="n">IF</span> <span class="n">_FILEEXISTS</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="n">THEN</span>
       <span class="n">PRINT</span>
       <span class="n">PRINT</span> <span class="s">"File already exists."</span><span class="err">;</span>
      <span class="n">ELSE</span>
       <span class="n">OPEN</span> <span class="n">k</span> <span class="n">FOR</span> <span class="n">BINARY</span> <span class="n">AS</span> <span class="mi">2</span>
       <span class="n">SEEK</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">rva2fp</span><span class="p">(</span><span class="n">dat</span><span class="p">)</span>
       <span class="n">FOR</span> <span class="n">dw</span> <span class="o">=</span> <span class="mi">1</span> <span class="n">TO</span> <span class="n">siz</span>
        <span class="n">GET</span> <span class="mi">1</span><span class="p">,</span> <span class="p">,</span> <span class="n">b</span>
        <span class="n">PUT</span> <span class="mi">2</span><span class="p">,</span> <span class="p">,</span> <span class="n">b</span>
       <span class="n">NEXT</span>
       <span class="n">CLOSE</span> <span class="mi">2</span>
       <span class="n">PRINT</span>
       <span class="n">PRINT</span> <span class="s">"Done."</span><span class="err">;</span>
      <span class="n">END</span> <span class="n">IF</span>
      <span class="n">SLEEP</span><span class="p">:</span> <span class="n">DO</span><span class="p">:</span> <span class="n">LOOP</span> <span class="n">WHILE</span> <span class="n">LEN</span><span class="p">(</span><span class="n">INKEY</span><span class="err">$</span><span class="p">)</span>
     <span class="n">END</span> <span class="n">IF</span>
     <span class="n">EXIT</span> <span class="n">DO</span>
    <span class="n">END</span> <span class="n">IF</span>
  <span class="n">END</span> <span class="n">SELECT</span>
 <span class="n">LOOP</span>
<span class="n">LOOP</span>
<span class="n">END</span> <span class="n">SUB</span>

<span class="n">FUNCTION</span> <span class="n">word$</span> <span class="p">(</span><span class="n">w</span> <span class="n">AS</span> <span class="n">_UNSIGNED</span> <span class="n">INTEGER</span><span class="p">)</span>
<span class="n">DIM</span> <span class="n">t</span> <span class="n">AS</span> <span class="n">STRING</span>
<span class="n">t</span> <span class="o">=</span> <span class="n">LCASE</span><span class="err">$</span><span class="p">(</span><span class="n">HEX</span><span class="err">$</span><span class="p">(</span><span class="n">w</span><span class="p">))</span>
<span class="n">word</span> <span class="o">=</span> <span class="s">"0x"</span> <span class="o">+</span> <span class="n">STRING</span><span class="err">$</span><span class="p">(</span><span class="mi">4</span> <span class="o">-</span> <span class="n">LEN</span><span class="p">(</span><span class="n">t</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">H30</span><span class="p">)</span> <span class="o">+</span> <span class="n">t</span>
<span class="n">END</span> <span class="n">FUNCTION</span>

<span class="n">FUNCTION</span> <span class="n">dword$</span> <span class="p">(</span><span class="n">dw</span> <span class="n">AS</span> <span class="n">_UNSIGNED</span> <span class="n">LONG</span><span class="p">)</span>
<span class="n">DIM</span> <span class="n">t</span> <span class="n">AS</span> <span class="n">STRING</span>
<span class="n">t</span> <span class="o">=</span> <span class="n">LCASE</span><span class="err">$</span><span class="p">(</span><span class="n">HEX</span><span class="err">$</span><span class="p">(</span><span class="n">dw</span><span class="p">))</span>
<span class="n">dword</span> <span class="o">=</span> <span class="s">"0x"</span> <span class="o">+</span> <span class="n">STRING</span><span class="err">$</span><span class="p">(</span><span class="mi">8</span> <span class="o">-</span> <span class="n">LEN</span><span class="p">(</span><span class="n">t</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">H30</span><span class="p">)</span> <span class="o">+</span> <span class="n">t</span>
<span class="n">END</span> <span class="n">FUNCTION</span>

<span class="n">FUNCTION</span> <span class="n">rva2fp</span><span class="err">~</span><span class="o">&amp;</span> <span class="p">(</span><span class="n">rva</span> <span class="n">AS</span> <span class="n">_UNSIGNED</span> <span class="n">LONG</span><span class="p">)</span>
<span class="n">DIM</span> <span class="n">w</span> <span class="n">AS</span> <span class="n">_UNSIGNED</span> <span class="n">INTEGER</span>
<span class="n">FOR</span> <span class="n">w</span> <span class="o">=</span> <span class="mi">0</span> <span class="n">TO</span> <span class="n">NumberOfSections</span> <span class="o">-</span> <span class="mi">1</span>
 <span class="n">IF</span> <span class="n">rva</span> <span class="o">&lt;</span> <span class="n">secsva</span><span class="p">(</span><span class="n">w</span><span class="p">)</span> <span class="n">THEN</span> <span class="n">EXIT</span> <span class="n">FOR</span>
<span class="n">NEXT</span>
<span class="n">w</span> <span class="o">=</span> <span class="n">w</span> <span class="o">-</span> <span class="mi">1</span>
<span class="n">IF</span> <span class="n">w</span> <span class="o">&gt;</span> <span class="n">NumberOfSections</span> <span class="o">-</span> <span class="mi">1</span> <span class="n">THEN</span> <span class="n">PRINT</span> <span class="n">dword$</span><span class="p">(</span><span class="n">rva</span><span class="p">),</span> <span class="n">w</span><span class="p">:</span> <span class="n">SLEEP</span>
<span class="n">rva2fp</span> <span class="o">=</span> <span class="n">rva</span> <span class="o">+</span> <span class="p">(</span><span class="n">secsfp</span><span class="p">(</span><span class="n">w</span><span class="p">)</span> <span class="o">-</span> <span class="n">secsva</span><span class="p">(</span><span class="n">w</span><span class="p">))</span>
<span class="n">END</span> <span class="n">FUNCTION</span>

<span class="n">SUB</span> <span class="n">dump</span> <span class="p">(</span><span class="n">addr</span> <span class="n">AS</span> <span class="n">_UNSIGNED</span> <span class="n">LONG</span><span class="p">)</span>
<span class="n">DIM</span> <span class="n">t</span> <span class="n">AS</span> <span class="n">STRING</span>
<span class="n">DIM</span> <span class="n">dw</span> <span class="n">AS</span> <span class="n">_UNSIGNED</span> <span class="n">LONG</span>
<span class="n">DIM</span> <span class="n">ul</span> <span class="n">AS</span> <span class="n">_UNSIGNED</span> <span class="n">LONG</span>
<span class="n">DIM</span> <span class="n">b</span> <span class="n">AS</span> <span class="n">_UNSIGNED</span> <span class="n">_BYTE</span>

<span class="n">_CONTROLCHR</span> <span class="n">OFF</span>
<span class="n">VIEW</span> <span class="n">PRINT</span>
<span class="n">ul</span> <span class="o">=</span> <span class="n">addr</span>
<span class="n">DO</span>
 <span class="n">COLOR</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">0</span>
 <span class="n">CLS</span> <span class="mi">0</span>
 <span class="n">SEEK</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">ul</span>
 <span class="n">FOR</span> <span class="n">dw</span> <span class="o">=</span> <span class="n">ul</span> <span class="n">TO</span> <span class="p">(</span><span class="n">ul</span> <span class="n">AND</span> <span class="o">&amp;</span><span class="n">HFFFFFFF0</span><span class="p">)</span> <span class="o">+</span> <span class="o">&amp;</span><span class="n">H15F</span>
  <span class="n">IF</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">ul</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">LOF</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="n">THEN</span> <span class="n">EXIT</span> <span class="n">FOR</span>
  <span class="n">GET</span> <span class="mi">1</span><span class="p">,</span> <span class="p">,</span> <span class="n">b</span>
  <span class="n">IF</span> <span class="p">(</span><span class="n">dw</span> <span class="n">AND</span> <span class="o">&amp;</span><span class="n">HF</span><span class="p">)</span> <span class="o">=</span> <span class="mi">0</span> <span class="n">THEN</span>
   <span class="n">t</span> <span class="o">=</span> <span class="n">LCASE</span><span class="err">$</span><span class="p">(</span><span class="n">HEX</span><span class="err">$</span><span class="p">(</span><span class="n">dw</span><span class="p">))</span>
   <span class="n">COLOR</span> <span class="mi">7</span>
   <span class="n">PRINT</span> <span class="n">STRING</span><span class="err">$</span><span class="p">(</span><span class="mi">8</span> <span class="o">-</span> <span class="n">LEN</span><span class="p">(</span><span class="n">t</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">H30</span><span class="p">)</span> <span class="o">+</span> <span class="n">t</span><span class="err">;</span> <span class="n">SPACE</span><span class="err">$</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="err">;</span>
  <span class="n">END</span> <span class="n">IF</span>
  <span class="n">IF</span> <span class="p">(</span><span class="n">dw</span> <span class="n">AND</span> <span class="o">&amp;</span><span class="n">H4</span><span class="p">)</span> <span class="n">THEN</span> <span class="n">COLOR</span> <span class="mi">3</span> <span class="n">ELSE</span> <span class="n">COLOR</span> <span class="mi">2</span>
  <span class="n">LOCATE</span> <span class="p">,</span> <span class="mi">14</span> <span class="o">+</span> <span class="p">((</span><span class="n">dw</span> <span class="n">AND</span> <span class="o">&amp;</span><span class="n">HF</span><span class="p">)</span> <span class="o">*</span> <span class="mi">3</span><span class="p">)</span>
  <span class="n">t</span> <span class="o">=</span> <span class="n">LCASE</span><span class="err">$</span><span class="p">(</span><span class="n">HEX</span><span class="err">$</span><span class="p">(</span><span class="n">b</span><span class="p">))</span>
  <span class="n">IF</span> <span class="n">b</span> <span class="o">&lt;</span> <span class="o">&amp;</span><span class="n">H10</span> <span class="n">THEN</span> <span class="n">PRINT</span> <span class="s">"0"</span> <span class="o">+</span> <span class="n">t</span><span class="err">;</span> <span class="n">ELSE</span> <span class="n">PRINT</span> <span class="n">t</span><span class="err">;</span>
  <span class="n">LOCATE</span> <span class="p">,</span> <span class="mi">65</span> <span class="o">+</span> <span class="p">(</span><span class="n">dw</span> <span class="n">AND</span> <span class="o">&amp;</span><span class="n">HF</span><span class="p">)</span>
  <span class="n">PRINT</span> <span class="n">CHR</span><span class="err">$</span><span class="p">(</span><span class="n">b</span><span class="p">)</span><span class="err">;</span>
 <span class="n">NEXT</span>
 <span class="n">PRINT</span>
 <span class="n">COLOR</span> <span class="mi">7</span>
 <span class="n">LINE</span> <span class="n">INPUT</span> <span class="s">"(leave blank to cancel) Address: 0x"</span><span class="err">;</span> <span class="n">t</span>
 <span class="n">IF</span> <span class="n">LTRIM</span><span class="err">$</span><span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="o">=</span> <span class="s">""</span> <span class="n">THEN</span> <span class="n">EXIT</span> <span class="n">DO</span>
 <span class="n">ul</span> <span class="o">=</span> <span class="n">VAL</span><span class="p">(</span><span class="s">"&amp;h"</span> <span class="o">+</span> <span class="n">t</span> <span class="o">+</span> <span class="s">"&amp;"</span><span class="p">)</span> <span class="n">AND</span> <span class="o">&amp;</span><span class="n">H7FFFFFFF</span>
<span class="n">LOOP</span>
<span class="n">END</span> <span class="n">SUB</span> 

</code></pre></div></div>

<h2 id="extract-icon">Extract Icon</h2>

<blockquote>
  <p>Here is a program to extract an icon from a PE file. You specify the PE file, the index of the icon group (the first is 0), the maximum width and colors, and the output file. It will try to find the best matching icon, and extract the icon from the first language. I had earlier said that Resource Hacker gets the information for the ICO header from the icon group data. It could, but it could also get the data from the DIB header. Resource Hacker seems to use several fields that are reserved according to:</p>
</blockquote>

<p><a href="http://www.iconolog.org/info/icoFormat.html">http://www.iconolog.org/info/icoFormat.html</a></p>

<blockquote>
  <p>I use some of those fields in the icon group data to select the best icon from the group.</p>
</blockquote>

<blockquote>
  <p><em>Notepad.exe</em> has 1 group of 9 icons: 48, 32, and 16 pixels; 32, 8, and 4 bpp each. The 4 bpp icons are the old fashioned ones. :-) I like both the old and new. <em>C:\Windows\System32\shell32.dll</em> and <em>pifmgr.dll</em> have numerous icons.</p>
</blockquote>

<div class="language-vb highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="c1">'revision date, last person to revise</span>
<span class="c1">'revision 20111101, michael calkins</span>
<span class="c1">'(derivitives may list sources of derivision)</span>

<span class="c1">'october 2011, michael calkins</span>
<span class="c1">'my code is public domain, but it's based on Microsoft's spec, so I'm not sure</span>
<span class="c1">'what kind of patents or copyrights apply.</span>
<span class="c1">'based on the Microsoft PE and COFF spec, Revision 8.2 - September 21, 2010</span>
<span class="c1">'http://msdn.microsoft.com/en-us/windows/hardware/gg463119.aspx</span>


<span class="n">DIM</span> <span class="n">fil</span> <span class="n">AS</span> <span class="n">STRING</span>
<span class="n">DIM</span> <span class="n">n</span> <span class="n">AS</span> <span class="n">LONG</span>
<span class="n">DIM</span> <span class="n">gi</span> <span class="n">AS</span> <span class="n">_UNSIGNED</span> <span class="n">LONG</span>
<span class="n">DIM</span> <span class="n">wi</span> <span class="n">AS</span> <span class="n">LONG</span>
<span class="n">DIM</span> <span class="n">bpp</span> <span class="n">AS</span> <span class="n">LONG</span>

<span class="n">fil</span> <span class="o">=</span> <span class="s">"\windows\notepad.exe"</span>

<span class="n">IF</span> <span class="n">LEN</span><span class="p">(</span><span class="n">fil</span><span class="p">)</span> <span class="o">=</span> <span class="mi">0</span> <span class="n">THEN</span> <span class="n">LINE</span> <span class="n">INPUT</span> <span class="n">fil</span>
<span class="n">gi</span> <span class="o">=</span> <span class="mi">0</span> <span class="c1">'first icon group is normally 0 in most EXE or DLL files      </span>
<span class="n">wi</span> <span class="o">=</span> <span class="mi">32</span> <span class="c1">'16 to 256 max width     '&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt; change settings for other sizes      </span>
<span class="n">bpp</span> <span class="o">=</span> <span class="mi">8</span> <span class="c1">'4 to 32 bit max color   '&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt; 4 bit may use older style images</span>
<span class="n">mode</span> <span class="o">=</span> <span class="mi">0</span> <span class="c1">' 0 = icon, 1 = bitmap</span>
<span class="n">del$</span> <span class="o">=</span> <span class="s">"delme.ico"</span> <span class="c1">'change file extension to .BMP with mode 1 for bitmaps</span>

<span class="n">IF</span> <span class="n">_FILEEXISTS</span><span class="p">(</span><span class="n">del$</span><span class="p">)</span> <span class="n">THEN</span> <span class="n">KILL</span> <span class="n">del$</span> <span class="c1">'this file will be erased.</span>
<span class="n">n</span> <span class="o">=</span> <span class="n">geticon</span><span class="p">(</span><span class="n">fil</span><span class="p">,</span> <span class="n">del$</span><span class="p">,</span> <span class="n">gi</span><span class="p">,</span> <span class="n">wi</span><span class="p">,</span> <span class="n">bpp</span><span class="p">,</span> <span class="n">mode</span><span class="p">)</span>
<span class="n">IF</span> <span class="n">n</span> <span class="n">THEN</span>
  <span class="n">PRINT</span> <span class="s">"error:"</span><span class="err">;</span> <span class="n">n</span><span class="p">,</span> <span class="n">geticonerror</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
  <span class="n">END</span>
<span class="n">ELSE</span>
  <span class="n">SHELL</span> <span class="n">_DONTWAIT</span> <span class="s">"mspaint "</span> <span class="o">+</span> <span class="n">del$</span>
<span class="n">END</span> <span class="n">IF</span>
<span class="n">SYSTEM</span>
<span class="c1">'               ---------------------------------------------------</span>

<span class="n">FUNCTION</span> <span class="n">geticon&amp;</span> <span class="p">(</span><span class="n">fin</span> <span class="n">AS</span> <span class="n">STRING</span><span class="p">,</span> <span class="n">fout</span> <span class="n">AS</span> <span class="n">STRING</span><span class="p">,</span> <span class="n">gi</span> <span class="n">AS</span> <span class="n">_UNSIGNED</span> <span class="n">LONG</span><span class="p">,</span> <span class="n">wi</span> <span class="n">AS</span> <span class="n">_UNSIGNED</span> <span class="n">LONG</span><span class="p">,</span> <span class="n">co</span> <span class="n">AS</span> <span class="n">_UNSIGNED</span> <span class="n">LONG</span><span class="p">,</span> <span class="n">m</span> <span class="n">AS</span> <span class="n">_UNSIGNED</span> <span class="n">LONG</span><span class="p">)</span>
<span class="c1">'function extracts the best matching icon from a specified icon group from</span>
<span class="c1">'a specified PE image, and saves it to a specified file in a specified format.</span>
<span class="c1">'extracts the first language.</span>

<span class="c1">'fil = input file name</span>
<span class="c1">'fout = output file name</span>
<span class="c1">'gi = the number of the Icon Group (0 is first)</span>
<span class="c1">'wi = the preferred width (width is given priority over color)</span>
<span class="c1">'co = the preferred bits per pixel</span>
<span class="c1">'m = mode (0 for .ico, nonzero for .bmp)</span>

<span class="c1">'returns 0 for success, nonzero for error.</span>

<span class="n">DIM</span> <span class="n">dw</span> <span class="n">AS</span> <span class="n">_UNSIGNED</span> <span class="n">LONG</span>
<span class="n">DIM</span> <span class="n">coff</span> <span class="n">AS</span> <span class="n">_UNSIGNED</span> <span class="n">LONG</span>
<span class="n">DIM</span> <span class="n">SectionTable</span> <span class="n">AS</span> <span class="n">_UNSIGNED</span> <span class="n">LONG</span>
<span class="n">DIM</span> <span class="n">pe32plus</span> <span class="n">AS</span> <span class="n">LONG</span>
<span class="n">DIM</span> <span class="n">bs</span> <span class="n">AS</span> <span class="n">_UNSIGNED</span> <span class="n">LONG</span>
<span class="n">DIM</span> <span class="n">addr</span> <span class="n">AS</span> <span class="n">_UNSIGNED</span> <span class="n">LONG</span>
<span class="n">DIM</span> <span class="n">nfin</span> <span class="n">AS</span> <span class="n">_UNSIGNED</span> <span class="n">LONG</span>
<span class="n">DIM</span> <span class="n">nfout</span> <span class="n">AS</span> <span class="n">_UNSIGNED</span> <span class="n">LONG</span>
<span class="n">DIM</span> <span class="n">numnamest8</span> <span class="n">AS</span> <span class="n">_UNSIGNED</span> <span class="n">LONG</span>
<span class="n">DIM</span> <span class="n">dat</span> <span class="n">AS</span> <span class="n">_UNSIGNED</span> <span class="n">LONG</span>
<span class="n">DIM</span> <span class="n">siz</span> <span class="n">AS</span> <span class="n">_UNSIGNED</span> <span class="n">LONG</span>
<span class="n">DIM</span> <span class="n">rva</span> <span class="n">AS</span> <span class="n">_UNSIGNED</span> <span class="n">LONG</span>
<span class="n">DIM</span> <span class="n">fp</span> <span class="n">AS</span> <span class="n">_UNSIGNED</span> <span class="n">LONG</span>
<span class="n">DIM</span> <span class="n">bc</span> <span class="n">AS</span> <span class="n">_UNSIGNED</span> <span class="n">LONG</span>
<span class="n">DIM</span> <span class="n">bw</span> <span class="n">AS</span> <span class="n">_UNSIGNED</span> <span class="n">LONG</span>
<span class="n">DIM</span> <span class="n">w</span> <span class="n">AS</span> <span class="n">_UNSIGNED</span> <span class="n">INTEGER</span>
<span class="n">DIM</span> <span class="n">SizeOfOptionalHeader</span> <span class="n">AS</span> <span class="n">_UNSIGNED</span> <span class="n">INTEGER</span>
<span class="n">DIM</span> <span class="n">NumberOfSections</span> <span class="n">AS</span> <span class="n">_UNSIGNED</span> <span class="n">INTEGER</span>
<span class="n">DIM</span> <span class="n">NumberOfRvaAndSizes</span> <span class="n">AS</span> <span class="n">_UNSIGNED</span> <span class="n">LONG</span>
<span class="n">DIM</span> <span class="n">numnames</span> <span class="n">AS</span> <span class="n">_UNSIGNED</span> <span class="n">INTEGER</span>
<span class="n">DIM</span> <span class="n">numids</span> <span class="n">AS</span> <span class="n">_UNSIGNED</span> <span class="n">INTEGER</span>
<span class="n">DIM</span> <span class="n">x</span> <span class="n">AS</span> <span class="n">_UNSIGNED</span> <span class="n">INTEGER</span>
<span class="n">DIM</span> <span class="n">y</span> <span class="n">AS</span> <span class="n">_UNSIGNED</span> <span class="n">INTEGER</span>
<span class="n">DIM</span> <span class="n">z</span> <span class="n">AS</span> <span class="n">_UNSIGNED</span> <span class="n">INTEGER</span>
<span class="n">DIM</span> <span class="n">b</span> <span class="n">AS</span> <span class="n">_UNSIGNED</span> <span class="n">_BYTE</span>

<span class="n">IF</span> <span class="n">_FILEEXISTS</span><span class="p">(</span><span class="n">fin</span><span class="p">)</span> <span class="o">=</span> <span class="mi">0</span> <span class="n">THEN</span> <span class="n">geticon</span> <span class="o">=</span> <span class="mi">1</span><span class="p">:</span> <span class="n">EXIT</span> <span class="n">FUNCTION</span>
<span class="n">nfin</span> <span class="o">=</span> <span class="n">FREEFILE</span>
<span class="n">OPEN</span> <span class="n">fin</span> <span class="n">FOR</span> <span class="n">BINARY</span> <span class="n">ACCESS</span> <span class="n">READ</span> <span class="n">AS</span> <span class="n">nfin</span>
<span class="n">GET</span> <span class="n">nfin</span><span class="p">,</span> <span class="mi">1</span> <span class="o">+</span> <span class="mi">0</span><span class="p">,</span> <span class="n">w</span>
<span class="n">IF</span> <span class="n">w</span> <span class="o">&lt;&gt;</span> <span class="o">&amp;</span><span class="n">H5A4D</span> <span class="n">THEN</span> <span class="n">geticon</span> <span class="o">=</span> <span class="mi">2</span><span class="p">:</span> <span class="n">CLOSE</span> <span class="n">nfin</span><span class="p">:</span> <span class="n">EXIT</span> <span class="n">FUNCTION</span>
<span class="n">GET</span> <span class="n">nfin</span><span class="p">,</span> <span class="mi">1</span> <span class="o">+</span> <span class="o">&amp;</span><span class="n">H3C</span><span class="p">,</span> <span class="n">dw</span>
<span class="n">coff</span> <span class="o">=</span> <span class="n">dw</span> <span class="o">+</span> <span class="mi">4</span>
<span class="n">GET</span> <span class="n">nfin</span><span class="p">,</span> <span class="n">dw</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">dw</span>
<span class="n">IF</span> <span class="n">dw</span> <span class="o">&lt;&gt;</span> <span class="o">&amp;</span><span class="n">H4550</span><span class="o">&amp;</span> <span class="n">THEN</span> <span class="n">geticon</span> <span class="o">=</span> <span class="mi">3</span><span class="p">:</span> <span class="n">CLOSE</span> <span class="n">nfin</span><span class="p">:</span> <span class="n">EXIT</span> <span class="n">FUNCTION</span>
<span class="n">GET</span> <span class="n">nfin</span><span class="p">,</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">coff</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="n">NumberOfSections</span>
<span class="n">IF</span> <span class="n">NumberOfSections</span> <span class="o">=</span> <span class="mi">0</span> <span class="n">THEN</span> <span class="n">geticon</span> <span class="o">=</span> <span class="mi">4</span><span class="p">:</span> <span class="n">CLOSE</span> <span class="n">nfin</span><span class="p">:</span> <span class="n">EXIT</span> <span class="n">FUNCTION</span>
<span class="n">DIM</span> <span class="n">secsva</span><span class="p">(</span><span class="mi">0</span> <span class="n">TO</span> <span class="n">NumberOfSections</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="n">AS</span> <span class="n">_UNSIGNED</span> <span class="n">LONG</span>
<span class="n">DIM</span> <span class="n">secsfp</span><span class="p">(</span><span class="mi">0</span> <span class="n">TO</span> <span class="n">NumberOfSections</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="n">AS</span> <span class="n">_UNSIGNED</span> <span class="n">LONG</span>
<span class="n">GET</span> <span class="n">nfin</span><span class="p">,</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">coff</span> <span class="o">+</span> <span class="mi">16</span><span class="p">,</span> <span class="n">SizeOfOptionalHeader</span>
<span class="n">IF</span> <span class="n">SizeOfOptionalHeader</span> <span class="o">=</span> <span class="mi">0</span> <span class="n">THEN</span> <span class="n">geticon</span> <span class="o">=</span> <span class="mi">5</span><span class="p">:</span> <span class="n">CLOSE</span> <span class="n">nfin</span><span class="p">:</span> <span class="n">EXIT</span> <span class="n">FUNCTION</span>
<span class="n">GET</span> <span class="n">nfin</span><span class="p">,</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">coff</span> <span class="o">+</span> <span class="mi">20</span><span class="p">,</span> <span class="n">w</span>
<span class="n">SELECT</span> <span class="n">CASE</span> <span class="n">w</span>
  <span class="n">CASE</span> <span class="o">&amp;</span><span class="n">H10B</span><span class="p">:</span> <span class="n">pe32plus</span> <span class="o">=</span> <span class="mi">0</span>
  <span class="n">CASE</span> <span class="o">&amp;</span><span class="n">H20B</span><span class="p">:</span> <span class="n">pe32plus</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
  <span class="n">CASE</span> <span class="n">ELSE</span><span class="p">:</span> <span class="n">geticon</span> <span class="o">=</span> <span class="mi">6</span><span class="p">:</span> <span class="n">CLOSE</span> <span class="n">nfin</span><span class="p">:</span> <span class="n">EXIT</span> <span class="n">FUNCTION</span>
<span class="n">END</span> <span class="n">SELECT</span>
<span class="n">GET</span> <span class="n">nfin</span><span class="p">,</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">coff</span> <span class="o">+</span> <span class="mi">20</span> <span class="o">+</span> <span class="mi">92</span> <span class="o">+</span> <span class="p">(</span><span class="mi">16</span> <span class="n">AND</span> <span class="n">pe32plus</span><span class="p">),</span> <span class="n">NumberOfRvaAndSizes</span>
<span class="n">IF</span> <span class="n">NumberOfRvaAndSizes</span> <span class="o">&lt;</span> <span class="mi">3</span> <span class="n">THEN</span> <span class="n">geticon</span> <span class="o">=</span> <span class="mi">7</span><span class="p">:</span> <span class="n">CLOSE</span> <span class="n">nfin</span><span class="p">:</span> <span class="n">EXIT</span> <span class="n">FUNCTION</span>
<span class="n">GET</span> <span class="n">nfin</span><span class="p">,</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">coff</span> <span class="o">+</span> <span class="mi">20</span> <span class="o">+</span> <span class="mi">112</span> <span class="o">+</span> <span class="p">(</span><span class="mi">16</span> <span class="n">AND</span> <span class="n">pe32plus</span><span class="p">),</span> <span class="n">bs</span>
<span class="n">GET</span> <span class="n">nfin</span><span class="p">,</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">coff</span> <span class="o">+</span> <span class="mi">20</span> <span class="o">+</span> <span class="mi">4</span> <span class="o">+</span> <span class="mi">112</span> <span class="o">+</span> <span class="p">(</span><span class="mi">16</span> <span class="n">AND</span> <span class="n">pe32plus</span><span class="p">),</span> <span class="n">dw</span>
<span class="n">IF</span> <span class="p">(</span><span class="n">bs</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span> <span class="n">OR</span> <span class="p">(</span><span class="n">dw</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span> <span class="n">THEN</span> <span class="n">geticon</span> <span class="o">=</span> <span class="mi">8</span><span class="p">:</span> <span class="n">CLOSE</span> <span class="n">nfin</span><span class="p">:</span> <span class="n">EXIT</span> <span class="n">FUNCTION</span>
<span class="n">SectionTable</span> <span class="o">=</span> <span class="n">coff</span> <span class="o">+</span> <span class="mi">20</span> <span class="o">+</span> <span class="n">SizeOfOptionalHeader</span>
<span class="n">FOR</span> <span class="n">w</span> <span class="o">=</span> <span class="mi">0</span> <span class="n">TO</span> <span class="n">NumberOfSections</span> <span class="o">-</span> <span class="mi">1</span>
  <span class="n">GET</span> <span class="n">nfin</span><span class="p">,</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">SectionTable</span> <span class="o">+</span> <span class="mi">12</span> <span class="o">+</span> <span class="p">(</span><span class="mi">40</span> <span class="o">*</span> <span class="n">w</span><span class="p">),</span> <span class="n">secsva</span><span class="p">(</span><span class="n">w</span><span class="p">)</span>
  <span class="n">GET</span> <span class="n">nfin</span><span class="p">,</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">SectionTable</span> <span class="o">+</span> <span class="mi">20</span> <span class="o">+</span> <span class="p">(</span><span class="mi">40</span> <span class="o">*</span> <span class="n">w</span><span class="p">),</span> <span class="n">secsfp</span><span class="p">(</span><span class="n">w</span><span class="p">)</span>
<span class="n">NEXT</span>

<span class="n">rva</span> <span class="o">=</span> <span class="n">bs</span>
<span class="n">GOSUB</span> <span class="n">rva2fp</span>
<span class="n">bs</span> <span class="o">=</span> <span class="n">fp</span>

<span class="n">addr</span> <span class="o">=</span> <span class="n">bs</span>
<span class="c1">'group icon, first level</span>
<span class="n">GET</span> <span class="n">nfin</span><span class="p">,</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">addr</span> <span class="o">+</span> <span class="mi">12</span><span class="p">,</span> <span class="n">numnames</span>
<span class="n">GET</span> <span class="n">nfin</span><span class="p">,</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">addr</span> <span class="o">+</span> <span class="mi">14</span><span class="p">,</span> <span class="n">numids</span>
<span class="n">numnamest8</span> <span class="o">=</span> <span class="n">numnames</span> <span class="o">*</span> <span class="mi">8</span>
<span class="n">FOR</span> <span class="n">x</span> <span class="o">=</span> <span class="mi">0</span> <span class="n">TO</span> <span class="n">numids</span> <span class="o">-</span> <span class="mi">1</span>
  <span class="n">GET</span> <span class="n">nfin</span><span class="p">,</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">addr</span> <span class="o">+</span> <span class="mi">16</span> <span class="o">+</span> <span class="n">numnamest8</span> <span class="o">+</span> <span class="p">(</span><span class="n">x</span> <span class="o">*</span> <span class="mi">8</span><span class="p">),</span> <span class="n">dw</span>
  <span class="n">IF</span> <span class="n">dw</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">HE</span> <span class="n">THEN</span>
    <span class="n">GET</span> <span class="n">nfin</span><span class="p">,</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">addr</span> <span class="o">+</span> <span class="mi">16</span> <span class="o">+</span> <span class="mi">4</span> <span class="o">+</span> <span class="n">numnamest8</span> <span class="o">+</span> <span class="p">(</span><span class="n">x</span> <span class="o">*</span> <span class="mi">8</span><span class="p">),</span> <span class="n">dw</span><span class="p">:</span> <span class="n">EXIT</span> <span class="n">FOR</span>
  <span class="n">END</span> <span class="n">IF</span>
<span class="n">NEXT</span>
<span class="n">IF</span> <span class="n">x</span> <span class="o">=</span> <span class="n">numids</span> <span class="n">THEN</span> <span class="n">geticon</span> <span class="o">=</span> <span class="mi">9</span><span class="p">:</span> <span class="n">CLOSE</span> <span class="n">nfin</span><span class="p">:</span> <span class="n">EXIT</span> <span class="n">FUNCTION</span>
<span class="n">IF</span> <span class="n">dw</span> <span class="n">AND</span> <span class="o">&amp;</span><span class="n">H80000000</span><span class="err">~</span><span class="o">&amp;</span> <span class="o">=</span> <span class="mi">0</span> <span class="n">THEN</span> <span class="n">geticon</span> <span class="o">=</span> <span class="mi">10</span><span class="p">:</span> <span class="n">CLOSE</span> <span class="n">nfin</span><span class="p">:</span> <span class="n">EXIT</span> <span class="n">FUNCTION</span>

<span class="n">addr</span> <span class="o">=</span> <span class="n">bs</span> <span class="o">+</span> <span class="p">(</span><span class="n">dw</span> <span class="n">AND</span> <span class="o">&amp;</span><span class="n">H7FFFFFFF</span><span class="o">&amp;</span><span class="p">)</span>
<span class="c1">'group icon, second level</span>
<span class="n">GET</span> <span class="n">nfin</span><span class="p">,</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">addr</span> <span class="o">+</span> <span class="mi">12</span><span class="p">,</span> <span class="n">numnames</span>
<span class="n">GET</span> <span class="n">nfin</span><span class="p">,</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">addr</span> <span class="o">+</span> <span class="mi">14</span><span class="p">,</span> <span class="n">numids</span>
<span class="n">IF</span> <span class="n">gi</span> <span class="o">&gt;=</span> <span class="n">numnames</span> <span class="o">+</span> <span class="n">numids</span> <span class="n">THEN</span> <span class="n">geticon</span> <span class="o">=</span> <span class="mi">11</span><span class="p">:</span> <span class="n">CLOSE</span> <span class="n">nfin</span><span class="p">:</span> <span class="n">EXIT</span> <span class="n">FUNCTION</span>
<span class="n">GET</span> <span class="n">nfin</span><span class="p">,</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">addr</span> <span class="o">+</span> <span class="mi">16</span> <span class="o">+</span> <span class="mi">4</span> <span class="o">+</span> <span class="p">(</span><span class="n">gi</span> <span class="o">*</span> <span class="mi">8</span><span class="p">),</span> <span class="n">dw</span>
<span class="n">IF</span> <span class="n">dw</span> <span class="n">AND</span> <span class="o">&amp;</span><span class="n">H80000000</span><span class="err">~</span><span class="o">&amp;</span> <span class="o">=</span> <span class="mi">0</span> <span class="n">THEN</span> <span class="n">geticon</span> <span class="o">=</span> <span class="mi">12</span><span class="p">:</span> <span class="n">CLOSE</span> <span class="n">nfin</span><span class="p">:</span> <span class="n">EXIT</span> <span class="n">FUNCTION</span>

<span class="n">addr</span> <span class="o">=</span> <span class="n">bs</span> <span class="o">+</span> <span class="p">(</span><span class="n">dw</span> <span class="n">AND</span> <span class="o">&amp;</span><span class="n">H7FFFFFFF</span><span class="o">&amp;</span><span class="p">)</span>
<span class="c1">'group icon, third level</span>
<span class="n">GET</span> <span class="n">nfin</span><span class="p">,</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">addr</span> <span class="o">+</span> <span class="mi">12</span><span class="p">,</span> <span class="n">numnames</span>
<span class="n">GET</span> <span class="n">nfin</span><span class="p">,</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">addr</span> <span class="o">+</span> <span class="mi">14</span><span class="p">,</span> <span class="n">numids</span>
<span class="n">IF</span> <span class="mi">0</span> <span class="o">=</span> <span class="p">(</span><span class="n">numnames</span> <span class="o">+</span> <span class="n">numids</span><span class="p">)</span> <span class="n">THEN</span> <span class="n">geticon</span> <span class="o">=</span> <span class="mi">13</span><span class="p">:</span> <span class="n">CLOSE</span> <span class="n">nfin</span><span class="p">:</span> <span class="n">EXIT</span> <span class="n">FUNCTION</span>
<span class="n">GET</span> <span class="n">nfin</span><span class="p">,</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">addr</span> <span class="o">+</span> <span class="mi">16</span> <span class="o">+</span> <span class="mi">4</span><span class="p">,</span> <span class="n">dw</span>
<span class="n">IF</span> <span class="n">dw</span> <span class="n">AND</span> <span class="o">&amp;</span><span class="n">H80000000</span><span class="err">~</span><span class="o">&amp;</span> <span class="n">THEN</span> <span class="n">geticon</span> <span class="o">=</span> <span class="mi">14</span><span class="p">:</span> <span class="n">CLOSE</span> <span class="n">nfin</span><span class="p">:</span> <span class="n">EXIT</span> <span class="n">FUNCTION</span>

<span class="c1">'search for best icon within icon group</span>
<span class="n">dw</span> <span class="o">=</span> <span class="n">bs</span> <span class="o">+</span> <span class="n">dw</span>
<span class="n">GET</span> <span class="n">nfin</span><span class="p">,</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">dw</span><span class="p">,</span> <span class="n">rva</span>
<span class="n">GET</span> <span class="n">nfin</span><span class="p">,</span> <span class="mi">1</span> <span class="o">+</span> <span class="mi">4</span> <span class="o">+</span> <span class="n">dw</span><span class="p">,</span> <span class="n">siz</span>
<span class="n">GOSUB</span> <span class="n">rva2fp</span>
<span class="n">dat</span> <span class="o">=</span> <span class="n">fp</span>
<span class="n">SEEK</span> <span class="n">nfin</span><span class="p">,</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">dat</span>
<span class="n">IF</span> <span class="n">siz</span> <span class="o">&lt;</span> <span class="mi">6</span> <span class="n">THEN</span> <span class="n">geticon</span> <span class="o">=</span> <span class="mi">15</span><span class="p">:</span> <span class="n">CLOSE</span> <span class="n">nfin</span><span class="p">:</span> <span class="n">EXIT</span> <span class="n">FUNCTION</span>
<span class="n">GET</span> <span class="n">nfin</span><span class="p">,</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">dat</span><span class="p">,</span> <span class="n">dw</span>
<span class="n">IF</span> <span class="n">dw</span> <span class="o">&lt;&gt;</span> <span class="o">&amp;</span><span class="n">H10000</span> <span class="n">THEN</span> <span class="n">geticon</span> <span class="o">=</span> <span class="mi">16</span><span class="p">:</span> <span class="n">CLOSE</span> <span class="n">nfin</span><span class="p">:</span> <span class="n">EXIT</span> <span class="n">FUNCTION</span>
<span class="n">GET</span> <span class="n">nfin</span><span class="p">,</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">dat</span> <span class="o">+</span> <span class="mi">4</span><span class="p">,</span> <span class="n">y</span>
<span class="n">IF</span> <span class="n">y</span> <span class="o">=</span> <span class="mi">0</span> <span class="n">THEN</span> <span class="n">geticon</span> <span class="o">=</span> <span class="mi">17</span><span class="p">:</span> <span class="n">CLOSE</span> <span class="n">nfin</span><span class="p">:</span> <span class="n">EXIT</span> <span class="n">FUNCTION</span>
<span class="n">IF</span> <span class="n">siz</span> <span class="o">&lt;</span> <span class="p">(</span><span class="mi">6</span> <span class="o">+</span> <span class="p">(</span><span class="n">y</span> <span class="o">*</span> <span class="mi">14</span><span class="p">))</span> <span class="n">THEN</span> <span class="n">geticon</span> <span class="o">=</span> <span class="mi">18</span><span class="p">:</span> <span class="n">CLOSE</span> <span class="n">nfin</span><span class="p">:</span> <span class="n">EXIT</span> <span class="n">FUNCTION</span>
<span class="n">bc</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">bw</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">FOR</span> <span class="n">x</span> <span class="o">=</span> <span class="mi">0</span> <span class="n">TO</span> <span class="n">y</span> <span class="o">-</span> <span class="mi">1</span>
  <span class="n">GET</span> <span class="n">nfin</span><span class="p">,</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">dat</span> <span class="o">+</span> <span class="mi">6</span> <span class="o">+</span> <span class="p">(</span><span class="n">x</span> <span class="o">*</span> <span class="mi">14</span><span class="p">),</span> <span class="n">b</span>
  <span class="n">IF</span> <span class="n">b</span> <span class="o">=</span> <span class="mi">0</span> <span class="n">THEN</span> <span class="n">b</span> <span class="o">=</span> <span class="mi">255</span>
  <span class="c1">'best width, then best color</span>
  <span class="n">IF</span> <span class="p">(</span><span class="n">b</span> <span class="o">&gt;=</span> <span class="n">bw</span><span class="p">)</span> <span class="n">AND</span> <span class="p">(</span><span class="n">b</span> <span class="o">&lt;=</span> <span class="n">wi</span><span class="p">)</span> <span class="n">THEN</span>
    <span class="n">GET</span> <span class="n">nfin</span><span class="p">,</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">dat</span> <span class="o">+</span> <span class="mi">6</span> <span class="o">+</span> <span class="p">(</span><span class="n">x</span> <span class="o">*</span> <span class="mi">14</span><span class="p">)</span> <span class="o">+</span> <span class="mi">6</span><span class="p">,</span> <span class="n">w</span>
    <span class="n">IF</span> <span class="p">((</span><span class="n">w</span> <span class="o">&gt;</span> <span class="n">bc</span><span class="p">)</span> <span class="n">OR</span> <span class="p">(</span><span class="n">b</span> <span class="o">&gt;</span> <span class="n">bw</span><span class="p">))</span> <span class="n">AND</span> <span class="p">(</span><span class="n">w</span> <span class="o">&lt;=</span> <span class="n">co</span><span class="p">)</span> <span class="n">THEN</span>
      <span class="n">bc</span> <span class="o">=</span> <span class="n">w</span>
      <span class="n">bw</span> <span class="o">=</span> <span class="n">b</span>
      <span class="n">GET</span> <span class="n">nfin</span><span class="p">,</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">dat</span> <span class="o">+</span> <span class="mi">6</span> <span class="o">+</span> <span class="p">(</span><span class="n">x</span> <span class="o">*</span> <span class="mi">14</span><span class="p">)</span> <span class="o">+</span> <span class="mi">12</span><span class="p">,</span> <span class="n">z</span>
    <span class="n">END</span> <span class="n">IF</span>
  <span class="n">END</span> <span class="n">IF</span>
<span class="n">NEXT</span>
<span class="n">IF</span> <span class="n">bc</span> <span class="o">=</span> <span class="mi">0</span> <span class="n">THEN</span> <span class="n">geticon</span> <span class="o">=</span> <span class="mi">19</span><span class="p">:</span> <span class="n">CLOSE</span> <span class="n">nfin</span><span class="p">:</span> <span class="n">EXIT</span> <span class="n">FUNCTION</span>

<span class="n">addr</span> <span class="o">=</span> <span class="n">bs</span>
<span class="c1">'icon, first level</span>
<span class="n">GET</span> <span class="n">nfin</span><span class="p">,</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">addr</span> <span class="o">+</span> <span class="mi">12</span><span class="p">,</span> <span class="n">numnames</span>
<span class="n">GET</span> <span class="n">nfin</span><span class="p">,</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">addr</span> <span class="o">+</span> <span class="mi">14</span><span class="p">,</span> <span class="n">numids</span>
<span class="n">numnamest8</span> <span class="o">=</span> <span class="n">numnames</span> <span class="o">*</span> <span class="mi">8</span>
<span class="n">FOR</span> <span class="n">x</span> <span class="o">=</span> <span class="mi">0</span> <span class="n">TO</span> <span class="n">numids</span> <span class="o">-</span> <span class="mi">1</span>
  <span class="n">GET</span> <span class="n">nfin</span><span class="p">,</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">addr</span> <span class="o">+</span> <span class="mi">16</span> <span class="o">+</span> <span class="n">numnamest8</span> <span class="o">+</span> <span class="p">(</span><span class="n">x</span> <span class="o">*</span> <span class="mi">8</span><span class="p">),</span> <span class="n">dw</span>
  <span class="n">IF</span> <span class="n">dw</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">H3</span> <span class="n">THEN</span>
    <span class="n">GET</span> <span class="n">nfin</span><span class="p">,</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">addr</span> <span class="o">+</span> <span class="mi">16</span> <span class="o">+</span> <span class="mi">4</span> <span class="o">+</span> <span class="n">numnamest8</span> <span class="o">+</span> <span class="p">(</span><span class="n">x</span> <span class="o">*</span> <span class="mi">8</span><span class="p">),</span> <span class="n">dw</span><span class="p">:</span> <span class="n">EXIT</span> <span class="n">FOR</span>
  <span class="n">END</span> <span class="n">IF</span>
<span class="n">NEXT</span>
<span class="n">IF</span> <span class="n">x</span> <span class="o">=</span> <span class="n">numids</span> <span class="n">THEN</span> <span class="n">geticon</span> <span class="o">=</span> <span class="mi">20</span><span class="p">:</span> <span class="n">CLOSE</span> <span class="n">nfin</span><span class="p">:</span> <span class="n">EXIT</span> <span class="n">FUNCTION</span>
<span class="n">IF</span> <span class="n">dw</span> <span class="n">AND</span> <span class="o">&amp;</span><span class="n">H80000000</span><span class="err">~</span><span class="o">&amp;</span> <span class="o">=</span> <span class="mi">0</span> <span class="n">THEN</span> <span class="n">geticon</span> <span class="o">=</span> <span class="mi">21</span><span class="p">:</span> <span class="n">CLOSE</span> <span class="n">nfin</span><span class="p">:</span> <span class="n">EXIT</span> <span class="n">FUNCTION</span>

<span class="n">addr</span> <span class="o">=</span> <span class="n">bs</span> <span class="o">+</span> <span class="p">(</span><span class="n">dw</span> <span class="n">AND</span> <span class="o">&amp;</span><span class="n">H7FFFFFFF</span><span class="o">&amp;</span><span class="p">)</span>
<span class="c1">'icon, second level</span>
<span class="n">GET</span> <span class="n">nfin</span><span class="p">,</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">addr</span> <span class="o">+</span> <span class="mi">12</span><span class="p">,</span> <span class="n">numnames</span>
<span class="n">GET</span> <span class="n">nfin</span><span class="p">,</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">addr</span> <span class="o">+</span> <span class="mi">14</span><span class="p">,</span> <span class="n">numids</span>
<span class="n">numnamest8</span> <span class="o">=</span> <span class="n">numnames</span> <span class="o">*</span> <span class="mi">8</span>
<span class="n">FOR</span> <span class="n">x</span> <span class="o">=</span> <span class="mi">0</span> <span class="n">TO</span> <span class="n">numids</span> <span class="o">-</span> <span class="mi">1</span>
  <span class="n">GET</span> <span class="n">nfin</span><span class="p">,</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">addr</span> <span class="o">+</span> <span class="mi">16</span> <span class="o">+</span> <span class="n">numnamest8</span> <span class="o">+</span> <span class="p">(</span><span class="n">x</span> <span class="o">*</span> <span class="mi">8</span><span class="p">),</span> <span class="n">dw</span>
  <span class="n">IF</span> <span class="n">dw</span> <span class="o">=</span> <span class="n">z</span> <span class="n">THEN</span>
    <span class="n">GET</span> <span class="n">nfin</span><span class="p">,</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">addr</span> <span class="o">+</span> <span class="mi">16</span> <span class="o">+</span> <span class="mi">4</span> <span class="o">+</span> <span class="n">numnamest8</span> <span class="o">+</span> <span class="p">(</span><span class="n">x</span> <span class="o">*</span> <span class="mi">8</span><span class="p">),</span> <span class="n">dw</span><span class="p">:</span> <span class="n">EXIT</span> <span class="n">FOR</span>
  <span class="n">END</span> <span class="n">IF</span>
<span class="n">NEXT</span>
<span class="n">IF</span> <span class="n">x</span> <span class="o">=</span> <span class="n">numids</span> <span class="n">THEN</span> <span class="n">geticon</span> <span class="o">=</span> <span class="mi">22</span><span class="p">:</span> <span class="n">CLOSE</span> <span class="n">nfin</span><span class="p">:</span> <span class="n">EXIT</span> <span class="n">FUNCTION</span>
<span class="n">IF</span> <span class="n">dw</span> <span class="n">AND</span> <span class="o">&amp;</span><span class="n">H80000000</span><span class="err">~</span><span class="o">&amp;</span> <span class="o">=</span> <span class="mi">0</span> <span class="n">THEN</span> <span class="n">geticon</span> <span class="o">=</span> <span class="mi">23</span><span class="p">:</span> <span class="n">CLOSE</span> <span class="n">nfin</span><span class="p">:</span> <span class="n">EXIT</span> <span class="n">FUNCTION</span>

<span class="n">addr</span> <span class="o">=</span> <span class="n">bs</span> <span class="o">+</span> <span class="p">(</span><span class="n">dw</span> <span class="n">AND</span> <span class="o">&amp;</span><span class="n">H7FFFFFFF</span><span class="o">&amp;</span><span class="p">)</span>
<span class="c1">'icon, third level</span>
<span class="n">GET</span> <span class="n">nfin</span><span class="p">,</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">addr</span> <span class="o">+</span> <span class="mi">12</span><span class="p">,</span> <span class="n">numnames</span>
<span class="n">GET</span> <span class="n">nfin</span><span class="p">,</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">addr</span> <span class="o">+</span> <span class="mi">14</span><span class="p">,</span> <span class="n">numids</span>
<span class="n">IF</span> <span class="mi">0</span> <span class="o">=</span> <span class="p">(</span><span class="n">numnames</span> <span class="o">+</span> <span class="n">numids</span><span class="p">)</span> <span class="n">THEN</span> <span class="n">geticon</span> <span class="o">=</span> <span class="mi">24</span><span class="p">:</span> <span class="n">CLOSE</span> <span class="n">nfin</span><span class="p">:</span> <span class="n">EXIT</span> <span class="n">FUNCTION</span>
<span class="n">GET</span> <span class="n">nfin</span><span class="p">,</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">addr</span> <span class="o">+</span> <span class="mi">16</span> <span class="o">+</span> <span class="mi">4</span><span class="p">,</span> <span class="n">dw</span>
<span class="n">IF</span> <span class="n">dw</span> <span class="n">AND</span> <span class="o">&amp;</span><span class="n">H80000000</span><span class="err">~</span><span class="o">&amp;</span> <span class="n">THEN</span> <span class="n">geticon</span> <span class="o">=</span> <span class="mi">25</span><span class="p">:</span> <span class="n">CLOSE</span> <span class="n">nfin</span><span class="p">:</span> <span class="n">EXIT</span> <span class="n">FUNCTION</span>

<span class="c1">'extract icon</span>
<span class="n">dw</span> <span class="o">=</span> <span class="n">bs</span> <span class="o">+</span> <span class="n">dw</span>
<span class="n">GET</span> <span class="n">nfin</span><span class="p">,</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">dw</span><span class="p">,</span> <span class="n">rva</span>
<span class="n">GET</span> <span class="n">nfin</span><span class="p">,</span> <span class="mi">1</span> <span class="o">+</span> <span class="mi">4</span> <span class="o">+</span> <span class="n">dw</span><span class="p">,</span> <span class="n">siz</span>
<span class="n">GOSUB</span> <span class="n">rva2fp</span>
<span class="n">dat</span> <span class="o">=</span> <span class="n">fp</span>
<span class="n">IF</span> <span class="n">_FILEEXISTS</span><span class="p">(</span><span class="n">fout</span><span class="p">)</span> <span class="n">THEN</span> <span class="n">geticon</span> <span class="o">=</span> <span class="mi">26</span><span class="p">:</span> <span class="n">CLOSE</span> <span class="n">nfin</span><span class="p">:</span> <span class="n">EXIT</span> <span class="n">FUNCTION</span>
<span class="n">nfout</span> <span class="o">=</span> <span class="n">FREEFILE</span>
<span class="n">OPEN</span> <span class="n">fout</span> <span class="n">FOR</span> <span class="n">BINARY</span> <span class="n">AS</span> <span class="n">nfout</span>
<span class="n">GET</span> <span class="n">nfin</span><span class="p">,</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">dat</span> <span class="o">+</span> <span class="mi">4</span><span class="p">,</span> <span class="n">dw</span> <span class="c1">'width, start 4 bytes into BMP header</span>
  <span class="n">IF</span> <span class="n">dw</span> <span class="o">&lt;</span> <span class="o">&amp;</span><span class="n">H100</span> <span class="n">THEN</span> <span class="n">wide</span> <span class="o">=</span> <span class="n">dw</span> <span class="n">ELSE</span> <span class="n">wide</span> <span class="o">=</span> <span class="n">wi</span>
<span class="n">GET</span> <span class="n">nfin</span><span class="p">,</span> <span class="p">,</span> <span class="n">dw</span> <span class="c1">'double height</span>
  <span class="n">IF</span> <span class="n">dw</span> <span class="o">&lt;</span> <span class="o">&amp;</span><span class="n">H1FF</span> <span class="n">THEN</span> <span class="n">high</span> <span class="o">=</span> <span class="n">dw</span> <span class="o">\</span> <span class="mi">2</span> <span class="n">ELSE</span> <span class="n">high</span> <span class="o">=</span> <span class="n">wi</span>
<span class="n">GET</span> <span class="n">nfin</span><span class="p">,</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">dat</span> <span class="o">+</span> <span class="mi">14</span><span class="p">,</span> <span class="n">w</span> <span class="c1">'bpp</span>
  <span class="n">IF</span> <span class="n">w</span> <span class="o">&lt;=</span> <span class="o">&amp;</span><span class="n">H20</span> <span class="n">THEN</span> <span class="n">bpp</span> <span class="o">=</span> <span class="n">w</span> <span class="n">ELSE</span> <span class="n">bpp</span> <span class="o">=</span> <span class="n">co</span>

<span class="n">IF</span> <span class="n">m</span> <span class="n">THEN</span>
  <span class="c1">'Create bitmap format pre-header info of 14 bytes</span>
  <span class="n">w</span> <span class="o">=</span> <span class="n">CVI</span><span class="p">(</span><span class="s">"BM"</span><span class="p">)</span>
  <span class="n">PUT</span> <span class="n">nfout</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">w</span> <span class="c1">'magic </span>
  <span class="n">IF</span> <span class="n">bpp</span> <span class="o">&lt;=</span> <span class="mi">8</span> <span class="n">THEN</span> <span class="n">pal</span> <span class="o">=</span> <span class="p">(</span><span class="mi">2</span> <span class="o">^</span> <span class="n">bpp</span><span class="p">)</span> <span class="o">*</span> <span class="mi">4</span><span class="p">:</span> <span class="n">pb</span> <span class="o">=</span> <span class="n">bpp</span> <span class="o">/</span> <span class="mi">8</span> <span class="n">ELSE</span> <span class="n">pal</span> <span class="o">=</span> <span class="mi">0</span><span class="p">:</span> <span class="n">pb</span> <span class="o">=</span> <span class="mi">3</span>
  <span class="n">dw</span> <span class="o">=</span> <span class="mi">54</span> <span class="o">+</span> <span class="p">(</span><span class="n">wide</span> <span class="o">*</span> <span class="n">high</span> <span class="o">*</span> <span class="n">pb</span><span class="p">)</span> <span class="o">+</span> <span class="n">pal</span> <span class="c1">'file size</span>
  <span class="n">PUT</span> <span class="n">nfout</span><span class="p">,</span> <span class="p">,</span> <span class="n">dw</span> <span class="c1">'file size</span>
  <span class="n">dw</span> <span class="o">=</span> <span class="mi">0</span>
  <span class="n">PUT</span> <span class="n">nfout</span><span class="p">,</span> <span class="p">,</span> <span class="n">dw</span> <span class="c1">'2 reserved  </span>
  <span class="n">dw</span> <span class="o">=</span> <span class="mi">54</span> <span class="o">+</span> <span class="n">pal</span> <span class="c1">'bitmap header offset + palette if used</span>
  <span class="n">PUT</span> <span class="n">nfout</span><span class="p">,</span> <span class="p">,</span> <span class="n">dw</span> <span class="c1">'data offset</span>
<span class="n">ELSE</span>
  <span class="c1">'Create icon format Icon header and Entry header</span>
  <span class="n">w</span> <span class="o">=</span> <span class="mi">0</span>
  <span class="n">PUT</span> <span class="n">nfout</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">w</span> <span class="c1">'reserved</span>
  <span class="n">w</span> <span class="o">=</span> <span class="mi">1</span> <span class="c1">'1 = icon, 2 = cursor(this could be set by mode value)</span>
  <span class="n">PUT</span> <span class="n">nfout</span><span class="p">,</span> <span class="p">,</span> <span class="n">w</span> <span class="c1">'resource id </span>
  <span class="n">PUT</span> <span class="n">nfout</span><span class="p">,</span> <span class="p">,</span> <span class="n">w</span> <span class="c1">'icon count is always one in this procedure </span>
  <span class="n">b</span> <span class="o">=</span> <span class="n">wide</span>
  <span class="n">PUT</span> <span class="n">nfout</span><span class="p">,</span> <span class="p">,</span> <span class="n">b</span> <span class="c1">'width in Entry header</span>
  <span class="n">b</span> <span class="o">=</span> <span class="n">high</span>
  <span class="n">PUT</span> <span class="n">nfout</span><span class="p">,</span> <span class="p">,</span> <span class="n">b</span> <span class="c1">'height</span>
  <span class="n">IF</span> <span class="n">bpp</span> <span class="o">&lt;</span> <span class="mi">8</span> <span class="n">THEN</span> <span class="n">b</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">^</span> <span class="n">bpp</span> <span class="n">ELSE</span> <span class="n">b</span> <span class="o">=</span> <span class="mi">0</span>
  <span class="n">PUT</span> <span class="n">nfout</span><span class="p">,</span> <span class="p">,</span> <span class="n">b</span> <span class="c1">'num of colors</span>
  <span class="n">b</span> <span class="o">=</span> <span class="mi">0</span><span class="p">:</span> <span class="n">w</span> <span class="o">=</span> <span class="mi">0</span>
  <span class="n">PUT</span> <span class="n">nfout</span><span class="p">,</span> <span class="p">,</span> <span class="n">b</span> <span class="c1">'reserved</span>
  <span class="n">PUT</span> <span class="n">nfout</span><span class="p">,</span> <span class="p">,</span> <span class="n">w</span> <span class="c1">'column hot spot for cursor</span>
  <span class="n">PUT</span> <span class="n">nfout</span><span class="p">,</span> <span class="p">,</span> <span class="n">w</span> <span class="c1">'row hot spot for cursor</span>
  <span class="n">PUT</span> <span class="n">nfout</span><span class="p">,</span> <span class="p">,</span> <span class="n">siz</span> <span class="c1">'size of data</span>
  <span class="n">dw</span> <span class="o">=</span> <span class="mi">22</span> <span class="c1">'offset of bmp header is 6 + 16 bytes</span>
  <span class="n">PUT</span> <span class="n">nfout</span><span class="p">,</span> <span class="p">,</span> <span class="n">dw</span>
<span class="n">END</span> <span class="n">IF</span>
<span class="n">SEEK</span> <span class="n">nfin</span><span class="p">,</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">dat</span> <span class="c1">'seek start of bmp 40 byte header</span>
<span class="n">IF</span> <span class="n">m</span> <span class="n">THEN</span>
  <span class="n">GET</span> <span class="n">nfin</span><span class="p">,</span> <span class="p">,</span> <span class="n">dw</span>
  <span class="n">PUT</span> <span class="n">nfout</span><span class="p">,</span> <span class="p">,</span> <span class="n">dw</span> <span class="c1">'header size</span>
  <span class="n">GET</span> <span class="n">nfin</span><span class="p">,</span> <span class="p">,</span> <span class="n">dw</span>
  <span class="n">dw</span> <span class="o">=</span> <span class="n">wide</span>
  <span class="n">PUT</span> <span class="n">nfout</span><span class="p">,</span> <span class="p">,</span> <span class="n">dw</span> <span class="c1">'width</span>
  <span class="n">dw</span> <span class="o">=</span> <span class="n">high</span>
  <span class="n">PUT</span> <span class="n">nfout</span><span class="p">,</span> <span class="p">,</span> <span class="n">dw</span> <span class="c1">'height</span>
  <span class="n">GET</span> <span class="n">nfin</span><span class="p">,</span> <span class="p">,</span> <span class="n">dw</span> <span class="c1">'ignore double height</span>
  <span class="n">siz</span> <span class="o">=</span> <span class="p">(</span><span class="n">wide</span> <span class="o">*</span> <span class="n">high</span> <span class="o">*</span> <span class="n">pb</span><span class="p">)</span> <span class="o">+</span> <span class="mi">28</span> <span class="o">+</span> <span class="n">pal</span> <span class="c1">'stop at AND mask</span>
<span class="n">END</span> <span class="n">IF</span>
<span class="n">FOR</span> <span class="n">dw</span> <span class="o">=</span> <span class="mi">1</span> <span class="n">TO</span> <span class="n">siz</span> <span class="c1">'GET remaining image data including </span>
  <span class="n">GET</span> <span class="n">nfin</span><span class="p">,</span> <span class="p">,</span> <span class="n">b</span> <span class="c1">'     'BMP header, palette and mask(s)</span>
  <span class="n">PUT</span> <span class="n">nfout</span><span class="p">,</span> <span class="p">,</span> <span class="n">b</span>
<span class="n">NEXT</span> <span class="n">dw</span>
<span class="n">CLOSE</span> <span class="n">nfout</span>
<span class="n">CLOSE</span> <span class="n">nfin</span>

<span class="n">geticon</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">EXIT</span> <span class="n">FUNCTION</span>

<span class="n">rva2fp</span><span class="p">:</span> <span class="c1">'call with rva returns fp modifies w</span>

<span class="n">FOR</span> <span class="n">w</span> <span class="o">=</span> <span class="mi">0</span> <span class="n">TO</span> <span class="n">NumberOfSections</span> <span class="o">-</span> <span class="mi">1</span>
  <span class="n">IF</span> <span class="n">rva</span> <span class="o">&lt;</span> <span class="n">secsva</span><span class="p">(</span><span class="n">w</span><span class="p">)</span> <span class="n">THEN</span> <span class="n">EXIT</span> <span class="n">FOR</span>
<span class="n">NEXT</span>
<span class="n">w</span> <span class="o">=</span> <span class="n">w</span> <span class="o">-</span> <span class="mi">1</span>
<span class="n">IF</span> <span class="n">w</span> <span class="o">&gt;</span> <span class="n">NumberOfSections</span> <span class="o">-</span> <span class="mi">1</span> <span class="n">THEN</span> <span class="n">geticon</span> <span class="o">=</span> <span class="mi">27</span><span class="p">:</span> <span class="n">CLOSE</span> <span class="n">nfin</span><span class="p">:</span> <span class="n">EXIT</span> <span class="n">FUNCTION</span>
<span class="n">fp</span> <span class="o">=</span> <span class="n">rva</span> <span class="o">+</span> <span class="p">(</span><span class="n">secsfp</span><span class="p">(</span><span class="n">w</span><span class="p">)</span> <span class="o">-</span> <span class="n">secsva</span><span class="p">(</span><span class="n">w</span><span class="p">))</span>
<span class="n">RETURN</span>

<span class="n">END</span> <span class="n">FUNCTION</span>

<span class="n">FUNCTION</span> <span class="n">geticonerror$</span> <span class="p">(</span><span class="n">n</span> <span class="n">AS</span> <span class="n">LONG</span><span class="p">)</span>
<span class="c1">'revision date, last person to revise revision 20111031, michael calkins</span>
<span class="c1">'(derivitives may list sources of derivision) october 2011, public domain, michael calkins</span>
<span class="n">SELECT</span> <span class="n">CASE</span> <span class="n">n</span>
  <span class="n">CASE</span> <span class="mi">0</span><span class="p">:</span> <span class="n">geticonerror</span> <span class="o">=</span> <span class="s">"success"</span>
  <span class="n">CASE</span> <span class="mi">1</span><span class="p">:</span> <span class="n">geticonerror</span> <span class="o">=</span> <span class="s">"input file not found"</span>
  <span class="n">CASE</span> <span class="mi">2</span><span class="p">:</span> <span class="n">geticonerror</span> <span class="o">=</span> <span class="s">"MZ signature not found"</span>
  <span class="n">CASE</span> <span class="mi">3</span><span class="p">:</span> <span class="n">geticonerror</span> <span class="o">=</span> <span class="s">"PE signature not found"</span>
  <span class="n">CASE</span> <span class="mi">4</span><span class="p">:</span> <span class="n">geticonerror</span> <span class="o">=</span> <span class="s">"no sections found"</span>
  <span class="n">CASE</span> <span class="mi">5</span><span class="p">:</span> <span class="n">geticonerror</span> <span class="o">=</span> <span class="s">"optional header not found"</span>
  <span class="n">CASE</span> <span class="mi">6</span><span class="p">:</span> <span class="n">geticonerror</span> <span class="o">=</span> <span class="s">"unknown PE optional header"</span>
  <span class="n">CASE</span> <span class="mi">7</span><span class="p">:</span> <span class="n">geticonerror</span> <span class="o">=</span> <span class="s">"no resource table"</span>
  <span class="n">CASE</span> <span class="mi">8</span><span class="p">:</span> <span class="n">geticonerror</span> <span class="o">=</span> <span class="s">"no resource table"</span>
  <span class="n">CASE</span> <span class="mi">9</span><span class="p">:</span> <span class="n">geticonerror</span> <span class="o">=</span> <span class="s">"icon groups not found"</span>
  <span class="n">CASE</span> <span class="mi">10</span><span class="p">:</span> <span class="n">geticonerror</span> <span class="o">=</span> <span class="s">"icon group: 1st level entry is a leaf"</span>
  <span class="n">CASE</span> <span class="mi">11</span><span class="p">:</span> <span class="n">geticonerror</span> <span class="o">=</span> <span class="s">"specified icon group not found"</span>
  <span class="n">CASE</span> <span class="mi">12</span><span class="p">:</span> <span class="n">geticonerror</span> <span class="o">=</span> <span class="s">"icon group: 2nd level entry is a leaf"</span>
  <span class="n">CASE</span> <span class="mi">13</span><span class="p">:</span> <span class="n">geticonerror</span> <span class="o">=</span> <span class="s">"no language for specified icon group"</span>
  <span class="n">CASE</span> <span class="mi">14</span><span class="p">:</span> <span class="n">geticonerror</span> <span class="o">=</span> <span class="s">"icon group: 3rd level entry is not a leaf"</span>
  <span class="n">CASE</span> <span class="mi">15</span><span class="p">:</span> <span class="n">geticonerror</span> <span class="o">=</span> <span class="s">"icon group data is too small"</span>
  <span class="n">CASE</span> <span class="mi">16</span><span class="p">:</span> <span class="n">geticonerror</span> <span class="o">=</span> <span class="s">"icon group data is not as expected"</span>
  <span class="n">CASE</span> <span class="mi">17</span><span class="p">:</span> <span class="n">geticonerror</span> <span class="o">=</span> <span class="s">"no icons in group"</span>
  <span class="n">CASE</span> <span class="mi">18</span><span class="p">:</span> <span class="n">geticonerror</span> <span class="o">=</span> <span class="s">"icon array is too small"</span>
  <span class="n">CASE</span> <span class="mi">19</span><span class="p">:</span> <span class="n">geticonerror</span> <span class="o">=</span> <span class="s">"could not find an icon matching the specifications"</span>
  <span class="n">CASE</span> <span class="mi">20</span><span class="p">:</span> <span class="n">geticonerror</span> <span class="o">=</span> <span class="s">"icons not found"</span>
  <span class="n">CASE</span> <span class="mi">21</span><span class="p">:</span> <span class="n">geticonerror</span> <span class="o">=</span> <span class="s">"icon: 1st level entry is a leaf"</span>
  <span class="n">CASE</span> <span class="mi">22</span><span class="p">:</span> <span class="n">geticonerror</span> <span class="o">=</span> <span class="s">"target icon not found"</span>
  <span class="n">CASE</span> <span class="mi">23</span><span class="p">:</span> <span class="n">geticonerror</span> <span class="o">=</span> <span class="s">"icon: 2nd level entry is a leaf"</span>
  <span class="n">CASE</span> <span class="mi">24</span><span class="p">:</span> <span class="n">geticonerror</span> <span class="o">=</span> <span class="s">"no language for target icon"</span>
  <span class="n">CASE</span> <span class="mi">25</span><span class="p">:</span> <span class="n">geticonerror</span> <span class="o">=</span> <span class="s">"icon: 3rd level is not a leaf"</span>
  <span class="n">CASE</span> <span class="mi">26</span><span class="p">:</span> <span class="n">geticonerror</span> <span class="o">=</span> <span class="s">"output file already exists"</span>
  <span class="n">CASE</span> <span class="mi">27</span><span class="p">:</span> <span class="n">geticonerror</span> <span class="o">=</span> <span class="s">"could not convert rva to fp"</span>
  <span class="n">CASE</span> <span class="n">ELSE</span><span class="p">:</span> <span class="n">geticonerror</span> <span class="o">=</span> <span class="s">"unknown error"</span>
<span class="n">END</span> <span class="n">SELECT</span>
<span class="n">END</span> <span class="n">FUNCTION</span> 

</code></pre></div></div>

<blockquote>
  <p><em>Note:</em> Change the file name to .BMP and mode to 1 to extract the icon as a bitmap for QB64 to use. QB64 cannot load icons!</p>
</blockquote>

<blockquote>
  <p>Have fun, and donâ€™t forget to double check it before relying on it. I appreciate bug reports, but Iâ€™m not responsible for errors.</p>
</blockquote>

<blockquote>
  <p>Regards, Michael Calkins</p>
</blockquote>

<h2 id="extract-resources">Extract Resources</h2>

<div class="language-vb highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="c1">'revision 20120316, michael calkins</span>
<span class="c1">'october 2011, michael calkins</span>
<span class="c1">'my code is public domain, but it's based on Microsoft's spec, so I'm not sure</span>
<span class="c1">'what kind of patents or copyrights apply.</span>
<span class="c1">'based on the Microsoft PE and COFF spec, Revision 8.2 - September 21, 2010</span>
<span class="c1">'http://msdn.microsoft.com/en-us/windows/hardware/gg463119.aspx</span>

<span class="c1">'bug fixes on 2012 03 16:</span>
<span class="c1">' changed NumberOfRvaAndSizes to an _unsigned long</span>
<span class="c1">' added _CONTROLCHR OFF to the dump sub, and replaced the select case</span>

<span class="n">DIM</span> <span class="n">nam</span> <span class="n">AS</span> <span class="n">STRING</span> <span class="o">*</span> <span class="mi">8</span>
<span class="n">DIM</span> <span class="n">fil</span> <span class="n">AS</span> <span class="n">STRING</span>
<span class="n">DIM</span> <span class="n">k</span> <span class="n">AS</span> <span class="n">STRING</span>
<span class="n">DIM</span> <span class="n">dw</span> <span class="n">AS</span> <span class="n">_UNSIGNED</span> <span class="n">LONG</span>
<span class="n">DIM</span> <span class="n">ul</span> <span class="n">AS</span> <span class="n">_UNSIGNED</span> <span class="n">LONG</span>
<span class="n">DIM</span> <span class="n">coff</span> <span class="n">AS</span> <span class="n">_UNSIGNED</span> <span class="n">LONG</span>
<span class="n">DIM</span> <span class="n">SectionTable</span> <span class="n">AS</span> <span class="n">_UNSIGNED</span> <span class="n">LONG</span>
<span class="n">DIM</span> <span class="n">ImageBase</span> <span class="n">AS</span> <span class="n">_UNSIGNED</span> <span class="n">LONG</span>
<span class="n">DIM</span> <span class="n">rsrc</span> <span class="n">AS</span> <span class="n">_UNSIGNED</span> <span class="n">LONG</span>
<span class="n">DIM</span> <span class="n">pe32plus</span> <span class="n">AS</span> <span class="n">LONG</span>
<span class="n">DIM</span> <span class="n">w</span> <span class="n">AS</span> <span class="n">_UNSIGNED</span> <span class="n">INTEGER</span>
<span class="n">DIM</span> <span class="n">SizeOfOptionalHeader</span> <span class="n">AS</span> <span class="n">_UNSIGNED</span> <span class="n">INTEGER</span>
<span class="n">DIM</span> <span class="n">SHARED</span> <span class="n">NumberOfSections</span> <span class="n">AS</span> <span class="n">_UNSIGNED</span> <span class="n">INTEGER</span>
<span class="n">DIM</span> <span class="n">NumberOfRvaAndSizes</span> <span class="n">AS</span> <span class="n">_UNSIGNED</span> <span class="n">LONG</span>

<span class="n">CLS</span>
<span class="n">fil</span> <span class="o">=</span> <span class="n">COMMAND</span><span class="err">$</span>
<span class="n">IF</span> <span class="n">LEN</span><span class="p">(</span><span class="n">fil</span><span class="p">)</span> <span class="o">=</span> <span class="mi">0</span> <span class="n">THEN</span> <span class="n">LINE</span> <span class="n">INPUT</span> <span class="s">"Name of the PE image to open? "</span><span class="err">;</span> <span class="n">fil</span>
<span class="n">IF</span> <span class="n">_FILEEXISTS</span><span class="p">(</span><span class="n">fil</span><span class="p">)</span> <span class="o">=</span> <span class="mi">0</span> <span class="n">THEN</span> <span class="n">PRINT</span> <span class="s">"File not found."</span><span class="p">:</span> <span class="n">END</span>
<span class="n">OPEN</span> <span class="n">fil</span> <span class="n">FOR</span> <span class="n">BINARY</span> <span class="n">ACCESS</span> <span class="n">READ</span> <span class="n">AS</span> <span class="mi">1</span>
<span class="n">GET</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="o">+</span> <span class="mi">0</span><span class="p">,</span> <span class="n">w</span>
<span class="n">IF</span> <span class="n">w</span> <span class="o">&lt;&gt;</span> <span class="o">&amp;</span><span class="n">H5A4D</span> <span class="n">THEN</span> <span class="n">PRINT</span> <span class="s">"No MZ signature."</span><span class="p">:</span> <span class="n">END</span>
<span class="n">GET</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="o">+</span> <span class="o">&amp;</span><span class="n">H3C</span><span class="p">,</span> <span class="n">dw</span>
<span class="n">coff</span> <span class="o">=</span> <span class="n">dw</span> <span class="o">+</span> <span class="mi">4</span>
<span class="n">GET</span> <span class="mi">1</span><span class="p">,</span> <span class="n">dw</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">dw</span>
<span class="n">IF</span> <span class="n">dw</span> <span class="o">&lt;&gt;</span> <span class="o">&amp;</span><span class="n">H4550</span><span class="o">&amp;</span> <span class="n">THEN</span> <span class="n">PRINT</span> <span class="s">"No PE signature."</span><span class="p">:</span> <span class="n">END</span>
<span class="n">GET</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">coff</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="n">NumberOfSections</span>
<span class="n">IF</span> <span class="n">NumberOfSections</span> <span class="o">=</span> <span class="mi">0</span> <span class="n">THEN</span> <span class="n">PRINT</span> <span class="s">"No sections."</span><span class="p">:</span> <span class="n">END</span>
<span class="n">PRINT</span> <span class="s">"NumberOfSections:"</span><span class="err">;</span> <span class="n">NumberOfSections</span>
<span class="n">DIM</span> <span class="n">SHARED</span> <span class="n">secsva</span><span class="p">(</span><span class="mi">0</span> <span class="n">TO</span> <span class="n">NumberOfSections</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="n">AS</span> <span class="n">_UNSIGNED</span> <span class="n">LONG</span>
<span class="n">DIM</span> <span class="n">SHARED</span> <span class="n">secsfp</span><span class="p">(</span><span class="mi">0</span> <span class="n">TO</span> <span class="n">NumberOfSections</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="n">AS</span> <span class="n">_UNSIGNED</span> <span class="n">LONG</span>
<span class="n">GET</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">coff</span> <span class="o">+</span> <span class="mi">16</span><span class="p">,</span> <span class="n">SizeOfOptionalHeader</span>
<span class="n">IF</span> <span class="n">SizeOfOptionalHeader</span> <span class="o">=</span> <span class="mi">0</span> <span class="n">THEN</span> <span class="n">PRINT</span> <span class="s">"No optional header."</span><span class="p">:</span> <span class="n">END</span>
<span class="n">PRINT</span> <span class="s">"SizeOfOptionalHeader:"</span><span class="p">,</span> <span class="n">SPACE</span><span class="err">$</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span><span class="err">;</span> <span class="n">word$</span><span class="p">(</span><span class="n">SizeOfOptionalHeader</span><span class="p">)</span>
<span class="n">GET</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">coff</span> <span class="o">+</span> <span class="mi">20</span><span class="p">,</span> <span class="n">w</span>
<span class="n">SELECT</span> <span class="n">CASE</span> <span class="n">w</span>
    <span class="n">CASE</span> <span class="o">&amp;</span><span class="n">H10B</span><span class="p">:</span> <span class="n">pe32plus</span> <span class="o">=</span> <span class="mi">0</span><span class="p">:</span> <span class="n">PRINT</span> <span class="s">"PE32"</span>
    <span class="n">CASE</span> <span class="o">&amp;</span><span class="n">H20B</span><span class="p">:</span> <span class="n">pe32plus</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span> <span class="n">PRINT</span> <span class="s">"PE32+"</span>
    <span class="n">CASE</span> <span class="n">ELSE</span><span class="p">:</span> <span class="n">PRINT</span> <span class="s">"Unknown Magic."</span><span class="p">:</span> <span class="n">END</span>
<span class="n">END</span> <span class="n">SELECT</span>
<span class="n">GET</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">coff</span> <span class="o">+</span> <span class="mi">20</span> <span class="o">+</span> <span class="mi">28</span> <span class="o">+</span> <span class="p">(</span><span class="o">-</span><span class="mi">4</span> <span class="n">AND</span> <span class="n">pe32plus</span><span class="p">),</span> <span class="n">ImageBase</span>
<span class="n">PRINT</span> <span class="s">"ImageBase:"</span><span class="p">,</span> <span class="s">""</span><span class="p">,</span> <span class="n">dword$</span><span class="p">(</span><span class="n">ImageBase</span><span class="p">)</span>
<span class="n">GET</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">coff</span> <span class="o">+</span> <span class="mi">20</span> <span class="o">+</span> <span class="mi">92</span> <span class="o">+</span> <span class="p">(</span><span class="mi">16</span> <span class="n">AND</span> <span class="n">pe32plus</span><span class="p">),</span> <span class="n">NumberOfRvaAndSizes</span>
<span class="n">IF</span> <span class="n">NumberOfRvaAndSizes</span> <span class="o">&lt;</span> <span class="mi">3</span> <span class="n">THEN</span> <span class="n">PRINT</span> <span class="s">"No resource table."</span><span class="p">:</span> <span class="n">END</span>
<span class="n">PRINT</span> <span class="s">"NumberOfRvaAndSizes:"</span><span class="err">;</span> <span class="n">NumberOfRvaAndSizes</span>
<span class="n">GET</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">coff</span> <span class="o">+</span> <span class="mi">20</span> <span class="o">+</span> <span class="mi">112</span> <span class="o">+</span> <span class="p">(</span><span class="mi">16</span> <span class="n">AND</span> <span class="n">pe32plus</span><span class="p">),</span> <span class="n">rsrc</span>
<span class="n">PRINT</span> <span class="s">"Rva of resource table:"</span><span class="p">,</span> <span class="n">dword$</span><span class="p">(</span><span class="n">rsrc</span><span class="p">)</span>
<span class="n">GET</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">coff</span> <span class="o">+</span> <span class="mi">20</span> <span class="o">+</span> <span class="mi">4</span> <span class="o">+</span> <span class="mi">112</span> <span class="o">+</span> <span class="p">(</span><span class="mi">16</span> <span class="n">AND</span> <span class="n">pe32plus</span><span class="p">),</span> <span class="n">dw</span>
<span class="n">PRINT</span> <span class="s">"Size of resource table:"</span><span class="p">,</span> <span class="n">dword$</span><span class="p">(</span><span class="n">dw</span><span class="p">)</span>
<span class="n">IF</span> <span class="p">(</span><span class="n">rsrc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span> <span class="n">OR</span> <span class="p">(</span><span class="n">dw</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span> <span class="n">THEN</span> <span class="n">PRINT</span> <span class="s">"No resource table."</span><span class="p">:</span> <span class="n">END</span>
<span class="n">SectionTable</span> <span class="o">=</span> <span class="n">coff</span> <span class="o">+</span> <span class="mi">20</span> <span class="o">+</span> <span class="n">SizeOfOptionalHeader</span>
<span class="n">PRINT</span> <span class="s">"section"</span><span class="p">,</span> <span class="s">"va"</span><span class="p">,</span> <span class="s">"file ptr"</span>
<span class="n">FOR</span> <span class="n">w</span> <span class="o">=</span> <span class="mi">0</span> <span class="n">TO</span> <span class="n">NumberOfSections</span> <span class="o">-</span> <span class="mi">1</span>
    <span class="n">GET</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">SectionTable</span> <span class="o">+</span> <span class="p">(</span><span class="mi">40</span> <span class="o">*</span> <span class="n">w</span><span class="p">),</span> <span class="n">nam</span>
    <span class="n">GET</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">SectionTable</span> <span class="o">+</span> <span class="mi">12</span> <span class="o">+</span> <span class="p">(</span><span class="mi">40</span> <span class="o">*</span> <span class="n">w</span><span class="p">),</span> <span class="n">ul</span>
    <span class="n">GET</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">SectionTable</span> <span class="o">+</span> <span class="mi">20</span> <span class="o">+</span> <span class="p">(</span><span class="mi">40</span> <span class="o">*</span> <span class="n">w</span><span class="p">),</span> <span class="n">dw</span>
    <span class="n">PRINT</span> <span class="n">nam</span><span class="p">,</span> <span class="n">dword$</span><span class="p">(</span><span class="n">ul</span><span class="p">),</span> <span class="n">dword$</span><span class="p">(</span><span class="n">dw</span><span class="p">)</span>
    <span class="n">secsva</span><span class="p">(</span><span class="n">w</span><span class="p">)</span> <span class="o">=</span> <span class="n">ul</span>
    <span class="n">secsfp</span><span class="p">(</span><span class="n">w</span><span class="p">)</span> <span class="o">=</span> <span class="n">dw</span>
<span class="n">NEXT</span>
<span class="n">PRINT</span>
<span class="n">PRINT</span> <span class="s">"Proceed? "</span><span class="err">;</span>
<span class="n">DO</span>
    <span class="n">k</span> <span class="o">=</span> <span class="n">LCASE</span><span class="err">$</span><span class="p">(</span><span class="n">INKEY</span><span class="err">$</span><span class="p">)</span>
    <span class="n">IF</span> <span class="n">k</span> <span class="o">=</span> <span class="s">"n"</span> <span class="n">THEN</span> <span class="n">PRINT</span> <span class="n">k</span><span class="p">:</span> <span class="n">END</span>
<span class="n">LOOP</span> <span class="n">UNTIL</span> <span class="n">k</span> <span class="o">=</span> <span class="s">"y"</span>
<span class="n">PRINT</span> <span class="n">k</span>
<span class="n">dw</span> <span class="o">=</span> <span class="n">rva2fp</span><span class="p">(</span><span class="n">rsrc</span><span class="p">)</span>
<span class="n">processtable</span> <span class="n">dw</span><span class="p">,</span> <span class="n">dw</span><span class="p">,</span> <span class="mi">0</span>
<span class="n">SYSTEM</span>

<span class="n">SUB</span> <span class="n">processtable</span> <span class="p">(</span><span class="n">bs</span> <span class="n">AS</span> <span class="n">_UNSIGNED</span> <span class="n">LONG</span><span class="p">,</span> <span class="n">addr</span> <span class="n">AS</span> <span class="n">_UNSIGNED</span> <span class="n">LONG</span><span class="p">,</span> <span class="n">level</span> <span class="n">AS</span> <span class="n">INTEGER</span><span class="p">)</span>
<span class="n">DIM</span> <span class="n">k</span> <span class="n">AS</span> <span class="n">STRING</span>
<span class="n">DIM</span> <span class="n">dw</span> <span class="n">AS</span> <span class="n">_UNSIGNED</span> <span class="n">LONG</span>
<span class="n">DIM</span> <span class="n">numnamest8</span> <span class="n">AS</span> <span class="n">_UNSIGNED</span> <span class="n">LONG</span>
<span class="n">DIM</span> <span class="n">dat</span> <span class="n">AS</span> <span class="n">_UNSIGNED</span> <span class="n">LONG</span>
<span class="n">DIM</span> <span class="n">siz</span> <span class="n">AS</span> <span class="n">_UNSIGNED</span> <span class="n">LONG</span>
<span class="n">DIM</span> <span class="n">so</span> <span class="n">AS</span> <span class="n">LONG</span>
<span class="n">DIM</span> <span class="n">sc</span> <span class="n">AS</span> <span class="n">LONG</span>
<span class="n">DIM</span> <span class="n">numnames</span> <span class="n">AS</span> <span class="n">_UNSIGNED</span> <span class="n">INTEGER</span>
<span class="n">DIM</span> <span class="n">numids</span> <span class="n">AS</span> <span class="n">_UNSIGNED</span> <span class="n">INTEGER</span>
<span class="n">DIM</span> <span class="n">w</span> <span class="n">AS</span> <span class="n">_UNSIGNED</span> <span class="n">INTEGER</span>
<span class="n">DIM</span> <span class="n">ln</span> <span class="n">AS</span> <span class="n">_UNSIGNED</span> <span class="n">INTEGER</span>
<span class="n">DIM</span> <span class="n">x</span> <span class="n">AS</span> <span class="n">_UNSIGNED</span> <span class="n">INTEGER</span>
<span class="n">DIM</span> <span class="n">y</span> <span class="n">AS</span> <span class="n">_UNSIGNED</span> <span class="n">INTEGER</span>
<span class="n">DIM</span> <span class="n">b</span> <span class="n">AS</span> <span class="n">_UNSIGNED</span> <span class="n">_BYTE</span>

<span class="n">GET</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">addr</span> <span class="o">+</span> <span class="mi">12</span><span class="p">,</span> <span class="n">numnames</span>
<span class="n">GET</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">addr</span> <span class="o">+</span> <span class="mi">14</span><span class="p">,</span> <span class="n">numids</span>
<span class="n">DIM</span> <span class="n">nams</span><span class="p">(</span><span class="mi">0</span> <span class="n">TO</span> <span class="n">numnames</span> <span class="o">+</span> <span class="p">(</span><span class="n">numnames</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">))</span> <span class="n">AS</span> <span class="n">STRING</span>
<span class="n">DIM</span> <span class="n">namsrva</span><span class="p">(</span><span class="mi">0</span> <span class="n">TO</span> <span class="n">numnames</span> <span class="o">+</span> <span class="p">(</span><span class="n">numnames</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">))</span> <span class="n">AS</span> <span class="n">_UNSIGNED</span> <span class="n">LONG</span>
<span class="n">DIM</span> <span class="n">ids</span><span class="p">(</span><span class="mi">0</span> <span class="n">TO</span> <span class="n">numids</span> <span class="o">+</span> <span class="p">(</span><span class="n">numids</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">))</span> <span class="n">AS</span> <span class="n">_UNSIGNED</span> <span class="n">LONG</span>
<span class="n">DIM</span> <span class="n">idsrva</span><span class="p">(</span><span class="mi">0</span> <span class="n">TO</span> <span class="n">numids</span> <span class="o">+</span> <span class="p">(</span><span class="n">numids</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">))</span> <span class="n">AS</span> <span class="n">_UNSIGNED</span> <span class="n">LONG</span>

<span class="c1">'get named entries</span>
<span class="n">FOR</span> <span class="n">x</span> <span class="o">=</span> <span class="mi">0</span> <span class="n">TO</span> <span class="n">numnames</span> <span class="o">-</span> <span class="mi">1</span>
    <span class="n">GET</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">addr</span> <span class="o">+</span> <span class="mi">16</span> <span class="o">+</span> <span class="p">(</span><span class="n">x</span> <span class="o">*</span> <span class="mi">8</span><span class="p">),</span> <span class="n">dw</span>
    <span class="c1">'the spec says its an rva, but it seems to be an offset in the section/table</span>
    <span class="c1">'low 31 bits are an offset from bs</span>
    <span class="n">GET</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">bs</span> <span class="o">+</span> <span class="p">(</span><span class="n">dw</span> <span class="n">AND</span> <span class="o">&amp;</span><span class="n">H7FFFFFFF</span><span class="p">),</span> <span class="n">ln</span>
    <span class="n">FOR</span> <span class="n">y</span> <span class="o">=</span> <span class="mi">0</span> <span class="n">TO</span> <span class="n">ln</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="n">GET</span> <span class="mi">1</span><span class="p">,</span> <span class="p">,</span> <span class="n">w</span>
        <span class="n">SELECT</span> <span class="n">CASE</span> <span class="n">w</span>
            <span class="n">CASE</span> <span class="o">&amp;</span><span class="n">H20</span> <span class="n">TO</span> <span class="o">&amp;</span><span class="n">H7E</span><span class="p">:</span> <span class="n">nams</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">=</span> <span class="n">nams</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">+</span> <span class="n">CHR</span><span class="err">$</span><span class="p">(</span><span class="n">w</span><span class="p">)</span>
            <span class="n">CASE</span> <span class="n">ELSE</span><span class="p">:</span> <span class="n">nams</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">=</span> <span class="n">nams</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">+</span> <span class="n">CHR</span><span class="err">$</span><span class="p">(</span><span class="o">&amp;</span><span class="n">H1A</span><span class="p">)</span>
        <span class="n">END</span> <span class="n">SELECT</span>
        <span class="n">IF</span> <span class="n">y</span> <span class="o">=</span> <span class="mi">68</span> <span class="n">THEN</span> <span class="n">EXIT</span> <span class="n">FOR</span>
    <span class="n">NEXT</span>
    <span class="n">GET</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">addr</span> <span class="o">+</span> <span class="mi">16</span> <span class="o">+</span> <span class="mi">4</span> <span class="o">+</span> <span class="p">(</span><span class="n">x</span> <span class="o">*</span> <span class="mi">8</span><span class="p">),</span> <span class="n">namsrva</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="n">NEXT</span>

<span class="c1">'get numbered entries:</span>
<span class="n">numnamest8</span> <span class="o">=</span> <span class="n">numnames</span> <span class="o">*</span> <span class="mi">8</span>
<span class="n">FOR</span> <span class="n">x</span> <span class="o">=</span> <span class="mi">0</span> <span class="n">TO</span> <span class="n">numids</span> <span class="o">-</span> <span class="mi">1</span>
    <span class="n">GET</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">addr</span> <span class="o">+</span> <span class="mi">16</span> <span class="o">+</span> <span class="n">numnamest8</span> <span class="o">+</span> <span class="p">(</span><span class="n">x</span> <span class="o">*</span> <span class="mi">8</span><span class="p">),</span> <span class="n">ids</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">GET</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">addr</span> <span class="o">+</span> <span class="mi">16</span> <span class="o">+</span> <span class="mi">4</span> <span class="o">+</span> <span class="n">numnamest8</span> <span class="o">+</span> <span class="p">(</span><span class="n">x</span> <span class="o">*</span> <span class="mi">8</span><span class="p">),</span> <span class="n">idsrva</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="n">NEXT</span>

<span class="c1">'display:</span>
<span class="n">VIEW</span> <span class="n">PRINT</span>
<span class="n">sc</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">so</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">DO</span>
    <span class="n">CLS</span> <span class="mi">0</span> <span class="c1">'qb64 bug? not locating to 1,1?</span>
    <span class="n">LOCATE</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span>
    <span class="n">SELECT</span> <span class="n">CASE</span> <span class="n">level</span>
        <span class="n">CASE</span> <span class="mi">0</span><span class="p">:</span> <span class="n">PRINT</span> <span class="s">"1st level - Type"</span><span class="err">;</span>
        <span class="n">CASE</span> <span class="mi">1</span><span class="p">:</span> <span class="n">PRINT</span> <span class="s">"2nd level - Name"</span><span class="err">;</span>
        <span class="n">CASE</span> <span class="mi">2</span><span class="p">:</span> <span class="n">PRINT</span> <span class="s">"3rd level - Language"</span><span class="err">;</span>
        <span class="n">CASE</span> <span class="n">ELSE</span><span class="p">:</span> <span class="n">PRINT</span> <span class="n">LTRIM</span><span class="err">$</span><span class="p">(</span><span class="n">STR</span><span class="err">$</span><span class="p">(</span><span class="n">level</span><span class="p">))</span> <span class="o">+</span> <span class="s">"th level"</span><span class="err">;</span>
    <span class="n">END</span> <span class="n">SELECT</span>
    <span class="n">PRINT</span> <span class="s">""</span><span class="p">,</span> <span class="s">"file ptr: "</span><span class="err">;</span> <span class="n">dword$</span><span class="p">(</span><span class="n">addr</span><span class="p">)</span><span class="err">;</span> <span class="s">". Press 'D' to dump."</span>
    <span class="n">PRINT</span> <span class="n">numnames</span><span class="err">;</span> <span class="s">"names in this level, in this branch."</span>
    <span class="n">PRINT</span> <span class="n">numids</span><span class="err">;</span> <span class="s">"IDs in this level, in this branch."</span>
    <span class="n">IF</span> <span class="p">(</span><span class="n">numnames</span> <span class="n">OR</span> <span class="n">numids</span><span class="p">)</span> <span class="o">=</span> <span class="mi">0</span> <span class="n">THEN</span>
        <span class="n">IF</span> <span class="n">level</span> <span class="n">THEN</span>
            <span class="n">PRINT</span> <span class="s">"Press any key to go up one level."</span>
            <span class="n">SLEEP</span><span class="p">:</span> <span class="n">DO</span><span class="p">:</span> <span class="n">LOOP</span> <span class="n">WHILE</span> <span class="n">LEN</span><span class="p">(</span><span class="n">INKEY</span><span class="err">$</span><span class="p">)</span>
            <span class="n">EXIT</span> <span class="n">SUB</span>
        <span class="n">ELSE</span>
            <span class="n">END</span>
        <span class="n">END</span> <span class="n">IF</span>
    <span class="n">END</span> <span class="n">IF</span>
    <span class="n">PRINT</span> <span class="s">"names are unicode. For simplicity, non ASCII chars will be shown as "</span> <span class="o">+</span> <span class="n">CHR</span><span class="err">$</span><span class="p">(</span><span class="o">&amp;</span><span class="n">H1A</span><span class="p">)</span> <span class="o">+</span> <span class="s">"."</span>
    <span class="n">IF</span> <span class="n">level</span> <span class="n">THEN</span>
        <span class="n">PRINT</span> <span class="s">"BKSP or ESC to go up one level."</span>
    <span class="n">ELSE</span>
        <span class="n">PRINT</span> <span class="s">"BKSP or ESC to exit."</span>
    <span class="n">END</span> <span class="n">IF</span>
    <span class="n">PRINT</span> <span class="s">"UP, DOWN, PGUP, PGDN, HOME, END to navigate list."</span>
    <span class="n">PRINT</span> <span class="s">"ENTER to select."</span>
    <span class="n">LOCATE</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">1</span>
    <span class="n">PRINT</span> <span class="n">STRING</span><span class="err">$</span><span class="p">(</span><span class="mi">80</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">HC4</span><span class="p">)</span><span class="err">;</span>
    <span class="n">LOCATE</span> <span class="mi">22</span><span class="p">,</span> <span class="mi">1</span>
    <span class="n">PRINT</span> <span class="n">STRING</span><span class="err">$</span><span class="p">(</span><span class="mi">80</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">HC4</span><span class="p">)</span><span class="err">;</span>
    <span class="n">DO</span>
        <span class="n">COLOR</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">0</span>
        <span class="n">LOCATE</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span> <span class="n">PRINT</span> <span class="n">dword$</span><span class="p">(</span><span class="n">sc</span><span class="p">)</span>
        <span class="n">FOR</span> <span class="n">x</span> <span class="o">=</span> <span class="mi">0</span> <span class="n">TO</span> <span class="mi">11</span>
            <span class="n">LOCATE</span> <span class="mi">10</span> <span class="o">+</span> <span class="n">x</span><span class="p">,</span> <span class="mi">1</span>
            <span class="n">IF</span> <span class="n">x</span> <span class="o">+</span> <span class="n">so</span> <span class="o">=</span> <span class="n">sc</span> <span class="n">THEN</span> <span class="n">COLOR</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">1</span> <span class="n">ELSE</span> <span class="n">COLOR</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">0</span>
            <span class="n">IF</span> <span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="n">so</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">numnames</span> <span class="n">THEN</span>
                <span class="n">PRINT</span> <span class="n">nams</span><span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="n">so</span><span class="p">)</span><span class="err">;</span> <span class="n">SPACE</span><span class="err">$</span><span class="p">(</span><span class="mi">70</span> <span class="o">-</span> <span class="n">LEN</span><span class="p">(</span><span class="n">nams</span><span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="n">so</span><span class="p">)))</span><span class="err">;</span>
                <span class="n">PRINT</span> <span class="n">dword$</span><span class="p">(</span><span class="n">bs</span> <span class="o">+</span> <span class="p">(</span><span class="n">namsrva</span><span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="n">so</span><span class="p">)</span> <span class="n">AND</span> <span class="o">&amp;</span><span class="n">H7FFFFFFF</span><span class="o">&amp;</span><span class="p">))</span><span class="err">;</span>
                <span class="n">COLOR</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">0</span>
                <span class="n">LOCATE</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">18</span>
                <span class="n">IF</span> <span class="n">namsrva</span><span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="n">so</span><span class="p">)</span> <span class="n">AND</span> <span class="o">&amp;</span><span class="n">H80000000</span><span class="err">~</span><span class="o">&amp;</span> <span class="n">THEN</span>
                    <span class="n">PRINT</span> <span class="s">"(descend)"</span><span class="err">;</span>
                <span class="n">ELSE</span>
                    <span class="n">PRINT</span> <span class="s">"(extract)"</span><span class="err">;</span>
                <span class="n">END</span> <span class="n">IF</span>
            <span class="n">ELSEIF</span> <span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="n">so</span><span class="p">)</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">numnames</span> <span class="o">+</span> <span class="n">numids</span><span class="p">)</span> <span class="n">THEN</span>
                <span class="n">PRINT</span> <span class="s">"ID: "</span> <span class="o">+</span> <span class="n">dword$</span><span class="p">(</span><span class="n">ids</span><span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="n">so</span> <span class="o">-</span> <span class="n">numnames</span><span class="p">))</span><span class="err">;</span>
                <span class="n">IF</span> <span class="n">level</span> <span class="o">=</span> <span class="mi">0</span> <span class="n">THEN</span>
                    <span class="n">PRINT</span> <span class="s">" (RT_"</span><span class="err">;</span>
                    <span class="c1">'derived from:</span>
                    <span class="c1">' http://msdn.microsoft.com/en-us/library/ms648009(v=VS.85).aspx</span>
                    <span class="n">SELECT</span> <span class="n">CASE</span> <span class="n">ids</span><span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="n">so</span> <span class="o">-</span> <span class="n">numnames</span><span class="p">)</span>
                        <span class="n">CASE</span> <span class="mi">9</span><span class="p">:</span> <span class="n">PRINT</span> <span class="s">"ACCELERATOR"</span><span class="err">;</span>
                        <span class="n">CASE</span> <span class="mi">21</span><span class="p">:</span> <span class="n">PRINT</span> <span class="s">"ANICURSOR"</span><span class="err">;</span>
                        <span class="n">CASE</span> <span class="mi">22</span><span class="p">:</span> <span class="n">PRINT</span> <span class="s">"ANIICON"</span><span class="err">;</span>
                        <span class="n">CASE</span> <span class="mi">2</span><span class="p">:</span> <span class="n">PRINT</span> <span class="s">"BITMAP"</span><span class="err">;</span>
                        <span class="n">CASE</span> <span class="mi">1</span><span class="p">:</span> <span class="n">PRINT</span> <span class="s">"CURSOR"</span><span class="err">;</span>
                        <span class="n">CASE</span> <span class="mi">5</span><span class="p">:</span> <span class="n">PRINT</span> <span class="s">"DIALOG"</span><span class="err">;</span>
                        <span class="n">CASE</span> <span class="mi">17</span><span class="p">:</span> <span class="n">PRINT</span> <span class="s">"DLGINCLUDE"</span><span class="err">;</span>
                        <span class="n">CASE</span> <span class="mi">8</span><span class="p">:</span> <span class="n">PRINT</span> <span class="s">"FONT"</span><span class="err">;</span>
                        <span class="n">CASE</span> <span class="mi">7</span><span class="p">:</span> <span class="n">PRINT</span> <span class="s">"FONTDIR"</span><span class="err">;</span>
                        <span class="n">CASE</span> <span class="mi">12</span><span class="p">:</span> <span class="n">PRINT</span> <span class="s">"GROUP_CURSOR"</span><span class="err">;</span>
                        <span class="n">CASE</span> <span class="mi">14</span><span class="p">:</span> <span class="n">PRINT</span> <span class="s">"GROUP_ICON"</span><span class="err">;</span>
                        <span class="n">CASE</span> <span class="mi">23</span><span class="p">:</span> <span class="n">PRINT</span> <span class="s">"HTML"</span><span class="err">;</span>
                        <span class="n">CASE</span> <span class="mi">3</span><span class="p">:</span> <span class="n">PRINT</span> <span class="s">"ICON"</span><span class="err">;</span>
                        <span class="n">CASE</span> <span class="mi">24</span><span class="p">:</span> <span class="n">PRINT</span> <span class="s">"MANIFEST"</span><span class="err">;</span>
                        <span class="n">CASE</span> <span class="mi">4</span><span class="p">:</span> <span class="n">PRINT</span> <span class="s">"MENU"</span><span class="err">;</span>
                        <span class="n">CASE</span> <span class="mi">11</span><span class="p">:</span> <span class="n">PRINT</span> <span class="s">"MESSAGETABLE"</span><span class="err">;</span>
                        <span class="n">CASE</span> <span class="mi">19</span><span class="p">:</span> <span class="n">PRINT</span> <span class="s">"PLUGPLAY"</span><span class="err">;</span>
                        <span class="n">CASE</span> <span class="mi">10</span><span class="p">:</span> <span class="n">PRINT</span> <span class="s">"RCDATA"</span><span class="err">;</span>
                        <span class="n">CASE</span> <span class="mi">6</span><span class="p">:</span> <span class="n">PRINT</span> <span class="s">"STRING"</span><span class="err">;</span>
                        <span class="n">CASE</span> <span class="mi">16</span><span class="p">:</span> <span class="n">PRINT</span> <span class="s">"VERSION"</span><span class="err">;</span>
                        <span class="n">CASE</span> <span class="mi">20</span><span class="p">:</span> <span class="n">PRINT</span> <span class="s">"VXD"</span><span class="err">;</span>
                    <span class="n">END</span> <span class="n">SELECT</span>
                    <span class="n">PRINT</span> <span class="s">")"</span><span class="err">;</span>
                <span class="n">END</span> <span class="n">IF</span>
                <span class="n">PRINT</span> <span class="n">SPACE</span><span class="err">$</span><span class="p">(</span><span class="mi">71</span> <span class="o">-</span> <span class="n">POS</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span><span class="err">;</span>
                <span class="n">PRINT</span> <span class="n">dword$</span><span class="p">(</span><span class="n">bs</span> <span class="o">+</span> <span class="p">(</span><span class="n">idsrva</span><span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="n">so</span> <span class="o">-</span> <span class="n">numnames</span><span class="p">)))</span><span class="err">;</span>
                <span class="n">COLOR</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">0</span>
                <span class="n">LOCATE</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">18</span>
                <span class="n">IF</span> <span class="n">idsrva</span><span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="p">(</span><span class="n">so</span> <span class="o">-</span> <span class="n">numnames</span><span class="p">))</span> <span class="n">AND</span> <span class="o">&amp;</span><span class="n">H80000000</span><span class="err">~</span><span class="o">&amp;</span> <span class="n">THEN</span>
                    <span class="n">PRINT</span> <span class="s">"(descend)"</span><span class="err">;</span>
                <span class="n">ELSE</span>
                    <span class="n">PRINT</span> <span class="s">"(extract)"</span><span class="err">;</span>
                <span class="n">END</span> <span class="n">IF</span>
            <span class="n">ELSE</span>
                <span class="n">PRINT</span> <span class="n">SPACE</span><span class="err">$</span><span class="p">(</span><span class="mi">80</span><span class="p">)</span><span class="err">;</span>
            <span class="n">END</span> <span class="n">IF</span>
        <span class="n">NEXT</span>
        <span class="n">DO</span>
            <span class="n">k</span> <span class="o">=</span> <span class="n">INKEY</span><span class="err">$</span>
        <span class="n">LOOP</span> <span class="n">UNTIL</span> <span class="n">LEN</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
        <span class="n">SELECT</span> <span class="n">CASE</span> <span class="n">k</span>
            <span class="n">CASE</span> <span class="s">"d"</span><span class="p">,</span> <span class="s">"D"</span>
                <span class="n">dump</span> <span class="n">addr</span>
                <span class="n">EXIT</span> <span class="n">DO</span>
            <span class="n">CASE</span> <span class="n">MKI</span><span class="err">$</span><span class="p">(</span><span class="o">&amp;</span><span class="n">H4800</span><span class="p">)</span> <span class="c1">'up</span>
                <span class="n">IF</span> <span class="n">sc</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="n">THEN</span>
                    <span class="n">sc</span> <span class="o">=</span> <span class="n">sc</span> <span class="o">-</span> <span class="mi">1</span>
                    <span class="n">IF</span> <span class="n">sc</span> <span class="o">&lt;</span> <span class="n">so</span> <span class="n">THEN</span> <span class="n">so</span> <span class="o">=</span> <span class="n">sc</span>
                <span class="n">END</span> <span class="n">IF</span>
            <span class="n">CASE</span> <span class="n">MKI</span><span class="err">$</span><span class="p">(</span><span class="o">&amp;</span><span class="n">H5000</span><span class="p">)</span> <span class="c1">'down</span>
                <span class="n">IF</span> <span class="n">sc</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">numnames</span> <span class="o">+</span> <span class="n">numids</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="n">THEN</span>
                    <span class="n">sc</span> <span class="o">=</span> <span class="n">sc</span> <span class="o">+</span> <span class="mi">1</span>
                    <span class="n">IF</span> <span class="n">sc</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">so</span> <span class="o">+</span> <span class="mi">11</span><span class="p">)</span> <span class="n">THEN</span>
                        <span class="n">so</span> <span class="o">=</span> <span class="n">sc</span> <span class="o">-</span> <span class="mi">11</span>
                        <span class="n">IF</span> <span class="n">so</span> <span class="o">&gt;</span> <span class="n">sc</span> <span class="n">THEN</span> <span class="n">so</span> <span class="o">=</span> <span class="mi">0</span> <span class="c1">'unsigned</span>
                    <span class="n">END</span> <span class="n">IF</span>
                <span class="n">END</span> <span class="n">IF</span>
            <span class="n">CASE</span> <span class="n">MKI</span><span class="err">$</span><span class="p">(</span><span class="o">&amp;</span><span class="n">H4700</span><span class="p">)</span> <span class="c1">'home</span>
                <span class="n">sc</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">so</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">CASE</span> <span class="n">MKI</span><span class="err">$</span><span class="p">(</span><span class="o">&amp;</span><span class="n">H4F00</span><span class="p">)</span> <span class="c1">'end</span>
                <span class="n">sc</span> <span class="o">=</span> <span class="n">numnames</span> <span class="o">+</span> <span class="n">numids</span> <span class="o">-</span> <span class="mi">1</span>
                <span class="n">so</span> <span class="o">=</span> <span class="n">sc</span> <span class="o">-</span> <span class="mi">11</span>
                <span class="n">IF</span> <span class="n">so</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="n">THEN</span> <span class="n">so</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">CASE</span> <span class="n">MKI</span><span class="err">$</span><span class="p">(</span><span class="o">&amp;</span><span class="n">H4900</span><span class="p">)</span> <span class="c1">'pgup</span>
                <span class="n">sc</span> <span class="o">=</span> <span class="n">sc</span> <span class="o">-</span> <span class="mi">12</span>
                <span class="n">so</span> <span class="o">=</span> <span class="n">so</span> <span class="o">-</span> <span class="mi">12</span>
                <span class="n">IF</span> <span class="n">sc</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="n">THEN</span> <span class="n">sc</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">IF</span> <span class="n">so</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="n">THEN</span> <span class="n">so</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">CASE</span> <span class="n">MKI</span><span class="err">$</span><span class="p">(</span><span class="o">&amp;</span><span class="n">H5100</span><span class="p">)</span> <span class="c1">'pgdn</span>
                <span class="n">sc</span> <span class="o">=</span> <span class="n">sc</span> <span class="o">+</span> <span class="mi">12</span>
                <span class="n">IF</span> <span class="n">sc</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">numnames</span> <span class="o">+</span> <span class="n">numids</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="n">THEN</span> <span class="n">sc</span> <span class="o">=</span> <span class="n">numnames</span> <span class="o">+</span> <span class="n">numids</span> <span class="o">-</span> <span class="mi">1</span>
                <span class="n">so</span> <span class="o">=</span> <span class="n">sc</span> <span class="o">-</span> <span class="mi">11</span>
                <span class="n">IF</span> <span class="n">so</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="n">THEN</span> <span class="n">so</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">CASE</span> <span class="n">CHR</span><span class="err">$</span><span class="p">(</span><span class="o">&amp;</span><span class="n">H8</span><span class="p">),</span> <span class="n">CHR</span><span class="err">$</span><span class="p">(</span><span class="o">&amp;</span><span class="n">H1B</span><span class="p">)</span> <span class="c1">'bksp, esc</span>
                <span class="n">EXIT</span> <span class="n">SUB</span>
            <span class="n">CASE</span> <span class="n">CHR</span><span class="err">$</span><span class="p">(</span><span class="o">&amp;</span><span class="n">HD</span><span class="p">)</span> <span class="c1">'enter</span>
                <span class="n">IF</span> <span class="n">sc</span> <span class="o">&lt;</span> <span class="n">numnames</span> <span class="n">THEN</span>
                    <span class="n">dw</span> <span class="o">=</span> <span class="n">namsrva</span><span class="p">(</span><span class="n">sc</span><span class="p">)</span>
                <span class="n">ELSE</span>
                    <span class="n">dw</span> <span class="o">=</span> <span class="n">idsrva</span><span class="p">(</span><span class="n">sc</span> <span class="o">-</span> <span class="n">numnames</span><span class="p">)</span>
                <span class="n">END</span> <span class="n">IF</span>
                <span class="n">IF</span> <span class="n">dw</span> <span class="n">AND</span> <span class="o">&amp;</span><span class="n">H80000000</span><span class="err">~</span><span class="o">&amp;</span> <span class="n">THEN</span>
                    <span class="c1">'the spec says its an rva, but it seems to be an offset in the section/table</span>
                    <span class="n">processtable</span> <span class="n">bs</span><span class="p">,</span> <span class="n">bs</span> <span class="o">+</span> <span class="p">(</span><span class="n">dw</span> <span class="n">AND</span> <span class="o">&amp;</span><span class="n">H7FFFFFFF</span><span class="o">&amp;</span><span class="p">),</span> <span class="n">level</span> <span class="o">+</span> <span class="mi">1</span>
                    <span class="n">EXIT</span> <span class="n">DO</span>
                <span class="n">ELSE</span>
                    <span class="c1">'the spec says its an rva, but it seems to be an offset in the section/table</span>
                    <span class="n">dw</span> <span class="o">=</span> <span class="n">bs</span> <span class="o">+</span> <span class="n">dw</span>
                    <span class="n">GET</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">dw</span><span class="p">,</span> <span class="n">dat</span>
                    <span class="n">GET</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="o">+</span> <span class="mi">4</span> <span class="o">+</span> <span class="n">dw</span><span class="p">,</span> <span class="n">siz</span>
                    <span class="n">CLS</span>
                    <span class="n">LOCATE</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="c1">'qb64 seems to default to line 2</span>
                    <span class="n">SEEK</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">rva2fp</span><span class="p">(</span><span class="n">dat</span><span class="p">)</span>
                    <span class="n">FOR</span> <span class="n">dw</span> <span class="o">=</span> <span class="mi">1</span> <span class="n">TO</span> <span class="n">siz</span>
                        <span class="n">IF</span> <span class="n">dw</span> <span class="o">&gt;</span> <span class="mi">400</span> <span class="n">THEN</span> <span class="n">EXIT</span> <span class="n">FOR</span>
                        <span class="n">GET</span> <span class="mi">1</span><span class="p">,</span> <span class="p">,</span> <span class="n">b</span>
                        <span class="n">SELECT</span> <span class="n">CASE</span> <span class="n">b</span>
                            <span class="n">CASE</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">9</span> <span class="n">TO</span> <span class="o">&amp;</span><span class="n">HD</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">H1F</span><span class="p">:</span> <span class="n">PRINT</span> <span class="s">"."</span><span class="err">;</span>
                            <span class="n">CASE</span> <span class="n">ELSE</span><span class="p">:</span> <span class="n">PRINT</span> <span class="n">CHR</span><span class="err">$</span><span class="p">(</span><span class="n">b</span><span class="p">)</span><span class="err">;</span>
                        <span class="n">END</span> <span class="n">SELECT</span>
                    <span class="n">NEXT</span>
                    <span class="n">LOCATE</span> <span class="mi">24</span><span class="p">,</span> <span class="mi">1</span>
                    <span class="n">PRINT</span> <span class="n">dword$</span><span class="p">(</span><span class="n">siz</span><span class="p">)</span> <span class="o">+</span> <span class="s">" bytes."</span><span class="err">;</span>
                    <span class="n">LOCATE</span> <span class="mi">23</span><span class="p">,</span> <span class="mi">1</span>
                    <span class="n">LINE</span> <span class="n">INPUT</span> <span class="s">"(leave blank to cancel) Output file? "</span><span class="err">;</span> <span class="n">k</span>
                    <span class="n">IF</span> <span class="n">LEN</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="n">THEN</span>
                        <span class="n">IF</span> <span class="n">_FILEEXISTS</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="n">THEN</span>
                            <span class="n">PRINT</span>
                            <span class="n">PRINT</span> <span class="s">"File already exists."</span><span class="err">;</span>
                        <span class="n">ELSE</span>
                            <span class="n">OPEN</span> <span class="n">k</span> <span class="n">FOR</span> <span class="n">BINARY</span> <span class="n">AS</span> <span class="mi">2</span>
                            <span class="n">SEEK</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">rva2fp</span><span class="p">(</span><span class="n">dat</span><span class="p">)</span>
                            <span class="n">FOR</span> <span class="n">dw</span> <span class="o">=</span> <span class="mi">1</span> <span class="n">TO</span> <span class="n">siz</span>
                                <span class="n">GET</span> <span class="mi">1</span><span class="p">,</span> <span class="p">,</span> <span class="n">b</span>
                                <span class="n">PUT</span> <span class="mi">2</span><span class="p">,</span> <span class="p">,</span> <span class="n">b</span>
                            <span class="n">NEXT</span>
                            <span class="n">CLOSE</span> <span class="mi">2</span>
                            <span class="n">PRINT</span>
                            <span class="n">PRINT</span> <span class="s">"Done."</span><span class="err">;</span>
                        <span class="n">END</span> <span class="n">IF</span>
                        <span class="n">SLEEP</span><span class="p">:</span> <span class="n">DO</span><span class="p">:</span> <span class="n">LOOP</span> <span class="n">WHILE</span> <span class="n">LEN</span><span class="p">(</span><span class="n">INKEY</span><span class="err">$</span><span class="p">)</span>
                    <span class="n">END</span> <span class="n">IF</span>
                    <span class="n">EXIT</span> <span class="n">DO</span>
                <span class="n">END</span> <span class="n">IF</span>
        <span class="n">END</span> <span class="n">SELECT</span>
    <span class="n">LOOP</span>
<span class="n">LOOP</span>
<span class="n">END</span> <span class="n">SUB</span>

<span class="n">FUNCTION</span> <span class="n">word$</span> <span class="p">(</span><span class="n">w</span> <span class="n">AS</span> <span class="n">_UNSIGNED</span> <span class="n">INTEGER</span><span class="p">)</span>
<span class="n">DIM</span> <span class="n">t</span> <span class="n">AS</span> <span class="n">STRING</span>
<span class="n">t</span> <span class="o">=</span> <span class="n">LCASE</span><span class="err">$</span><span class="p">(</span><span class="n">HEX</span><span class="err">$</span><span class="p">(</span><span class="n">w</span><span class="p">))</span>
<span class="n">word</span> <span class="o">=</span> <span class="s">"0x"</span> <span class="o">+</span> <span class="n">STRING</span><span class="err">$</span><span class="p">(</span><span class="mi">4</span> <span class="o">-</span> <span class="n">LEN</span><span class="p">(</span><span class="n">t</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">H30</span><span class="p">)</span> <span class="o">+</span> <span class="n">t</span>
<span class="n">END</span> <span class="n">FUNCTION</span>

<span class="n">FUNCTION</span> <span class="n">dword$</span> <span class="p">(</span><span class="n">dw</span> <span class="n">AS</span> <span class="n">_UNSIGNED</span> <span class="n">LONG</span><span class="p">)</span>
<span class="n">DIM</span> <span class="n">t</span> <span class="n">AS</span> <span class="n">STRING</span>
<span class="n">t</span> <span class="o">=</span> <span class="n">LCASE</span><span class="err">$</span><span class="p">(</span><span class="n">HEX</span><span class="err">$</span><span class="p">(</span><span class="n">dw</span><span class="p">))</span>
<span class="n">dword</span> <span class="o">=</span> <span class="s">"0x"</span> <span class="o">+</span> <span class="n">STRING</span><span class="err">$</span><span class="p">(</span><span class="mi">8</span> <span class="o">-</span> <span class="n">LEN</span><span class="p">(</span><span class="n">t</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">H30</span><span class="p">)</span> <span class="o">+</span> <span class="n">t</span>
<span class="n">END</span> <span class="n">FUNCTION</span>

<span class="n">FUNCTION</span> <span class="n">rva2fp</span><span class="err">~</span><span class="o">&amp;</span> <span class="p">(</span><span class="n">rva</span> <span class="n">AS</span> <span class="n">_UNSIGNED</span> <span class="n">LONG</span><span class="p">)</span>
<span class="n">DIM</span> <span class="n">w</span> <span class="n">AS</span> <span class="n">_UNSIGNED</span> <span class="n">INTEGER</span>
<span class="n">FOR</span> <span class="n">w</span> <span class="o">=</span> <span class="mi">0</span> <span class="n">TO</span> <span class="n">NumberOfSections</span> <span class="o">-</span> <span class="mi">1</span>
    <span class="n">IF</span> <span class="n">rva</span> <span class="o">&lt;</span> <span class="n">secsva</span><span class="p">(</span><span class="n">w</span><span class="p">)</span> <span class="n">THEN</span> <span class="n">EXIT</span> <span class="n">FOR</span>
<span class="n">NEXT</span>
<span class="n">w</span> <span class="o">=</span> <span class="n">w</span> <span class="o">-</span> <span class="mi">1</span>
<span class="n">IF</span> <span class="n">w</span> <span class="o">&gt;</span> <span class="n">NumberOfSections</span> <span class="o">-</span> <span class="mi">1</span> <span class="n">THEN</span> <span class="n">PRINT</span> <span class="n">dword$</span><span class="p">(</span><span class="n">rva</span><span class="p">),</span> <span class="n">w</span><span class="p">:</span> <span class="n">SLEEP</span>
<span class="n">rva2fp</span> <span class="o">=</span> <span class="n">rva</span> <span class="o">+</span> <span class="p">(</span><span class="n">secsfp</span><span class="p">(</span><span class="n">w</span><span class="p">)</span> <span class="o">-</span> <span class="n">secsva</span><span class="p">(</span><span class="n">w</span><span class="p">))</span>
<span class="n">END</span> <span class="n">FUNCTION</span>

<span class="n">SUB</span> <span class="n">dump</span> <span class="p">(</span><span class="n">addr</span> <span class="n">AS</span> <span class="n">_UNSIGNED</span> <span class="n">LONG</span><span class="p">)</span>
<span class="n">DIM</span> <span class="n">t</span> <span class="n">AS</span> <span class="n">STRING</span>
<span class="n">DIM</span> <span class="n">dw</span> <span class="n">AS</span> <span class="n">_UNSIGNED</span> <span class="n">LONG</span>
<span class="n">DIM</span> <span class="n">ul</span> <span class="n">AS</span> <span class="n">_UNSIGNED</span> <span class="n">LONG</span>
<span class="n">DIM</span> <span class="n">b</span> <span class="n">AS</span> <span class="n">_UNSIGNED</span> <span class="n">_BYTE</span>

<span class="n">_CONTROLCHR</span> <span class="n">OFF</span>
<span class="n">VIEW</span> <span class="n">PRINT</span>
<span class="n">ul</span> <span class="o">=</span> <span class="n">addr</span>
<span class="n">DO</span>
    <span class="n">COLOR</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">0</span>
    <span class="n">CLS</span> <span class="mi">0</span>
    <span class="n">SEEK</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">ul</span>
    <span class="n">FOR</span> <span class="n">dw</span> <span class="o">=</span> <span class="n">ul</span> <span class="n">TO</span> <span class="p">(</span><span class="n">ul</span> <span class="n">AND</span> <span class="o">&amp;</span><span class="n">HFFFFFFF0</span><span class="p">)</span> <span class="o">+</span> <span class="o">&amp;</span><span class="n">H15F</span>
        <span class="n">IF</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">ul</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">LOF</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="n">THEN</span> <span class="n">EXIT</span> <span class="n">FOR</span>
        <span class="n">GET</span> <span class="mi">1</span><span class="p">,</span> <span class="p">,</span> <span class="n">b</span>
        <span class="n">IF</span> <span class="p">(</span><span class="n">dw</span> <span class="n">AND</span> <span class="o">&amp;</span><span class="n">HF</span><span class="p">)</span> <span class="o">=</span> <span class="mi">0</span> <span class="n">THEN</span>
            <span class="n">t</span> <span class="o">=</span> <span class="n">LCASE</span><span class="err">$</span><span class="p">(</span><span class="n">HEX</span><span class="err">$</span><span class="p">(</span><span class="n">dw</span><span class="p">))</span>
            <span class="n">COLOR</span> <span class="mi">7</span>
            <span class="n">PRINT</span> <span class="n">STRING</span><span class="err">$</span><span class="p">(</span><span class="mi">8</span> <span class="o">-</span> <span class="n">LEN</span><span class="p">(</span><span class="n">t</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">H30</span><span class="p">)</span> <span class="o">+</span> <span class="n">t</span><span class="err">;</span> <span class="n">SPACE</span><span class="err">$</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="err">;</span>
        <span class="n">END</span> <span class="n">IF</span>
        <span class="n">IF</span> <span class="p">(</span><span class="n">dw</span> <span class="n">AND</span> <span class="o">&amp;</span><span class="n">H4</span><span class="p">)</span> <span class="n">THEN</span> <span class="n">COLOR</span> <span class="mi">3</span> <span class="n">ELSE</span> <span class="n">COLOR</span> <span class="mi">2</span>
        <span class="n">LOCATE</span> <span class="p">,</span> <span class="mi">14</span> <span class="o">+</span> <span class="p">((</span><span class="n">dw</span> <span class="n">AND</span> <span class="o">&amp;</span><span class="n">HF</span><span class="p">)</span> <span class="o">*</span> <span class="mi">3</span><span class="p">)</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">LCASE</span><span class="err">$</span><span class="p">(</span><span class="n">HEX</span><span class="err">$</span><span class="p">(</span><span class="n">b</span><span class="p">))</span>
        <span class="n">IF</span> <span class="n">b</span> <span class="o">&lt;</span> <span class="o">&amp;</span><span class="n">H10</span> <span class="n">THEN</span> <span class="n">PRINT</span> <span class="s">"0"</span> <span class="o">+</span> <span class="n">t</span><span class="err">;</span> <span class="n">ELSE</span> <span class="n">PRINT</span> <span class="n">t</span><span class="err">;</span>
        <span class="n">LOCATE</span> <span class="p">,</span> <span class="mi">65</span> <span class="o">+</span> <span class="p">(</span><span class="n">dw</span> <span class="n">AND</span> <span class="o">&amp;</span><span class="n">HF</span><span class="p">)</span>
        <span class="n">PRINT</span> <span class="n">CHR</span><span class="err">$</span><span class="p">(</span><span class="n">b</span><span class="p">)</span><span class="err">;</span>
    <span class="n">NEXT</span>
    <span class="n">PRINT</span>
    <span class="n">COLOR</span> <span class="mi">7</span>
    <span class="n">LINE</span> <span class="n">INPUT</span> <span class="s">"(leave blank to cancel) Address: 0x"</span><span class="err">;</span> <span class="n">t</span>
    <span class="n">IF</span> <span class="n">LTRIM</span><span class="err">$</span><span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="o">=</span> <span class="s">""</span> <span class="n">THEN</span> <span class="n">EXIT</span> <span class="n">DO</span>
    <span class="n">ul</span> <span class="o">=</span> <span class="n">VAL</span><span class="p">(</span><span class="s">"&amp;h"</span> <span class="o">+</span> <span class="n">t</span> <span class="o">+</span> <span class="s">"&amp;"</span><span class="p">)</span> <span class="n">AND</span> <span class="o">&amp;</span><span class="n">H7FFFFFFF</span>
<span class="n">LOOP</span>
<span class="n">END</span> <span class="n">SUB</span> 

</code></pre></div></div>
<p><sub>Code courtesy of Michael Calkins</sub></p>

<h2 id="see-also">See Also</h2>

<ul>
  <li><a href="Icons-and-Cursors.html">Icons and Cursors</a></li>
  <li><a href="Bitmaps.html">Bitmaps</a>, <a href="_ICON.html">_ICON</a>, <a href="%24EXEICON.html">$EXEICON</a></li>
  <li><a href="SaveIcon32.html">SaveIcon32</a> (create icons from any image)</li>
</ul>

      </section>
    </div>

    <!-- FOOTER  -->
    <div id="footer_wrap" class="outer">
      <footer class="inner">
        
        <p class="copyright">QB64.com maintained by <a href="https://github.com/DualBrain">Cory Smith</a> on <a href="https://github.com/DualBrain/QB64">GitHub</a>.</p>
        
        <p>Published with <a href="https://pages.github.com/">GitHub Pages</a></p>
      </footer>
    </div>
  </body>

<!-- Mirrored from qb64.com/wiki/Resource-Table-extraction.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 07 Nov 2024 13:50:55 GMT -->
</html>